# Development Dockerfile
FROM node:18-alpine AS base

# Install build dependencies
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    linux-headers \
    udev \
    git \
    bash

# Set working directory
WORKDIR /app

# Create app user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# Copy package files
COPY package*.json ./
COPY pnpm-lock.yaml ./

# Install all dependencies (including dev)
RUN npm ci

# Copy source code
COPY . .

# Install development tools globally
RUN npm install -g \
    nodemon \
    @typescript-eslint/eslint-plugin \
    @typescript-eslint/parser \
    typescript \
    vite

# Create necessary directories
RUN mkdir -p /app/config /app/logs && \
    chown -R nextjs:nodejs /app

# Switch to non-root user
USER nextjs

# Expose ports
EXPOSE 1420 9229 3001

# Development entrypoint
CMD ["npm", "run", "dev"]