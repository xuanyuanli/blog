一直用 Claude Code 写代码，效果不错，但成本不便宜。我的诉求很简单：在需要“火力全开”时用昂贵模型（比如 Claude 最新大模型），日常改个脚本、写点工具时切到更省钱的 `qwen-coder` 或 `glm-4.5`。问题在于，每次切换都要手动改一堆环境变量，来回折腾既麻烦又容易出错。

于是我干脆做了个小工具，负责“一键切换供应商”。目标很明确：
- 能添加、编辑、删除多个供应商配置
- 能一键切换并写入环境变量（持久化）
- 菜单式交互，傻瓜可用
- 切完后直接打开 Claude Code，新会话立刻生效

最终落地的是一个 Windows 批处理脚本（`.cmd`）。我把思路、脚本、用法都写在下面，能用就行、简单直接。

<!-- more -->

链接在这：
- 脚本地址：https://github.com/xuanyuanli/blog/blob/main/docs/.vuepress/public/scripts/cc-provider-manage.cmd

如果你也有同样的需求，直接拿走即可。

## 背景与痛点

手动切换的痛点主要有三点：
- 环境变量繁琐：`ANTHROPIC_BASE_URL`、`ANTHROPIC_AUTH_TOKEN`、`ANTHROPIC_MODEL`、`ANTHROPIC_SMALL_FAST_MODEL` 常常要一起改。
- 容易出错：漏改一个，就开始奇怪报错；改完忘记开新会话，变量没生效。
- 成本意识：该省就省，日常开发没必要一直烧最高配。

## 实现思路

用最稳妥、最通用的方式：Windows 批处理脚本 + 简单文本配置。

- 交互菜单：启动脚本后，先显示“当前使用的供应商”，再给出菜单选项。
- 配置持久化：把每个供应商的 `name/base_url/token/model/small_fast_model` 保存到一个文本文件里，可读可改。
- 写入环境变量：通过 `setx` 写入当前用户环境变量（必要时也可以换成 `setx /M` 写系统级，需管理员权限）。
- 新会话立即生效：切换完成后用 `start` 开一个新窗口运行 Claude Code（或你常用的编辑器/终端），保证新进程拿到最新变量。

核心只有一件事：把“切换供应商”这件事从“记忆和手改”变成“选择和确认”。

## 脚本能力一览

脚本启动后提供这些操作：
- 添加新的供应商（填写 `ANTHROPIC_BASE_URL`、`ANTHROPIC_AUTH_TOKEN`，可选 `ANTHROPIC_MODEL`、`ANTHROPIC_SMALL_FAST_MODEL`）
- 在不同供应商之间一键切换
- 编辑现有供应商配置（改 base_url、token 或模型名）
- 删除不用的供应商
- 在新窗口打开 Claude Code（或你指定的工具），立刻使用新的环境变量

提示词当时是这样写给 Claude Code 的（备忘）：
```text
帮我创建一个Windows批处理脚本，用于管理Claude Code的API供应商配置。脚本需要能够：
  1. 添加新的API供应商（ANTHROPIC_BASE_URL、ANTHROPIC_AUTH_TOKEN、可选的ANTHROPIC_MODEL和ANTHROPIC_SMALL_FAST_MODEL环境变量）
  2. 在不同供应商之间切换
  3. 编辑现有供应商配置
  4. 删除供应商配置
  5. 在新窗口打开Claude Code
  6. 退出

  头部显示当前使用的供应商。脚本要有交互式菜单界面，支持配置持久化保存到文件，并且能够设置系统环境变量。
```

## 使用方式

1. 下载脚本 `cc-provider-manage.cmd`，放到一个固定位置（比如工具目录）。
2. 双击运行，或在 `cmd` 里执行。
3. 首次使用先“添加供应商”：
   - `ANTHROPIC_BASE_URL`：供应商的兼容接口地址（按你的代理/平台文档填写）
   - `ANTHROPIC_AUTH_TOKEN`：对应的密钥
   - `ANTHROPIC_MODEL`：默认大模型（可选）
   - `ANTHROPIC_SMALL_FAST_MODEL`：默认小而快的模型（可选）
4. 切换供应商：在列表里选一个，脚本会自动用 `setx` 写入环境变量。
5. 需要马上生效：选择“在新窗口打开 Claude Code”（脚本会 `start` 一个新会话，你也可以改成 `start code .` 或打开你常用的终端）。

小提醒：`setx` 写入的是持久化环境变量，生效于“新开的进程”。如果你是在老终端里运行脚本，切换后请新开一个窗口使用。

## 变量说明

- `ANTHROPIC_BASE_URL`：兼容接口地址（不同平台不完全一致，按文档填写）。
- `ANTHROPIC_AUTH_TOKEN`：鉴权令牌。注意保密，不要提交到仓库。
- `ANTHROPIC_MODEL`：主力模型名，比如 `claude-3.7` 或 `qwen2.5-coder-7b-instruct`。
- `ANTHROPIC_SMALL_FAST_MODEL`：小而快的模型，用于轻量任务。

## 核心片段（示意）

下面是脚本里的关键操作，简化成示意代码，便于理解：

```bat
:: 写入用户环境变量（持久化）
setx ANTHROPIC_BASE_URL "%PROVIDER_BASE_URL%" >nul
setx ANTHROPIC_AUTH_TOKEN "%PROVIDER_TOKEN%" >nul
if not "%PROVIDER_MODEL%"=="" setx ANTHROPIC_MODEL "%PROVIDER_MODEL%" >nul
if not "%PROVIDER_FAST_MODEL%"=="" setx ANTHROPIC_SMALL_FAST_MODEL "%PROVIDER_FAST_MODEL%" >nul

:: 也可以按需写系统级（需管理员）
:: setx /M ANTHROPIC_BASE_URL "%PROVIDER_BASE_URL%"

:: 新窗口使用最新变量（按需替换为你习惯的启动命令）
start "Claude Code" cmd /k "title CC - %PROVIDER_NAME% && echo Switched to %PROVIDER_NAME% && echo."
```

注意 `setx` 的特性：
- 会话内的 `set` 只是临时生效；`setx` 会把值写入注册表，供新进程读取。
- `setx` 对特殊字符比较敏感，令牌里如果有 `&`、`^` 建议加引号；脚本里已做处理。

## 常见问题

- 切换后没生效？请确认是在“新开的窗口”里使用。老窗口里仍是旧变量。
- 需要系统级变量？把 `setx` 改成 `setx /M`，并用管理员权限运行。
- 供应商 Base URL 怎么填？按你的代理/平台文档来，有的带路径前缀，有的纯域名。
- 安全问题？配置文件只保存在你本机，记得不要把它提交到仓库；多人共享机器时注意权限。

## 后续小改进

- 增加导入/导出功能，方便在多台机器同步。
- 可选支持仅“当前会话切换”（只 `set`，不写 `setx`）。
- 做个 PowerShell 版本，或者一份跨平台的 `bash` 版本。

就这样，一个小脚本把“切换供应商”这件事变得顺手起来。省钱、省心，还稳定。

**祝你变得更强!**
