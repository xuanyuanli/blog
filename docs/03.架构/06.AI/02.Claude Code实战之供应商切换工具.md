---
title: Claude Code实战之供应商切换工具
date: 2025-08-18 21:19:14
permalink: /pages/3d1e08/
categories:
  - 架构
  - AI
tags:
  - 
author: 
  name: 轩辕李
  link: https://github.com/xuanyuanli
---
有一次，我想把“写个小脚本”这种轻活切到便宜模型。`ANTHROPIC_BASE_URL` 改了，`ANTHROPIC_AUTH_TOKEN` 换了，偏偏漏了 `ANTHROPIC_SMALL_FAST_MODEL`。Claude Code 报错、会话不生效，我在几个终端窗口里来回重启，半小时就这么被吃掉了。

那一刻我意识到：切换供应商，不该靠记忆力。

于是做了个小工具，把“选择供应商 → 写入环境变量 → 打开新会话”串成一道工序，让事实替你干活。需要“火力全开”时选昂贵模型（如 Claude 最新大模型），日常改脚本就切到省钱选项（如 `qwen-coder`、`glm-4.5`）。

<!-- more -->

链接：
- 脚本地址：https://github.com/xuanyuanli/blog/blob/main/docs/.vuepress/public/scripts/cc-provider-manage.cmd

如果你也在不同供应商间切换，这就是一个能立刻省时间、少踩坑的小开关。

## 它解决了什么

- 减少易错环节：一次要改 4 个变量（`BASE_URL`、`TOKEN`、主模型、小模型），漏一个就踩雷。
- 明确“切换即生效”：写入持久化变量后，自动开启新会话，确保新进程拿到最新环境。
- 让成本可控：重活用强模，小活用快模/省钱模，切换不再成为负担。

## 它怎么做（机制）

选择了最稳定也最通用的方案：Windows 批处理脚本 + 文本配置。

- 交互菜单：先显示“当前供应商”，再给出操作选项。
- 配置持久化：每个供应商保存 `name/base_url/token/model/small_fast_model` 到可读可改的文本文件。
- 环境变量写入：用 `setx` 写当前用户变量（需要系统级时可改为 `setx /M`，需管理员权限）。
- 新会话生效：切换后用 `start` 打开新窗口（Claude Code/VS Code/终端均可），新进程自然读取到最新变量。

本质上，是把“记忆与手改”替换为“选择与确认”。

## 能力一览

- 添加供应商（填 `ANTHROPIC_BASE_URL`、`ANTHROPIC_AUTH_TOKEN`，可选 `ANTHROPIC_MODEL`、`ANTHROPIC_SMALL_FAST_MODEL`）
- 一键在供应商间切换
- 编辑既有配置（改 base_url、token 或模型名）
- 删除不用的配置
- 打开新窗口立即使用新变量（Claude Code 或你指定的工具）

## 使用方法

1. 下载 `cc-provider-manage.cmd` 到你的工具目录。
2. 双击运行，或在 `cmd` 里执行。
3. 首次使用先“添加供应商”：
   - `ANTHROPIC_BASE_URL`：供应商的兼容接口地址（按代理/平台文档填写）
   - `ANTHROPIC_AUTH_TOKEN`：对应密钥
   - `ANTHROPIC_MODEL`：默认主力模型（可选）
   - `ANTHROPIC_SMALL_FAST_MODEL`：默认小而快的模型（可选）
4. 切换供应商：在列表里选一个，脚本会用 `setx` 写入环境变量。
5. 让配置马上生效：选择“在新窗口打开 Claude Code”（也可改成 `start code .` 或你常用的终端）。

小提醒：`setx` 写的是“持久化变量”，对“新开的进程”生效；在老终端里运行完，请新开一个窗口使用。

## 变量说明

- `ANTHROPIC_BASE_URL`：兼容接口地址（各平台可能不同）。
- `ANTHROPIC_AUTH_TOKEN`：鉴权令牌。注意保密，不要提交到仓库。
- `ANTHROPIC_MODEL`：主力模型名，如 `claude-3.7`、`qwen2.5-coder-7b-instruct`。
- `ANTHROPIC_SMALL_FAST_MODEL`：小而快的模型，用于轻量任务。

## 核心片段（示意）

```bat
:: 写入用户环境变量（持久化）
setx ANTHROPIC_BASE_URL "%PROVIDER_BASE_URL%" >nul
setx ANTHROPIC_AUTH_TOKEN "%PROVIDER_TOKEN%" >nul
if not "%PROVIDER_MODEL%"=="" setx ANTHROPIC_MODEL "%PROVIDER_MODEL%" >nul
if not "%PROVIDER_FAST_MODEL%"=="" setx ANTHROPIC_SMALL_FAST_MODEL "%PROVIDER_FAST_MODEL%" >nul

:: 也可以按需写系统级（需管理员）
:: setx /M ANTHROPIC_BASE_URL "%PROVIDER_BASE_URL%"

:: 新窗口使用最新变量（按需替换为你习惯的启动命令）
start "Claude Code" cmd /k "title CC - %PROVIDER_NAME% && echo Switched to %PROVIDER_NAME% && echo."
```

关于 `setx` 的两个要点：
- 会话内的 `set` 只是临时；`setx` 会把值写入注册表，供新进程读取。
- 令牌里如果有 `&`、`^` 等特殊字符，建议加引号；脚本里已做处理。

## 你可能会问

- 切换后没生效？请在“新开的窗口”里使用。老窗口仍是旧变量。
- 想要系统级变量？把 `setx` 改成 `setx /M`，并用管理员权限运行。
- Base URL 怎么填？按代理/平台文档来，有的带路径前缀，有的纯域名。
- 安全问题？配置文件只在本机，别提交到仓库；多人共享机器时注意权限。

## 后续改进（路线）

- 导入/导出配置，方便多机同步。
- 支持仅“当前会话切换”（只 `set`，不写 `setx`）。
- 提供 PowerShell 版，或跨平台 bash 版。

把“切换供应商”交给脚本，精力回到手头任务上。省心、省钱，也更稳。
