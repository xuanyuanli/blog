---
title: JavaåŸºå‡†æµ‹è¯•ï¼ˆJMHï¼‰
date: 2023-04-05 22:38:23
permalink: /pages/e9882e/
categories: 
  - åç«¯
  - Javaæ ¸å¿ƒ
tags: 
  - JMH
  - åŸºå‡†æµ‹è¯•
author: 
  name: è½©è¾•æ
  link: https://github.com/xuanyuanli
---

## ä¸€ã€å¼•è¨€

### 1ã€ä¸ºä»€ä¹ˆè¿›è¡ŒåŸºå‡†æµ‹è¯•

åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªç¯èŠ‚ã€‚ä¸ºäº†ç¡®ä¿ä»£ç çš„æ€§èƒ½è¾¾åˆ°é¢„æœŸï¼Œå¼€å‘äººå‘˜éœ€è¦å¯¹ä¸åŒçš„ç®—æ³•ã€æ•°æ®ç»“æ„ä»¥åŠç³»ç»Ÿé…ç½®è¿›è¡Œæ¯”è¾ƒã€‚

åŸºå‡†æµ‹è¯•æ˜¯ä¸€ç§è¡¡é‡ç¨‹åºæ€§èƒ½çš„æ–¹æ³•ï¼Œé€šè¿‡å¯¹ä»£ç æ‰§è¡Œæ—¶é—´ã€ååé‡ç­‰æŒ‡æ ‡çš„æµ‹é‡ï¼Œå¯ä»¥ä¸ºå¼€å‘äººå‘˜æä¾›æœ‰å…³ä»£ç æ€§èƒ½çš„å¯é æ•°æ®ã€‚

å¾®åŸºå‡†æµ‹è¯•çš„åº”ç”¨åœºæ™¯ï¼š
- **ç®—æ³•é€‰æ‹©**ï¼šæ¯”è¾ƒä¸åŒæ’åºç®—æ³•ã€æœç´¢ç®—æ³•çš„æ€§èƒ½å·®å¼‚
- **æ•°æ®ç»“æ„å¯¹æ¯”**ï¼šè¯„ä¼° `ArrayList` vs `LinkedList`ã€`HashMap` vs `TreeMap` çš„æ€§èƒ½
- **æ¡†æ¶é€‰å‹**ï¼šå¯¹æ¯”ä¸åŒJSONè§£æåº“ã€åºåˆ—åŒ–æ¡†æ¶çš„å¤„ç†é€Ÿåº¦
- **ä»£ç ä¼˜åŒ–éªŒè¯**ï¼šéªŒè¯æ€§èƒ½ä¼˜åŒ–æªæ–½æ˜¯å¦çœŸæ­£æœ‰æ•ˆ
- **JVMå‚æ•°è°ƒä¼˜**ï¼šæµ‹è¯•ä¸åŒJVMå‚æ•°å¯¹æ€§èƒ½çš„å½±å“

<!-- more -->

### 2ã€ä»€ä¹ˆæ˜¯JMH

JMHï¼ˆJava Microbenchmark Harnessï¼‰æ˜¯ä¸€ä¸ªç”±OpenJDKå›¢é˜Ÿå¼€å‘çš„ä¸“é—¨ç”¨äºç¼–å†™ã€è¿è¡Œå’Œåˆ†æJavaå¾®åŸºå‡†æµ‹è¯•çš„å·¥å…·ã€‚

å®ƒæä¾›äº†ä¸€å¥—ç®€å•æ˜“ç”¨çš„APIå’Œæ³¨è§£ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜å¯¹Javaä»£ç è¿›è¡Œæ€§èƒ½è¯„ä¼°ã€‚

JMHçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š
- **æ¶ˆé™¤JVMä¼˜åŒ–å¹²æ‰°**ï¼šè‡ªåŠ¨å¤„ç†JITç¼–è¯‘ã€æ­»ä»£ç æ¶ˆé™¤ç­‰ä¼˜åŒ–å¸¦æ¥çš„æµ‹é‡åå·®
- **ç»Ÿè®¡å­¦æ”¯æŒ**ï¼šæä¾›æ ‡å‡†å·®ã€ç½®ä¿¡åŒºé—´ç­‰ç»Ÿè®¡æ•°æ®ï¼Œç¡®ä¿ç»“æœå¯é 
- **å¤šç§æµ‹è¯•æ¨¡å¼**ï¼šæ”¯æŒååé‡ã€å¹³å‡æ—¶é—´ã€é‡‡æ ·ç­‰å¤šç§æµ‹é‡ç»´åº¦
- **å¹¶å‘æµ‹è¯•æ”¯æŒ**ï¼šå†…ç½®å¤šçº¿ç¨‹æµ‹è¯•èƒ½åŠ›ï¼Œæ¨¡æ‹ŸçœŸå®å¹¶å‘åœºæ™¯
- **å®˜æ–¹ç»´æŠ¤**ï¼šç”±OpenJDKå›¢é˜Ÿç»´æŠ¤ï¼Œä¸JVMå‘å±•åŒæ­¥

## äºŒã€JMHåŸºæœ¬æ¦‚å¿µ

### 1ã€åŸºå‡†æµ‹è¯•æ–¹æ³•

åŸºå‡†æµ‹è¯•æ–¹æ³•æ˜¯JMHç”¨äºè¡¡é‡æ€§èƒ½çš„æ ¸å¿ƒä»£ç ã€‚é€šå¸¸ï¼Œä¸€ä¸ªåŸºå‡†æµ‹è¯•æ–¹æ³•åº”è¯¥åªåŒ…å«è¦è¯„ä¼°æ€§èƒ½çš„ä»£ç ç‰‡æ®µï¼Œä»¥ä¾¿æ›´å‡†ç¡®åœ°æµ‹é‡æ‰§è¡Œæ—¶é—´ã€‚

åŸºå‡†æµ‹è¯•æ–¹æ³•çš„ç‰¹ç‚¹ï¼š
- ä½¿ç”¨ `@Benchmark` æ³¨è§£æ ‡è®°
- å¯ä»¥æœ‰å‚æ•°ï¼ˆé€šè¿‡ `@State` æ³¨å…¥ï¼‰
- å¯ä»¥æœ‰è¿”å›å€¼ï¼ˆè¿”å›å€¼ä¼šè¢«æ¶ˆè´¹ï¼Œé¿å…æ­»ä»£ç æ¶ˆé™¤ï¼‰
- åº”è¯¥å°½é‡ç®€æ´ï¼ŒåªåŒ…å«è¢«æµ‹è¯•çš„æ ¸å¿ƒé€»è¾‘

### 2ã€åŸºå‡†æµ‹è¯•æ¨¡å¼

JMHæä¾›äº†å‡ ç§åŸºå‡†æµ‹è¯•æ¨¡å¼ï¼Œç”¨äºè¡¡é‡ä¸åŒçš„æ€§èƒ½æŒ‡æ ‡ï¼š

- **Throughput**ï¼šååé‡æ¨¡å¼ï¼Œæµ‹é‡å•ä½æ—¶é—´å†…çš„æ“ä½œæ¬¡æ•°ï¼ˆops/timeï¼‰
  - é€‚ç”¨åœºæ™¯ï¼šæ‰¹å¤„ç†ä»»åŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†
  - è¾“å‡ºç¤ºä¾‹ï¼š`200000 ops/s`
  
- **AverageTime**ï¼šå¹³å‡æ—¶é—´æ¨¡å¼ï¼Œæµ‹é‡æ¯ä¸ªæ“ä½œçš„å¹³å‡æ‰§è¡Œæ—¶é—´
  - é€‚ç”¨åœºæ™¯ï¼šAPIå“åº”æ—¶é—´ã€æ•°æ®åº“æŸ¥è¯¢
  - è¾“å‡ºç¤ºä¾‹ï¼š`5.2 ms/op`
  
- **SampleTime**ï¼šé‡‡æ ·æ—¶é—´æ¨¡å¼ï¼Œéšæœºé‡‡æ ·æ“ä½œçš„æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
  - é€‚ç”¨åœºæ™¯ï¼šéœ€è¦äº†è§£æ€§èƒ½åˆ†å¸ƒã€æ‰¾å‡ºå¼‚å¸¸å€¼
  - è¾“å‡ºç¤ºä¾‹ï¼š`p0.50: 1.2ms, p0.99: 5.3ms, p0.999: 12.1ms`
  
- **SingleShotTime**ï¼šå•æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œæµ‹é‡å†·å¯åŠ¨æ€§èƒ½
  - é€‚ç”¨åœºæ™¯ï¼šå¯åŠ¨æ€§èƒ½æµ‹è¯•ã€é¦–æ¬¡åŠ è½½æµ‹è¯•
  - è¾“å‡ºç¤ºä¾‹ï¼š`100 ms/op`
  
- **All**ï¼šè¿è¡Œæ‰€æœ‰æ¨¡å¼ï¼Œè·å–å…¨é¢çš„æ€§èƒ½æ•°æ®

### 3ã€Warm-upï¼ˆé¢„çƒ­ï¼‰

JVMåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå¯¹ä»£ç è¿›è¡Œå³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ä¼˜åŒ–ã€‚ä¸ºäº†é¿å…JITå¯¹åŸºå‡†æµ‹è¯•ç»“æœçš„å½±å“ï¼ŒJMHæä¾›äº†é¢„çƒ­ï¼ˆWarm-upï¼‰æœºåˆ¶ã€‚

é¢„çƒ­çš„é‡è¦æ€§ï¼š
- **JITç¼–è¯‘ä¼˜åŒ–**ï¼šè®©çƒ­ç‚¹ä»£ç å®ŒæˆC1ã€C2ç¼–è¯‘ä¼˜åŒ–
- **ç±»åŠ è½½å®Œæˆ**ï¼šç¡®ä¿æ‰€æœ‰éœ€è¦çš„ç±»å·²ç»åŠ è½½
- **å†…å­˜åˆ†é…ç¨³å®š**ï¼šè®©JVMå†…å­˜åˆ†é…è¾¾åˆ°ç¨³å®šçŠ¶æ€
- **ç¼“å­˜é¢„çƒ­**ï¼šCPUç¼“å­˜ã€åˆ†æ”¯é¢„æµ‹å™¨ç­‰ç¡¬ä»¶ä¼˜åŒ–ç”Ÿæ•ˆ

é¢„çƒ­å‚æ•°é…ç½®ï¼š
```java
@Warmup(iterations = 3, time = 1, timeUnit = TimeUnit.SECONDS)
// iterations: é¢„çƒ­è½®æ•°
// time: æ¯è½®é¢„çƒ­æ—¶é—´
// timeUnit: æ—¶é—´å•ä½
```

### 4ã€æµ‹é‡å•ä½

JMHæ”¯æŒå¤šç§æ—¶é—´å•ä½ï¼Œé€‰æ‹©åˆé€‚çš„å•ä½å¯ä»¥è®©ç»“æœæ›´æ˜“è¯»ï¼š

| æ—¶é—´å•ä½ | ç¼©å†™ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| `NANOSECONDS` | ns | CPUæŒ‡ä»¤çº§æ“ä½œã€å†…å­˜è®¿é—® |
| `MICROSECONDS` | Î¼s | ç®€å•ç®—æ³•ã€é›†åˆæ“ä½œ |
| `MILLISECONDS` | ms | å¤æ‚ç®—æ³•ã€IOæ“ä½œ |
| `SECONDS` | s | æ‰¹å¤„ç†ã€ç½‘ç»œè¯·æ±‚ |

é€‰æ‹©åŸåˆ™ï¼šè®©ç»“æœæ•°å€¼åœ¨1-1000ä¹‹é—´ï¼Œä¾¿äºé˜…è¯»å’Œæ¯”è¾ƒã€‚

### 5ã€å¹¶å‘æ§åˆ¶

JMHå…è®¸é€šè¿‡è®¾ç½®çº¿ç¨‹æ•°ã€è°ƒç”¨çº¿ç¨‹ç»„ç­‰æ–¹å¼å¯¹åŸºå‡†æµ‹è¯•çš„å¹¶å‘æ€§è¿›è¡Œæ§åˆ¶ï¼š

- **`@Threads`**ï¼šæŒ‡å®šå¹¶å‘çº¿ç¨‹æ•°
  ```java
  @Threads(4)  // ä½¿ç”¨4ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ
  @Threads(Threads.MAX)  // ä½¿ç”¨CPUæ ¸å¿ƒæ•°
  ```

- **`@Group` å’Œ `@GroupThreads`**ï¼šçº¿ç¨‹ç»„æ§åˆ¶
  ```java
  @Group("readWrite")
  @GroupThreads(3)
  @Benchmark
  public void read() { }
  
  @Group("readWrite") 
  @GroupThreads(1)
  @Benchmark
  public void write() { }
  ```

è¿™å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è¯„ä¼°ä»£ç åœ¨ä¸åŒå¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚

## ä¸‰ã€JMHç¯å¢ƒæ­å»º

### 1ã€ç”ŸæˆJMHé¡¹ç›®

æ ¹æ®[å®˜ç½‘](https://github.com/openjdk/jmh)æ­¥éª¤ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤ç”Ÿæˆç¤ºä¾‹é¡¹ç›®ï¼š

åœ¨`pom.xml`æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–ï¼š

```shell
mvn archetype:generate \
        -DinteractiveMode=false \
        -DarchetypeGroupId=org.openjdk.jmh \
        -DarchetypeArtifactId=jmh-java-benchmark-archetype \
        -DgroupId=org.sample \
        -DartifactId=jmh-demo \
        -Dversion=1.0
```

### 2ã€é…ç½®JMHæ’ä»¶
ç”Ÿæˆçš„é¡¹ç›®ï¼Œpom.xmlä¸­é…ç½®å¦‚ä¸‹ï¼š
```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>org.sample</groupId>
  <artifactId>test</artifactId>
  <version>1.0</version>
  <packaging>jar</packaging>

  <name>Auto-generated JMH benchmark</name>

  <prerequisites>
    <maven>3.0</maven>
  </prerequisites>

  <dependencies>
    <dependency>
      <groupId>org.openjdk.jmh</groupId>
      <artifactId>jmh-core</artifactId>
      <version>${jmh.version}</version>
    </dependency>
    <dependency>
      <groupId>org.openjdk.jmh</groupId>
      <artifactId>jmh-generator-annprocess</artifactId>
      <version>${jmh.version}</version>
      <scope>provided</scope>
    </dependency>
  </dependencies>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <jmh.version>1.36</jmh.version>
    <javac.target>11</javac.target>
    <uberjar.name>benchmarks</uberjar.name>
  </properties>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.1</version>
        <configuration>
          <compilerVersion>${javac.target}</compilerVersion>
          <source>${javac.target}</source>
          <target>${javac.target}</target>
        </configuration>
      </plugin>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <version>2.2</version>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
            <configuration>
              <finalName>${uberjar.name}</finalName>
              <transformers>
                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                  <mainClass>org.openjdk.jmh.Main</mainClass>
                </transformer>
              </transformers>
              <filters>
                <filter>
                  <!--
                      Shading signed JARs will fail without this.
                      http://stackoverflow.com/questions/999489/invalid-signature-file-when-attempting-to-run-a-jar
                  -->
                  <artifact>*:*</artifact>
                  <excludes>
                    <exclude>META-INF/*.SF</exclude>
                    <exclude>META-INF/*.DSA</exclude>
                    <exclude>META-INF/*.RSA</exclude>
                  </excludes>
                </filter>
              </filters>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
```
Maven Shadeæ’ä»¶ç”¨äºæ‰“åŒ…å¯æ‰§è¡ŒJARæ–‡ä»¶ã€‚  
è¿™é‡Œå°†JMHè¿è¡Œæ—¶åº“å’Œæµ‹è¯•ç±»æ‰“åŒ…åˆ°åŒä¸€ä¸ªJARæ–‡ä»¶ä¸­ã€‚  
- goalsæŒ‡å®šäº†Shadeæ’ä»¶æ‰§è¡Œçš„ç›®æ ‡ï¼Œè¿™é‡Œæ˜¯shadeã€‚
- finalNameæŒ‡å®šäº†ç”Ÿæˆçš„JARæ–‡ä»¶åç§°ã€‚
- transformersæŒ‡å®šäº†Shadeæ’ä»¶çš„è½¬æ¢å™¨ï¼Œè¿™é‡Œä½¿ç”¨äº†ManifestResourceTransformerï¼Œå°†JMHçš„Mainç±»è®¾ç½®ä¸ºå¯æ‰§è¡ŒJARæ–‡ä»¶çš„ä¸»ç±»ã€‚
- filtersæŒ‡å®šäº†Shadeæ’ä»¶çš„è¿‡æ»¤å™¨ï¼Œç”¨äºè¿‡æ»¤æ‰JARæ–‡ä»¶ä¸­çš„ç­¾åæ–‡ä»¶ã€‚è¿™æ˜¯ä¸ºäº†è§£å†³åœ¨å°†å·²ç­¾åçš„JARæ–‡ä»¶æ‰“åŒ…åˆ°Shade JARæ–‡ä»¶ä¸­æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚

### 3ã€ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç 

ç¤ºä¾‹é¡¹ç›®ä¸­æœ‰MyBenchmarkç±»ï¼Œæˆ‘ä»¬æ¥è¡¥å……ä¸€ä¸‹ï¼š
```java
import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.infra.Blackhole;
import java.util.concurrent.TimeUnit;
import java.util.Random;

@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
@Warmup(iterations = 3, time = 1, timeUnit = TimeUnit.SECONDS)
@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)
@Fork(1)
public class MyBenchmark {

    @Param({"100", "200", "300"})
    private int length;

    private int[] array;

    @Setup
    public void setUp() {
        array = new int[length];
        Random random = new Random();
        for (int i = 0; i < length; i++) {
            array[i] = random.nextInt();
        }
    }

    @Benchmark
    public void testBubbleSort(Blackhole bh) {
        int[] sortedArray = bubbleSort(array.clone());
        bh.consume(sortedArray);
    }

    @Benchmark
    public void testQuickSort(Blackhole bh) {
        int[] sortedArray = quickSort(array.clone(), 0, array.length - 1);
        bh.consume(sortedArray);
    }

    public int[] bubbleSort(int[] array) {
        int n = array.length;
        boolean swapped;
        for (int i = 0; i < n - 1; i++) {
            swapped = false;
            for (int j = 0; j < n - 1 - i; j++) {
                if (array[j] > array[j + 1]) {
                    int temp = array[j];
                    array[j] = array[j + 1];
                    array[j + 1] = temp;
                    swapped = true;
                }
            }
            if (!swapped) {
                break;
            }
        }
        return array;
    }

    public int[] quickSort(int[] array, int low, int high) {
        if (low < high) {
            int pivotIndex = partition(array, low, high);
            quickSort(array, low, pivotIndex - 1);
            quickSort(array, pivotIndex + 1, high);
        }
        return array;
    }

    private int partition(int[] array, int low, int high) {
        int pivot = array[high];
        int i = low - 1;
        for (int j = low; j < high; j++) {
            if (array[j] <= pivot) {
                i++;
                int temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
        }
        int temp = array[i + 1];
        array[i + 1] = array[high];
        array[high] = temp;
        return i + 1;
    }

    @TearDown
    public void tearDown() {
        array = null;
    }
}
```

### 4ã€è¿è¡ŒåŸºå‡†æµ‹è¯•

åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š

```sh
mvn clean verify
java -jar target/benchmarks.jar
```

è¿˜å¯ä»¥å…è®¸`java -jar target/benchmarks.jar -h`æ¥æŸ¥çœ‹å¸®åŠ©ã€‚

## å››ã€JMHæ³¨è§£è¯¦è§£

### 1ã€@Benchmark

`@Benchmark`æ³¨è§£ç”¨äºæ ‡è®°åŸºå‡†æµ‹è¯•æ–¹æ³•ã€‚JMHä¼šè‡ªåŠ¨æ‰«æå¹¶æ‰§è¡Œæ‰€æœ‰å¸¦æœ‰æ­¤æ³¨è§£çš„æ–¹æ³•ã€‚

### 2ã€@Fork

`@Fork`æ³¨è§£ç”¨äºæŒ‡å®šåŸºå‡†æµ‹è¯•çš„è¿›ç¨‹æ•°ã€‚æ¯ä¸ªè¿›ç¨‹å°†ç‹¬ç«‹è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥å‡å°JVMå‚æ•°å’Œåƒåœ¾å›æ”¶å¯¹æµ‹è¯•ç»“æœçš„å½±å“ã€‚é»˜è®¤å€¼ä¸º1ã€‚

### 3ã€@Warmup

`@Warmup`æ³¨è§£ç”¨äºè®¾ç½®é¢„çƒ­å‚æ•°ã€‚å¯ä»¥æŒ‡å®šé¢„çƒ­çš„è¿­ä»£æ¬¡æ•°ï¼ˆiterationsï¼‰å’Œæ¯æ¬¡è¿­ä»£çš„æ—¶é—´ï¼ˆtimeï¼‰ã€‚

### 4ã€@Measurement

`@Measurement`æ³¨è§£ç”¨äºè®¾ç½®æ­£å¼æµ‹é‡çš„å‚æ•°ã€‚å¯ä»¥æŒ‡å®šæ­£å¼æµ‹é‡çš„è¿­ä»£æ¬¡æ•°ï¼ˆiterationsï¼‰å’Œæ¯æ¬¡è¿­ä»£çš„æ—¶é—´ï¼ˆtimeï¼‰ã€‚

### 5ã€@BenchmarkMode

`@BenchmarkMode`æ³¨è§£ç”¨äºè®¾ç½®åŸºå‡†æµ‹è¯•æ¨¡å¼ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ã€‚

JMHæä¾›äº†å¤šç§åŸºå‡†æ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½æœ‰ä¸åŒçš„æµ‹è¯•ç­–ç•¥å’Œè¾“å‡ºæ ¼å¼ã€‚ä»¥ä¸‹æ˜¯JMHæ”¯æŒçš„åŸºå‡†æ¨¡å¼ï¼š
1. `Throughput`ï¼šæµ‹è¯•æ–¹æ³•çš„ååé‡ï¼Œå³æ¯ç§’æ‰§è¡Œçš„æ“ä½œæ¬¡æ•°ã€‚
2. `AverageTime`ï¼šæµ‹è¯•æ–¹æ³•çš„å¹³å‡æ‰§è¡Œæ—¶é—´ã€‚
3. `SampleTime`ï¼šæµ‹è¯•æ–¹æ³•çš„éšæœºå–æ ·æ—¶é—´ï¼Œå³å¯¹æ–¹æ³•è¿›è¡Œå¤šæ¬¡æ‰§è¡Œï¼Œå¹¶å¯¹æ‰§è¡Œæ—¶é—´è¿›è¡Œé‡‡æ ·ã€‚
4. `SingleShotTime`ï¼šæµ‹è¯•æ–¹æ³•çš„å•æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œå³åªæ‰§è¡Œä¸€æ¬¡æ–¹æ³•ï¼Œå¹¶æµ‹é‡æ‰§è¡Œæ—¶é—´ã€‚
5. `All`ï¼šåŒæ—¶è¿è¡Œæ‰€æœ‰çš„åŸºå‡†æ¨¡å¼ï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°å•ä¸ªæ–‡ä»¶ä¸­ã€‚

### 6ã€@OutputTimeUnit

`@OutputTimeUnit`æ³¨è§£ç”¨äºæŒ‡å®šåŸºå‡†æµ‹è¯•ç»“æœçš„æ—¶é—´å•ä½ã€‚æ”¯æŒçš„å•ä½åŒ…æ‹¬çº³ç§’ï¼ˆNANOSECONDSï¼‰ã€å¾®ç§’ï¼ˆMICROSECONDSï¼‰ã€æ¯«ç§’ï¼ˆMILLISECONDSï¼‰å’Œç§’ï¼ˆSECONDSï¼‰ã€‚

### 7ã€@State
`State` ç”¨äºå£°æ˜æŸä¸ªç±»æ˜¯ä¸€ä¸ªâ€çŠ¶æ€â€ï¼Œç„¶åæ¥å—ä¸€ä¸ª `Scope` å‚æ•°ç”¨æ¥è¡¨ç¤ºè¯¥çŠ¶æ€çš„å…±äº«èŒƒå›´ã€‚ 

å› ä¸ºå¾ˆå¤š benchmark ä¼šéœ€è¦ä¸€äº›è¡¨ç¤ºçŠ¶æ€çš„ç±»ï¼ŒJMH å…è®¸ä½ æŠŠè¿™äº›ç±»ä»¥ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ³¨å…¥åˆ° benchmark å‡½æ•°é‡Œã€‚

æ”¯æŒçš„èŒƒå›´åŒ…æ‹¬ï¼š
- `Benchmark` æ‰€æœ‰çº¿ç¨‹å…±äº«
- `Group` åŒä¸€ç»„ç°åœºå…±äº«
- `Thread` æ¯ä¸ªçº¿ç¨‹ç‹¬äº«

å¯ä»¥å°†æ­¤æ³¨è§£åº”ç”¨äºåŒ…å«å…±äº«èµ„æºçš„ç±»ä¸Šã€‚

### 8ã€@Param

`@Param`æ³¨è§£ç”¨äºä¸ºåŸºå‡†æµ‹è¯•æ–¹æ³•æä¾›è¾“å…¥å‚æ•°ã€‚å¯ä»¥å°†æ­¤æ³¨è§£åº”ç”¨äºå…±äº«èµ„æºç±»çš„å­—æ®µä¸Šï¼Œç„¶ååœ¨åŸºå‡†æµ‹è¯•æ–¹æ³•ä¸­ä½¿ç”¨è¿™äº›å­—æ®µã€‚

### 9ã€@Setup

`@Setup`æ³¨è§£ç”¨äºæ ‡è®°èµ„æºåˆå§‹åŒ–æ–¹æ³•ã€‚æ­¤æ–¹æ³•å°†åœ¨åŸºå‡†æµ‹è¯•å¼€å§‹ä¹‹å‰æ‰§è¡Œã€‚

### 10ã€@TearDown

`@TearDown`æ³¨è§£ç”¨äºæ ‡è®°èµ„æºé‡Šæ”¾æ–¹æ³•ã€‚æ­¤æ–¹æ³•å°†åœ¨åŸºå‡†æµ‹è¯•ç»“æŸåæ‰§è¡Œã€‚

### 11ã€@Threads
`@Threads` ç”¨äºæŒ‡å®šæµ‹è¯•æ–¹æ³•è¿è¡Œçš„çº¿ç¨‹æ•°ã€‚JMHå¯ä»¥é€šè¿‡å¤šçº¿ç¨‹å¹¶å‘åœ°è¿è¡Œæµ‹è¯•æ–¹æ³•æ¥æ¨¡æ‹Ÿå®é™…åº”ç”¨ç¨‹åºä¸­çš„å¹¶å‘åœºæ™¯ã€‚

æœ‰äº›æ³¨è§£ç†è§£èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œå¯ä»¥å‚è€ƒï¼š[å®˜æ–¹ç¤ºä¾‹](https://hg.openjdk.org/code-tools/jmh/file/f481bc602a57/jmh-samples/src/main/java/org/openjdk/jmh/samples/)

## äº”ã€JMHé«˜çº§åŠŸèƒ½

### 1ã€ä½¿ç”¨Profileråˆ†ææ€§èƒ½ç“¶é¢ˆ

JMHæ”¯æŒä½¿ç”¨Profilerå¯¹åŸºå‡†æµ‹è¯•è¿›è¡Œæ€§èƒ½åˆ†æã€‚å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°`-prof`æŒ‡å®šè¦ä½¿ç”¨çš„Profilerï¼Œä¾‹å¦‚ï¼š

```sh
java -jar target/benchmarks.jar -prof comp -prof cl
```

å…³äºå¯ç”¨çš„Profilerï¼Œå¯ä»¥ä½¿ç”¨`java -jar target/benchmarks.jar -lprof`æŸ¥çœ‹ã€‚

ä»¥Java 11ä¸ºä¾‹ï¼Œå¯ç”¨çš„Profileræœ‰ï¼š
- `cl`ï¼šè¡¨ç¤ºå¯ç”¨Classloaderåˆ†æå™¨ï¼Œç”¨äºåˆ†æç±»åŠ è½½è¡Œä¸ºã€‚
- `comp`ï¼šè¡¨ç¤ºå¯ç”¨JITç¼–è¯‘å™¨åˆ†æå™¨ï¼Œç”¨äºåˆ†æç¼–è¯‘å™¨è¡Œä¸ºã€‚
- `gc`ï¼šè¡¨ç¤ºå¯ç”¨åƒåœ¾å›æ”¶åˆ†æå™¨ï¼Œç”¨äºåˆ†æGCè¡Œä¸ºã€‚
- `jfr`ï¼šè¡¨ç¤ºå¯ç”¨Java Flight Recorderåˆ†æå™¨ï¼Œç”¨äºè®°å½•åº”ç”¨ç¨‹åºçš„è¿è¡Œæƒ…å†µå’Œäº‹ä»¶ã€‚
- `pauses`ï¼šè¡¨ç¤ºå¯ç”¨æš‚åœåˆ†æå™¨ï¼Œç”¨äºåˆ†æåº”ç”¨ç¨‹åºä¸­çš„æš‚åœæƒ…å†µã€‚
- `perfc2c`ï¼šè¡¨ç¤ºå¯ç”¨Linux perf c2cåˆ†æå™¨ï¼Œç”¨äºåˆ†æCPUç¼“å­˜è¡Œçš„ä½¿ç”¨æƒ…å†µã€‚
- `safepoints`ï¼šè¡¨ç¤ºå¯ç”¨å®‰å…¨ç‚¹åˆ†æå™¨ï¼Œç”¨äºåˆ†æåº”ç”¨ç¨‹åºä¸­çš„å®‰å…¨ç‚¹æƒ…å†µã€‚
- `stack`ï¼šè¡¨ç¤ºå¯ç”¨å †æ ˆè·Ÿè¸ªåˆ†æå™¨ï¼Œç”¨äºåˆ†æåº”ç”¨ç¨‹åºä¸­çš„å‡½æ•°è°ƒç”¨å’Œè¿”å›æƒ…å†µã€‚

### 2ã€è‡ªå®šä¹‰Benchmarkè¿è¡Œå™¨

é€šè¿‡`org.openjdk.jmh.runner.Runner`ç±»ï¼Œå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„åŸºå‡†æµ‹è¯•è¿è¡Œå™¨ã€‚è¿™å¯ä»¥ç”¨äºåœ¨è¿è¡ŒåŸºå‡†æµ‹è¯•æ—¶è‡ªå®šä¹‰JMHçš„è¡Œä¸ºã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨`Options`ç±»è‡ªå®šä¹‰Benchmarkè¿è¡Œå™¨ï¼š

```java
import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.runner.Runner;
import org.openjdk.jmh.runner.options.Options;
import org.openjdk.jmh.runner.options.OptionsBuilder;
import org.openjdk.jmh.runner.options.TimeValue;

@State(Scope.Benchmark)
public class MyBenchmark {

    @Benchmark
    public void testMethod() {
        // Your benchmark method here
    }

    public static void main(String[] args) throws Exception {
        Options options = new OptionsBuilder()
                .include(MyBenchmark.class.getSimpleName())
                .warmupTime(TimeValue.seconds(1))
                .measurementTime(TimeValue.seconds(5))
                .forks(1)
                .build();

        new Runner(options).run();
    }
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º`MyBenchmark`çš„ç±»ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º`testMethod`çš„åŸºå‡†æ–¹æ³•ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨`main`æ–¹æ³•ä¸­ä½¿ç”¨`OptionsBuilder`ç±»åˆ›å»ºä¸€ä¸ª`Options`å¯¹è±¡ï¼Œç”¨äºæŒ‡å®šBenchmarkè¿è¡Œçš„å‚æ•°å’Œé€‰é¡¹ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è®¾ç½®äº†ä¸€äº›å¸¸ç”¨çš„é€‰é¡¹ï¼š
- `include`æ–¹æ³•ï¼šæŒ‡å®šè¦è¿è¡Œçš„Benchmarkç±»ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`MyBenchmark.class.getSimpleName()`è·å–ç±»çš„ç®€å•åç§°ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™`include`æ–¹æ³•ã€‚
- `warmupTime`æ–¹æ³•ï¼šæŒ‡å®šBenchmarkçš„é¢„çƒ­æ—¶é—´ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`TimeValue.seconds(1)`æŒ‡å®šé¢„çƒ­æ—¶é—´ä¸º1ç§’ã€‚
- `measurementTime`æ–¹æ³•ï¼šæŒ‡å®šBenchmarkçš„æµ‹é‡æ—¶é—´ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`TimeValue.seconds(5)`æŒ‡å®šæµ‹é‡æ—¶é—´ä¸º5ç§’ã€‚
- `forks`æ–¹æ³•ï¼šæŒ‡å®šè¦è¿è¡ŒBenchmarkçš„æ¬¡æ•°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`forks(1)`æŒ‡å®šåªè¿è¡Œä¸€æ¬¡ã€‚

æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨`Runner`ç±»è¿è¡ŒBenchmarkï¼Œå¹¶å°†ä¸Šé¢åˆ›å»ºçš„`Options`å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚è¿™å°†å¯åŠ¨Benchmarkè¿è¡Œå™¨ï¼Œå¹¶è¿è¡ŒæŒ‡å®šçš„Benchmarkç±»ã€‚

å¦‚æœä½ æ‰§è¡ŒRunnerçš„æ—¶å€™æŠ¥é”™ï¼š
- `ERROR: transport error 202: connect failed: Connection refused` ä½ éœ€è¦æ£€æŸ¥hostsæ–‡ä»¶ï¼Œè®©`127.0.0.1`å’Œ`localhost`å¯¹åº”

### 3ã€ç»“æœå¯¼å‡ºä¸æŠ¥å‘Šç”Ÿæˆ

JMHå…è®¸å°†åŸºå‡†æµ‹è¯•ç»“æœå¯¼å‡ºä¸ºJSONã€CSVå’ŒXMLæ ¼å¼ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°`-lrf`æŸ¥çœ‹æ”¯æŒçš„è¾“å‡ºæ ¼å¼ã€‚å¯ä»¥é€šè¿‡`-rf`å’Œ`-rff`è®¾ç½®è¾“å‡ºæ ¼å¼å’Œæ–‡ä»¶åã€‚

æ¯”å¦‚ï¼š`java -jar target/benchmarks.jar -rf json -rff result.json`

æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·[JMH Visualizer](https://jmh.morethan.io/)å°†å¯¼å‡ºçš„ç»“æœè½¬æ¢ä¸ºå›¾å½¢æŠ¥å‘Šã€‚

![image](https://cdn.jsdelivr.net/gh/xuanyuanli/Img@master/picx/image.6s5lp9up4rw0.png)

### 4ã€IDEAçš„JMHæ’ä»¶
ä¸Šé¢çš„æ­¥éª¤è¿˜æ˜¯ç•¥æ˜¾éº»çƒ¦ï¼Œåœ¨IDEAä¸­å®‰è£…[JMH Java Microbenchmark Harness](https://plugins.jetbrains.com/plugin/7529-jmh-java-microbenchmark-harness)æ’ä»¶å¯ä»¥æé«˜JMHæµ‹è¯•çš„æ•ˆç‡ã€‚  

![screenshot_d07532df-46b5-4fc6-a963-0864bdd84876](https://cdn.jsdelivr.net/gh/xuanyuanli/Img@master/picx/screenshot_d07532df-46b5-4fc6-a963-0864bdd84876.1jfs7dphwgcg.gif)

### 5ã€å¾®åŸºå‡†æµ‹è¯•ç­–ç•¥

åœ¨ç¼–å†™å¾®åŸºå‡†æµ‹è¯•æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- ç¡®ä¿åŸºå‡†æµ‹è¯•æ–¹æ³•è¶³å¤Ÿç®€å•ï¼ŒåªåŒ…å«è¦æµ‹é‡æ€§èƒ½çš„ä»£ç ç‰‡æ®µã€‚
- ä½¿ç”¨åˆé€‚çš„é¢„çƒ­ç­–ç•¥ï¼Œä»¥å‡å°JITä¼˜åŒ–å¯¹æµ‹è¯•ç»“æœçš„å½±å“ã€‚
- é€‰æ‹©åˆé€‚çš„æµ‹è¯•æ¨¡å¼ã€æ—¶é—´å•ä½å’Œå¹¶å‘æ§åˆ¶å‚æ•°ã€‚

## å…­ã€JMHå®è·µæ¡ˆä¾‹

### 1ã€å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½å¯¹æ¯”

å¯¹æ¯”ä¸åŒå­—ç¬¦ä¸²æ‹¼æ¥æ–¹å¼çš„æ€§èƒ½å·®å¼‚ï¼š

```java
@State(Scope.Thread)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
@Warmup(iterations = 3, time = 1)
@Measurement(iterations = 5, time = 1)
@Fork(1)
public class StringConcatBenchmark {
    
    @Param({"10", "100", "1000"})
    private int iterations;
    
    @Benchmark
    public String testStringBuilder() {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < iterations; i++) {
            sb.append("string").append(i);
        }
        return sb.toString();
    }
    
    @Benchmark
    public String testStringBuffer() {
        StringBuffer sb = new StringBuffer();
        for (int i = 0; i < iterations; i++) {
            sb.append("string").append(i);
        }
        return sb.toString();
    }
    
    @Benchmark
    public String testStringConcat() {
        String result = "";
        for (int i = 0; i < iterations; i++) {
            result = result + "string" + i;  // æ€§èƒ½æœ€å·®
        }
        return result;
    }
}
```

å…¸å‹ç»“æœåˆ†æï¼š
- `StringBuilder`ï¼šæœ€å¿«ï¼Œéçº¿ç¨‹å®‰å…¨
- `StringBuffer`ï¼šè¾ƒæ…¢ï¼Œçº¿ç¨‹å®‰å…¨
- å­—ç¬¦ä¸²ç›´æ¥æ‹¼æ¥ï¼šæœ€æ…¢ï¼Œæ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡

### 2ã€é›†åˆéå†æ€§èƒ½æµ‹è¯•

```java
@State(Scope.Benchmark)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MICROSECONDS)
public class CollectionIterationBenchmark {
    
    @Param({"1000", "10000", "100000"})
    private int size;
    
    private List<Integer> arrayList;
    private List<Integer> linkedList;
    
    @Setup
    public void setup() {
        arrayList = new ArrayList<>(size);
        linkedList = new LinkedList<>();
        for (int i = 0; i < size; i++) {
            arrayList.add(i);
            linkedList.add(i);
        }
    }
    
    @Benchmark
    public int arrayListFor() {
        int sum = 0;
        for (int i = 0; i < arrayList.size(); i++) {
            sum += arrayList.get(i);
        }
        return sum;
    }
    
    @Benchmark
    public int arrayListForEach() {
        int sum = 0;
        for (Integer value : arrayList) {
            sum += value;
        }
        return sum;
    }
    
    @Benchmark
    public int arrayListStream() {
        return arrayList.stream()
            .mapToInt(Integer::intValue)
            .sum();
    }
    
    @Benchmark
    public int linkedListFor() {
        int sum = 0;
        for (int i = 0; i < linkedList.size(); i++) {
            sum += linkedList.get(i);  // O(n)è®¿é—®ï¼Œæ€§èƒ½æå·®
        }
        return sum;
    }
    
    @Benchmark
    public int linkedListForEach() {
        int sum = 0;
        for (Integer value : linkedList) {
            sum += value;  // ä½¿ç”¨è¿­ä»£å™¨ï¼Œæ€§èƒ½å¥½
        }
        return sum;
    }
}
```

### 3ã€å¯¹æ¯”ä¸åŒç®—æ³•çš„æ€§èƒ½

ä½¿ç”¨JMHå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¹æ¯”ä¸åŒç®—æ³•åœ¨ç›¸åŒè¾“å…¥æ¡ä»¶ä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°±å¯¹å†’æ³¡æ’åºå’Œå¿«é€Ÿæ’åºåšäº†æ¯”è¾ƒã€‚

### 4ã€éªŒè¯JVMå‚æ•°å¯¹æ€§èƒ½çš„å½±å“

JMHå¯ä»¥ç”¨äºéªŒè¯JVMå‚æ•°å¯¹ç¨‹åºæ€§èƒ½çš„å½±å“ã€‚é€šè¿‡ `@Fork` æ³¨è§£é…ç½®ä¸åŒçš„JVMå‚æ•°ï¼š

```java
@State(Scope.Benchmark)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MILLISECONDS)
public class JVMOptionsBenchmark {
    
    @Benchmark
    @Fork(value = 1, jvmArgs = {"-Xms1G", "-Xmx1G"})
    public void smallHeap() {
        allocateMemory();
    }
    
    @Benchmark
    @Fork(value = 1, jvmArgs = {"-Xms4G", "-Xmx4G"})
    public void largeHeap() {
        allocateMemory();
    }
    
    @Benchmark
    @Fork(value = 1, jvmArgs = {"-XX:+UseG1GC"})
    public void withG1GC() {
        allocateMemory();
    }
    
    @Benchmark
    @Fork(value = 1, jvmArgs = {"-XX:+UseParallelGC"})
    public void withParallelGC() {
        allocateMemory();
    }
    
    private void allocateMemory() {
        List<byte[]> list = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            list.add(new byte[1024 * 1024]); // åˆ†é…1MB
        }
    }
}
```

### 5ã€å¹¶å‘å®¹å™¨æ€§èƒ½æµ‹è¯•

JMHå¯ä»¥ç”¨äºè¯„ä¼°å¹¶å‘å®¹å™¨ï¼ˆå¦‚`java.util.concurrent`åŒ…ä¸­çš„ç±»ï¼‰åœ¨ä¸åŒå¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªåŸºå‡†æµ‹è¯•ï¼Œå¯¹æ¯”`ConcurrentHashMap`å’Œ`Hashtable`åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚

```java
import org.openjdk.jmh.annotations.*;

import java.util.Hashtable;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ThreadLocalRandom;
import java.util.concurrent.TimeUnit;

@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
@State(Scope.Benchmark)
@Warmup(iterations = 2, time = 1, timeUnit = TimeUnit.SECONDS)
@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)
@Fork(1)
public class MapBenchmark {

  private static final int THREAD_COUNT = 4;
  private static final int ELEMENT_COUNT = 100000;

  private Map<Integer, Integer> concurrentHashMap;
  private Map<Integer, Integer> hashtable;

  @Setup
  @Threads(THREAD_COUNT)
  public void setup() {
    concurrentHashMap = new ConcurrentHashMap<>();
    hashtable = new Hashtable<>();
  }

  @Benchmark
  @Threads(THREAD_COUNT)
  public void testConcurrentHashMap() {
    ThreadLocalRandom random = ThreadLocalRandom.current();
    for (int i = 0; i < ELEMENT_COUNT; i++) {
      concurrentHashMap.put(random.nextInt(), random.nextInt());
    }
  }

  @Benchmark
  public void testHashtable() {
    ThreadLocalRandom random = ThreadLocalRandom.current();
    for (int i = 0; i < ELEMENT_COUNT; i++) {
      hashtable.put(random.nextInt(), random.nextInt());
    }
  }
}
```

### 6ã€Java Stream APIæ€§èƒ½æµ‹è¯•

JMHè¿˜å¯ä»¥ç”¨äºè¯„ä¼°Java Stream APIåœ¨ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªåŸºå‡†æµ‹è¯•ï¼Œå¯¹æ¯”ä½¿ç”¨Stream APIå’Œä¼ ç»Ÿçš„forå¾ªç¯éå†é›†åˆçš„æ€§èƒ½ã€‚

```java
import org.openjdk.jmh.annotations.*;
import org.openjdk.jmh.runner.Runner;
import org.openjdk.jmh.runner.RunnerException;
import org.openjdk.jmh.runner.options.Options;
import org.openjdk.jmh.runner.options.OptionsBuilder;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.MILLISECONDS)
@Warmup(iterations = 3, time = 1)
@Measurement(iterations = 5, time = 1)
@Fork(1)
public class StreamVsForLoopBenchmark {

    @State(Scope.Benchmark)
    public static class BenchmarkState {
        public List<Integer> list;

        @Setup(Level.Trial)
        public void setUp() {
            list = new ArrayList<>();
            for (int i = 0; i < 100000; i++) {
                list.add(i);
            }
        }
    }

    @Benchmark
    public List<Integer> testStreamAPI(BenchmarkState state) {
        return state.list.stream()
                .filter(i -> i % 2 == 0)
                .collect(Collectors.toList());
    }

    @Benchmark
    public List<Integer> testForLoop(BenchmarkState state) {
        List<Integer> evenNumbers = new ArrayList<>();
        for (Integer i : state.list) {
            if (i % 2 == 0) {
                evenNumbers.add(i);
            }
        }
        return evenNumbers;
    }

    public static void main(String[] args) throws RunnerException {
        Options options = new OptionsBuilder()
                .include(StreamVsForLoopBenchmark.class.getSimpleName())
                .build();

        new Runner(options).run();
    }
}
```

## ä¸ƒã€å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

### 1ã€å¾ªç¯ä¼˜åŒ–é™·é˜±

JVMå¯èƒ½ä¼šä¼˜åŒ–æ‰çœ‹ä¼¼æœ‰ç”¨ä½†å®é™…æ— æ•ˆçš„å¾ªç¯ï¼š

```java
// é”™è¯¯ç¤ºä¾‹ - å¾ªç¯å¯èƒ½è¢«ä¼˜åŒ–æ‰
@Benchmark
public void wrongLoop() {
    for (int i = 0; i < 1000; i++) {
        Math.sqrt(i);  // ç»“æœæœªä½¿ç”¨ï¼Œå¯èƒ½è¢«ä¼˜åŒ–æ‰
    }
}

// æ­£ç¡®ç¤ºä¾‹ - ä½¿ç”¨Blackholeæ¶ˆè´¹ç»“æœ
@Benchmark
public void correctLoop(Blackhole bh) {
    for (int i = 0; i < 1000; i++) {
        bh.consume(Math.sqrt(i));
    }
}
```

### 2ã€å¸¸é‡æŠ˜å é™·é˜±

ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡è¡¨è¾¾å¼ï¼š

```java
// é”™è¯¯ç¤ºä¾‹ - ç¼–è¯‘æ—¶è®¡ç®—
@Benchmark
public int constantFolding() {
    return 2 * 3 * 4 * 5;  // ç¼–è¯‘æ—¶å˜ä¸º return 120;
}

// æ­£ç¡®ç¤ºä¾‹ - ä½¿ç”¨@Stateæ³¨å…¥å˜é‡
@State(Scope.Benchmark)
public static class MyState {
    public int a = 2, b = 3, c = 4, d = 5;
}

@Benchmark
public int avoidConstantFolding(MyState state) {
    return state.a * state.b * state.c * state.d;
}
```

### 3ã€ä¼ªå…±äº«é—®é¢˜

å¤šçº¿ç¨‹æµ‹è¯•æ—¶ï¼ŒCPUç¼“å­˜è¡Œçš„ä¼ªå…±äº«ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼š

```java
// å¯èƒ½å­˜åœ¨ä¼ªå…±äº«çš„ç¤ºä¾‹
@State(Scope.Group)
public class SharedState {
    public volatile long x;
    public volatile long y;  // å¯èƒ½ä¸xåœ¨åŒä¸€ç¼“å­˜è¡Œ
}

// ä½¿ç”¨å¡«å……é¿å…ä¼ªå…±äº«
@State(Scope.Group) 
public class PaddedState {
    public volatile long x;
    public long p1, p2, p3, p4, p5, p6, p7;  // ç¼“å­˜è¡Œå¡«å……
    public volatile long y;  // ç¡®ä¿åœ¨ä¸åŒç¼“å­˜è¡Œ
}
```

## å…«ã€æ³¨æ„äº‹é¡¹ä¸æœ€ä½³å®è·µ

### 1ã€é¿å…æ­»ä»£ç æ¶ˆé™¤

ä¸ºäº†ç¡®ä¿åŸºå‡†æµ‹è¯•æ–¹æ³•çš„æ‰§è¡Œä¸ä¼šè¢«JVMä¼˜åŒ–å™¨æ¶ˆé™¤ï¼Œå¯ä»¥ä½¿ç”¨`org.openjdk.jmh.infra.Blackhole`ç±»æ¶ˆè´¹æµ‹è¯•æ–¹æ³•çš„è¿”å›å€¼ã€‚è¿™å¯ä»¥é˜²æ­¢JVMå°†æ²¡æœ‰å®é™…ä½œç”¨çš„ä»£ç ä¼˜åŒ–æ‰ã€‚

```java
import org.openjdk.jmh.annotations.*;

@State(Scope.Thread)
public class OptimizedBenchmark {

    private static final int ARRAY_SIZE = 1000;

    @Benchmark
    public void testMethod() {
        int[] array = new int[ARRAY_SIZE];
        for (int i = 0; i < ARRAY_SIZE; i++) {
            array[i] = i;
        }
        // æ³¨æ„è¿™é‡Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨ Blackhole æ¶ˆè´¹ä¸­é—´ç»“æœ
    }
}
```
JVM ä¼˜åŒ–å™¨å¯èƒ½ä¼šè®¤ä¸ºè¿™æ®µä»£ç æ²¡æœ‰å®é™…ä½œç”¨ï¼Œå› ä¸ºæ•°ç»„å¹¶æ²¡æœ‰è¢«ä½¿ç”¨æˆ–è¿”å›ã€‚å› æ­¤ï¼ŒJVM ä¼˜åŒ–å™¨å¯èƒ½ä¼šåˆ é™¤è¿™æ®µä»£ç æˆ–è€…å°†å…¶æ›¿æ¢ä¸ºæ›´ç®€å•çš„å®ç°ï¼Œä»è€Œå¯¼è‡´åŸºå‡†æµ‹è¯•çš„ç»“æœä¸çœŸå®åœ°é«˜ã€‚

å¯ä»¥ä½¿ç”¨`Blackhole`ç±»æ¶ˆè´¹è®¡ç®—ç»“æœï¼Œä»¥é¿å…JVMå¯¹æœªä½¿ç”¨ç»“æœçš„ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼š
```java
@Benchmark
public void testMethod(Blackhole bh) {
    ...
    bh.consume(array);
}
```

å…³äºJVMä¼˜åŒ–æŠ€æœ¯ï¼Œå‚è€ƒï¼š[æ·±å…¥ç†è§£JITç¼–è¯‘å™¨](/pages/e5cb92/)

### 2ã€ä½¿ç”¨æ­£ç¡®çš„æµ‹è¯•èŒƒå›´

ä¸ºäº†è·å¾—å‡†ç¡®çš„æµ‹è¯•ç»“æœï¼Œè¯·ç¡®ä¿åœ¨åŸºå‡†æµ‹è¯•æ–¹æ³•ä¸­ä½¿ç”¨æ­£ç¡®çš„æµ‹è¯•èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œåœ¨å¯¹æ¯”ä¸¤ä¸ªç®—æ³•æ—¶ï¼Œåº”ç¡®ä¿å®ƒä»¬å¤„ç†ç›¸åŒçš„è¾“å…¥æ•°æ®ã€‚

### 3ã€å¤šæ¬¡è¿è¡Œæµ‹è¯•ä»¥æé«˜å¯é æ€§

ä¸ºäº†ç¡®ä¿åŸºå‡†æµ‹è¯•ç»“æœçš„å¯é æ€§ï¼Œå»ºè®®å¤šæ¬¡è¿è¡Œæµ‹è¯•å¹¶åˆ†æç»“æœã€‚è¿™æœ‰åŠ©äºå‘ç°æ½œåœ¨çš„æ€§èƒ½é—®é¢˜å’Œå¼‚å¸¸å€¼ã€‚

### 4ã€åŸºå‡†æµ‹è¯•è°ƒè¯•æŠ€å·§

å½“åŸºå‡†æµ‹è¯•ç»“æœä¸ç¬¦åˆé¢„æœŸæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è°ƒè¯•æŠ€å·§ï¼š

```java
@State(Scope.Thread)
public class DebugBenchmark {
    
    // ä½¿ç”¨-prof perfnormæŸ¥çœ‹æ›´è¯¦ç»†çš„æ€§èƒ½æ•°æ®
    @Benchmark
    @CompilerControl(CompilerControl.Mode.DONT_INLINE)  // é˜²æ­¢å†…è”
    public void debugMethod() {
        // æµ‹è¯•ä»£ç 
    }
    
    // æ‰“å°ç¼–è¯‘æ—¥å¿—
    @Fork(jvmArgs = {"-XX:+PrintCompilation"})
    @Benchmark
    public void withCompilationLog() {
        // æŸ¥çœ‹JITç¼–è¯‘è¿‡ç¨‹
    }
    
    // ä½¿ç”¨æ–­è¨€éªŒè¯æ­£ç¡®æ€§
    @Benchmark
    public int withAssertion() {
        int result = complexCalculation();
        assert result > 0 : "Result should be positive";
        return result;
    }
}
```

å¸¸ç”¨è°ƒè¯•å‚æ•°ï¼š
- `-prof perfnorm`ï¼šæ˜¾ç¤ºæ¯ä¸ªæ“ä½œçš„æŒ‡ä»¤æ•°å’ŒCPUå‘¨æœŸ
- `-prof gc`ï¼šæ˜¾ç¤ºGCç»Ÿè®¡ä¿¡æ¯
- `-prof stack`ï¼šæ˜¾ç¤ºçƒ­ç‚¹æ–¹æ³•çš„è°ƒç”¨æ ˆ
- `-v EXTRA`ï¼šæ˜¾ç¤ºæ›´è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯

## ä¹ã€æ€§èƒ½æµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨è¿›è¡ŒJMHåŸºå‡†æµ‹è¯•æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹æ£€æŸ¥æ¸…å•ç¡®ä¿æµ‹è¯•è´¨é‡ï¼š

âœ… **æµ‹è¯•è®¾è®¡**
- [ ] æµ‹è¯•æ–¹æ³•æ˜¯å¦è¶³å¤Ÿç®€å•ï¼ŒåªåŒ…å«æ ¸å¿ƒé€»è¾‘ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº† `@State` æ­£ç¡®ç®¡ç†æµ‹è¯•çŠ¶æ€ï¼Ÿ
- [ ] æ˜¯å¦é€‰æ‹©äº†åˆé€‚çš„ `@BenchmarkMode`ï¼Ÿ
- [ ] æ—¶é—´å•ä½æ˜¯å¦åˆç†ï¼ˆç»“æœåœ¨1-1000ä¹‹é—´ï¼‰ï¼Ÿ

âœ… **é¿å…ä¼˜åŒ–é™·é˜±**
- [ ] æ˜¯å¦ä½¿ç”¨ `Blackhole` æ¶ˆè´¹æ— ç”¨ç»“æœï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†å¸¸é‡æŠ˜å ï¼Ÿ
- [ ] å¾ªç¯æ˜¯å¦å¯èƒ½è¢«ä¼˜åŒ–æ‰ï¼Ÿ
- [ ] å¤šçº¿ç¨‹æµ‹è¯•æ˜¯å¦è€ƒè™‘äº†ä¼ªå…±äº«ï¼Ÿ

âœ… **æµ‹è¯•é…ç½®**
- [ ] é¢„çƒ­æ¬¡æ•°æ˜¯å¦è¶³å¤Ÿï¼ˆé€šå¸¸3-5æ¬¡ï¼‰ï¼Ÿ
- [ ] æµ‹é‡æ¬¡æ•°æ˜¯å¦è¶³å¤Ÿï¼ˆé€šå¸¸5-10æ¬¡ï¼‰ï¼Ÿ
- [ ] `@Fork` æ•°é‡æ˜¯å¦åˆç†ï¼ˆè‡³å°‘1æ¬¡ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦è®¾ç½®ç‰¹å®šçš„JVMå‚æ•°ï¼Ÿ

âœ… **ç»“æœåˆ†æ**
- [ ] æ˜¯å¦å…³æ³¨äº†æ ‡å‡†å·®å’Œç½®ä¿¡åŒºé—´ï¼Ÿ
- [ ] æ˜¯å¦å¯¹æ¯”äº†ä¸åŒå‚æ•°ä¸‹çš„ç»“æœï¼Ÿ
- [ ] æ˜¯å¦éªŒè¯äº†æµ‹è¯•çš„å¯é‡å¤æ€§ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨Profileråˆ†æäº†æ€§èƒ½ç“¶é¢ˆï¼Ÿ

## åã€ç»“è®º

JMHæ˜¯Javaæ€§èƒ½æµ‹è¯•çš„é»„é‡‘æ ‡å‡†ï¼Œå®ƒä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ›´æ˜¯ä¸€å¥—ç§‘å­¦çš„æ€§èƒ½æµ‹è¯•æ–¹æ³•è®ºã€‚é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œä½ åº”è¯¥æŒæ¡äº†ï¼š

### 1ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

1. **åŸºç¡€æ¦‚å¿µ**ï¼šç†è§£é¢„çƒ­ã€æµ‹è¯•æ¨¡å¼ã€å¹¶å‘æ§åˆ¶ç­‰æ ¸å¿ƒæ¦‚å¿µ
2. **æ³¨è§£ä½¿ç”¨**ï¼šç†Ÿç»ƒè¿ç”¨ `@Benchmark`ã€`@State`ã€`@Setup` ç­‰æ³¨è§£
3. **é™·é˜±è§„é¿**ï¼šè¯†åˆ«å¹¶é¿å…æ­»ä»£ç æ¶ˆé™¤ã€å¸¸é‡æŠ˜å ã€ä¼ªå…±äº«ç­‰ä¼˜åŒ–é™·é˜±
4. **å®è·µåº”ç”¨**ï¼šé€šè¿‡å®é™…æ¡ˆä¾‹æŒæ¡æ€§èƒ½æµ‹è¯•çš„è®¾è®¡å’Œå®æ–½

### 2ã€è¿›é˜¶å­¦ä¹ èµ„æº

- ğŸ“š [JMHå®˜æ–¹ç¤ºä¾‹](https://github.com/openjdk/jmh/tree/master/jmh-samples)ï¼šæœ€æƒå¨çš„å­¦ä¹ ææ–™
- ğŸ“– [JMHæºç ](https://github.com/openjdk/jmh)ï¼šæ·±å…¥ç†è§£å®ç°åŸç†
- ğŸ¯ [JMH Visualizer](https://jmh.morethan.io/)ï¼šå¯è§†åŒ–åˆ†ææµ‹è¯•ç»“æœ
- ğŸ’¡ [æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](https://wiki.openjdk.java.net/display/HotSpot/MicroBenchmarks)ï¼šOpenJDKå®˜æ–¹å»ºè®®

### 3ã€æœ€ä½³å®è·µæ€»ç»“

1. **å…ˆæµ‹é‡ï¼Œåä¼˜åŒ–**ï¼šä¸è¦å‡­æ„Ÿè§‰ä¼˜åŒ–ï¼Œç”¨æ•°æ®è¯´è¯
2. **éš”ç¦»å˜é‡**ï¼šæ¯æ¬¡åªæµ‹è¯•ä¸€ä¸ªå˜åŒ–ç‚¹
3. **æ¨¡æ‹ŸçœŸå®åœºæ™¯**ï¼šæµ‹è¯•æ•°æ®å’Œå¹¶å‘åº¦è¦è´´è¿‘ç”Ÿäº§ç¯å¢ƒ
4. **æŒç»­ç›‘æ§**ï¼šæ€§èƒ½æµ‹è¯•åº”è¯¥æˆä¸ºCI/CDçš„ä¸€éƒ¨åˆ†
5. **å…¨é¢åˆ†æ**ï¼šä¸åªçœ‹å¹³å‡å€¼ï¼Œè¿˜è¦å…³æ³¨åˆ†å¸ƒå’Œå¼‚å¸¸å€¼

è®°ä½ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€é—¨è‰ºæœ¯ï¼Œéœ€è¦åœ¨å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚JMHä¸ºæˆ‘ä»¬æä¾›äº†ç§‘å­¦çš„æµ‹é‡æ‰‹æ®µï¼Œä½†æœ€ç»ˆçš„å†³ç­–è¿˜éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯å’Œéœ€æ±‚ã€‚

> "è¿‡æ—©çš„ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº" - Donald Knuth
> 
> ä½†æœ‰äº†JMHï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ­£ç¡®çš„æ—¶é—´åšæ­£ç¡®çš„ä¼˜åŒ–ã€‚

**ç¥ä½ å˜å¾—æ›´å¼º!**

