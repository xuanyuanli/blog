---
title: Javaå¹¶å‘-å€’è®¡æ—¶å™¨CountDownLatch
date: 2018-06-11 19:48:57
permalink: /pages/f53430/
categories: 
  - åç«¯
  - Javaå¹¶å‘
tags: 
  - CountDownLatch
author: 
  name: è½©è¾•æ
  link: https://github.com/xuanyuanli
---

`CountDownLatch` æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œå®ƒçš„ä½œç”¨å°±åƒä¸€ä¸ªå€’è®¡æ—¶å™¨ï¼Œç‰¹åˆ«é€‚åˆ"ç­‰æ‰€æœ‰å­ä»»åŠ¡å®Œæˆåå†æ‰§è¡Œä¸»ä»»åŠ¡"çš„åœºæ™¯ã€‚æ¯”å¦‚è¯´ï¼Œä½ è¦å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼Œä½†éœ€è¦å…ˆå®Œæˆæ•°æ®åˆå§‹åŒ–ã€é…ç½®åŠ è½½ã€è¿æ¥æ± å»ºç«‹ç­‰å¤šä¸ªå‡†å¤‡å·¥ä½œï¼Œè¿™æ—¶å€™ `CountDownLatch` å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

<!-- more -->

## ä¸€ã€ä»€ä¹ˆæ˜¯ CountDownLatch

`CountDownLatch` ç›´è¯‘è¿‡æ¥å°±æ˜¯"å€’è®¡æ•°é—¸é—¨"ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“è®¡æ•°å™¨é€’å‡åˆ° 0 æ—¶ï¼Œä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸€æ¬¡æ€§çš„â€”â€”è®¡æ•°å™¨å‡åˆ° 0 ä¹‹åå°±ä¸èƒ½å†é‡ç½®äº†ã€‚

## äºŒã€æ ¸å¿ƒ API

`CountDownLatch` çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä¸»è¦åŒ…å«ä¸€ä¸ªæ„é€ å‡½æ•°å’Œå‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š

- **CountDownLatch(int count)**: æ„é€ å‡½æ•°ï¼ŒæŒ‡å®šè®¡æ•°å™¨çš„åˆå§‹å€¼
- **countDown()**: è®¡æ•°å™¨å‡ 1ï¼Œå½“è®¡æ•°åˆ°è¾¾ 0 æ—¶ï¼Œé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
- **await()**: è®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°è®¡æ•°å™¨å˜ä¸º 0
- **await(long timeout, TimeUnit unit)**: å¸¦è¶…æ—¶çš„ç­‰å¾…ï¼Œé¿å…æ— é™æœŸç­‰å¾…

## ä¸‰ã€åŸºç¡€ç¤ºä¾‹ï¼šç«ç®­å‘å°„å€’è®¡æ—¶

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç«ç®­å‘å°„çš„ä¾‹å­æ¥ç†è§£ `CountDownLatch` çš„å·¥ä½œåŸç†ï¼š

```java
public class CountDownLatchDemo {
    static final CountDownLatch LATCH = new CountDownLatch(10);

    public static class Task implements Runnable {
        private static final AtomicInteger counter = new AtomicInteger(1);

        @Override
        public void run() {
            try {
                // æ¨¡æ‹Ÿä¸åŒæ£€æµ‹ä»»åŠ¡è€—æ—¶ä¸åŒ
                Thread.sleep(new Random().nextInt(3000) + 1000);
                
                int taskNumber = counter.getAndIncrement();
                System.out.println("ç«ç®­æ£€æµ‹ä»»åŠ¡-" + taskNumber + " å®Œæˆï¼Œçº¿ç¨‹ï¼š" + 
                                   Thread.currentThread().getName());
                
                // å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œè®¡æ•°å™¨å‡ 1
                LATCH.countDown();
                System.out.println("å‰©ä½™ä»»åŠ¡æ•°ï¼š" + LATCH.getCount());
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                System.err.println("ä»»åŠ¡è¢«ä¸­æ–­ï¼š" + e.getMessage());
            }
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        System.out.println("å¼€å§‹ç«ç®­å‘å°„å‰æ£€æŸ¥ï¼Œéœ€è¦å®Œæˆ 10 é¡¹æ£€æµ‹ä»»åŠ¡...");
        
        ExecutorService executorService = Executors.newFixedThreadPool(10);
        long startTime = System.currentTimeMillis();
        
        // æäº¤æ‰€æœ‰æ£€æµ‹ä»»åŠ¡
        for (int i = 0; i < 10; i++) {
            executorService.execute(new Task());
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        System.out.println("ç­‰å¾…æ‰€æœ‰æ£€æµ‹ä»»åŠ¡å®Œæˆ...");
        LATCH.await();
        
        long endTime = System.currentTimeMillis();
        System.out.println("ğŸš€ æ‰€æœ‰æ£€æµ‹å®Œæˆï¼ç«ç®­å‘å°„ï¼è€—æ—¶ï¼š" + (endTime - startTime) + "ms");
        
        executorService.shutdown();
    }
}
```

è¿è¡Œè¿™ä¸ªä¾‹å­ï¼Œä½ ä¼šçœ‹åˆ° 10 ä¸ªæ£€æµ‹ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œåªæœ‰å½“æœ€åä¸€ä¸ªä»»åŠ¡å®Œæˆæ—¶ï¼Œä¸»çº¿ç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œ"ç«ç®­å‘å°„"ã€‚

## å››ã€å¸¦è¶…æ—¶çš„ç¤ºä¾‹

æœ‰æ—¶å€™æˆ‘ä»¬ä¸èƒ½æ— é™ç­‰å¾…ï¼Œéœ€è¦è®¾ç½®è¶…æ—¶æœºåˆ¶ï¼š

```java
public class CountDownLatchTimeoutDemo {
    private static final CountDownLatch latch = new CountDownLatch(3);
    
    public static void main(String[] args) throws InterruptedException {
        ExecutorService executor = Executors.newFixedThreadPool(3);
        
        // å¯åŠ¨ä»»åŠ¡
        for (int i = 1; i <= 3; i++) {
            int taskId = i;
            executor.submit(() -> {
                try {
                    // æ¨¡æ‹Ÿç¬¬3ä¸ªä»»åŠ¡æ‰§è¡Œå¾ˆä¹…
                    if (taskId == 3) {
                        Thread.sleep(5000);
                    } else {
                        Thread.sleep(1000);
                    }
                    System.out.println("ä»»åŠ¡ " + taskId + " å®Œæˆ");
                    latch.countDown();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
        }
        
        // ç­‰å¾…æœ€å¤š3ç§’
        boolean completed = latch.await(3, TimeUnit.SECONDS);
        
        if (completed) {
            System.out.println("æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨è§„å®šæ—¶é—´å†…å®Œæˆäº†");
        } else {
            System.out.println("æœ‰ä»»åŠ¡è¶…æ—¶äº†ï¼Œå½“å‰å‰©ä½™ä»»åŠ¡æ•°ï¼š" + latch.getCount());
        }
        
        executor.shutdownNow();
    }
}
```

## äº”ã€å®é™…åº”ç”¨åœºæ™¯

### 1ã€æœåŠ¡å¯åŠ¨ç­‰å¾…

```java
public class ServiceStartupDemo {
    private final CountDownLatch startupLatch = new CountDownLatch(3);
    
    public void startApplication() throws InterruptedException {
        System.out.println("æ­£åœ¨å¯åŠ¨åº”ç”¨æœåŠ¡...");
        
        // å¼‚æ­¥åˆå§‹åŒ–å„ä¸ªç»„ä»¶
        CompletableFuture.runAsync(this::initDatabase);
        CompletableFuture.runAsync(this::loadConfiguration);  
        CompletableFuture.runAsync(this::setupConnectionPool);
        
        // ç­‰å¾…æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–å®Œæˆ
        startupLatch.await();
        System.out.println("åº”ç”¨å¯åŠ¨å®Œæˆï¼Œå¼€å§‹æ¥å—è¯·æ±‚");
    }
    
    private void initDatabase() {
        try {
            Thread.sleep(2000); // æ¨¡æ‹Ÿæ•°æ®åº“åˆå§‹åŒ–
            System.out.println("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ");
            startupLatch.countDown();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private void loadConfiguration() {
        try {
            Thread.sleep(1500);
            System.out.println("é…ç½®åŠ è½½å®Œæˆ");
            startupLatch.countDown();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private void setupConnectionPool() {
        try {
            Thread.sleep(1000);
            System.out.println("è¿æ¥æ± è®¾ç½®å®Œæˆ");
            startupLatch.countDown();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

### 2ã€å¹¶è¡Œè®¡ç®—æ±‡æ€»

```java
public class ParallelComputeDemo {
    public static void main(String[] args) throws InterruptedException {
        int[] numbers = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
        int workerCount = 4;
        CountDownLatch latch = new CountDownLatch(workerCount);
        AtomicInteger totalSum = new AtomicInteger(0);
        
        ExecutorService executor = Executors.newFixedThreadPool(workerCount);
        
        // åˆ†ç‰‡å¹¶è¡Œè®¡ç®—
        int chunkSize = numbers.length / workerCount;
        for (int i = 0; i < workerCount; i++) {
            int startIndex = i * chunkSize;
            int endIndex = (i == workerCount - 1) ? numbers.length : startIndex + chunkSize;
            
            executor.submit(() -> {
                int partialSum = 0;
                for (int j = startIndex; j < endIndex; j++) {
                    partialSum += numbers[j];
                }
                totalSum.addAndGet(partialSum);
                System.out.println("Worker " + Thread.currentThread().getName() + 
                                 " è®¡ç®—å®Œæˆï¼Œéƒ¨åˆ†å’Œï¼š" + partialSum);
                latch.countDown();
            });
        }
        
        latch.await();
        System.out.println("æ‰€æœ‰è®¡ç®—å®Œæˆï¼Œæ€»å’Œï¼š" + totalSum.get());
        executor.shutdown();
    }
}
```

## å…­ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹

### 1ã€è®¡æ•°å™¨æ— æ³•é‡ç½®
`CountDownLatch` æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè®¡æ•°å™¨åˆ° 0 åå°±ä¸èƒ½å†é‡å¤ä½¿ç”¨ã€‚å¦‚æœéœ€è¦é‡å¤ä½¿ç”¨ï¼Œè€ƒè™‘ä½¿ç”¨ `CyclicBarrier`ã€‚

### 2ã€é¿å…æ­»é”
ç¡®ä¿ `countDown()` ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œå¦åˆ™ç­‰å¾…çš„çº¿ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼š

```java
// æ¨èçš„å¼‚å¸¸å®‰å…¨åšæ³•
public void doTask() {
    try {
        // æ‰§è¡Œä»»åŠ¡é€»è¾‘
        performBusinessLogic();
    } finally {
        // ç¡®ä¿è®¡æ•°å™¨ä¸€å®šä¼šå‡å°‘
        latch.countDown();
    }
}
```

### 3ã€åˆç†è®¾ç½®è¶…æ—¶
åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨å¸¦è¶…æ—¶çš„ `await()` æ–¹æ³•ï¼Œé¿å…æ— é™ç­‰å¾…ï¼š

```java
if (!latch.await(30, TimeUnit.SECONDS)) {
    throw new TimeoutException("ä»»åŠ¡æ‰§è¡Œè¶…æ—¶");
}
```

## ä¸ƒã€æ€§èƒ½ç‰¹ç‚¹

- **å†…å­˜å¼€é”€å°**: `CountDownLatch` å†…éƒ¨åŸºäº AQSï¼ˆAbstractQueuedSynchronizerï¼‰å®ç°ï¼Œå†…å­˜å ç”¨å¾ˆå°
- **æ€§èƒ½ä¼˜ç§€**: `countDown()` å’Œ `await()` æ“ä½œéƒ½æ˜¯é«˜æ•ˆçš„
- **çº¿ç¨‹å®‰å…¨**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ— éœ€é¢å¤–åŒæ­¥

## å…«ã€æ€»ç»“

`CountDownLatch` æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„åŒæ­¥å·¥å…·ï¼Œç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š
- ä¸»çº¿ç¨‹ç­‰å¾…å¤šä¸ªå­çº¿ç¨‹å®Œæˆåå†ç»§ç»­æ‰§è¡Œ
- ç¡®ä¿æŸäº›èµ„æºåœ¨å¹¶å‘è®¿é—®å‰å·²ç»å‡†å¤‡å°±ç»ª
- å®ç°å¤šçº¿ç¨‹çš„"é›†åˆç‚¹"ï¼Œç­‰æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸ªçŠ¶æ€

å®ƒçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œä½†è¦æ³¨æ„æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œä½¿ç”¨å®Œå°±ä¸èƒ½é‡å¤ä½¿ç”¨äº†ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œè®°ä½åˆç†è®¾ç½®è¶…æ—¶å’Œåšå¥½å¼‚å¸¸å¤„ç†ï¼Œå°±èƒ½å¾ˆå¥½åœ°å‘æŒ¥å®ƒçš„ä½œç”¨ã€‚
