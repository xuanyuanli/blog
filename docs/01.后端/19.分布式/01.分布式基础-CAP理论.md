---
title: 分布式基础-CAP理论
date: 2022-07-31 10:57:43
permalink: /pages/3a018a/
categories:
  - 后端
  - 分布式
tags:
  - 
author: 
  name: 轩辕李
  link: https://github.com/xuanyuanli
---

对于刚进入分布式领域的工程师来说，常会怀有一系列错误的假设。  
基本上每个人都会预设下面的8条假定：
1. 网络是稳定的
2. 网络传输的延迟是零
3. 网络的带宽是无穷大
4. 网络是安全的
5. 网络的拓扑不会改变
6. 只有一个系统管理员
7. 传输数据的成本是零
8. 整个网络是同构的

而有了这些错误假定，就是系统设计悲剧的开始。
<!-- more -->
相应的，为了设计好一个分布式系统，我们应该牢记以下的前提：
1. 网络不总是稳定的
2. 网络传输的延迟不可能为零
3. 网络的带宽是有限的，要充分利用
4. 网络的默认设置是非安全的
5. 网络的拓扑会改变
6. 会有多个系统管理员
7. 传输数据的成本是需要考虑的
8. 整个网络是非同构的

## 为啥要有CAP
有了以上的8条前提，可以想象设计一个好的分布式系统是非常困难的。  
当我们遇到巨大难题的时候，如果有人提纲挈领的给一个指导，那么想必我们的工作会顺利不少。  
那么在业界，存不存在这样的理论指导呢？  
当然是有的，这要感谢Eric Brewer教授，他在2000年7月，提出了著名的CAP猜想：
>> 在一个不稳定（消息要么乱序要么丢了）的网络环境里（分布式异步模型），能否始终保持数据一致

2年后，Seth Gilbert和Nancy Lynch从理论上证明了CAP理论，原始论文请[点击查看](https://users.ece.cmu.edu/~adrian/731-sp04/readings/GL-cap.pdf)。

CAP理论告诉我们，不要幻想了，在分布式环境中，不能既要...又要...还要，做系统要有所取舍。

## 什么是CAP
CAP分别表示：
* 一致性（Consistency）：也就是一个副本修改数据时，其他副本也要更新；一般用到的方式是：等其他副本也写入完成，才算真正写入成功   
* 可用性（Available）：是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能再有限时间内返回结果  
* 分区容错（Partition Tolerance）：是指分布式系统在遇到任何网络分区故障的时候，仍然需要能保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障  

用图片表示是这样的：
![image](https://cdn.staticaly.com/gh/xuanyuanli/Img@master/picx/image.62zjbqkpi6o0.png)

这里就不给出CAP理论的证明了，我们主要来讨论CAP理论的应用

## 为何选择CP：放弃可用性，或部分可用
对于做网站的工程师来说，CP是最先被摒弃的模式。因为可用性对网站来说是生命线，运维同学对此应该深有体会，如果网站服务宕机，那将是最严重的生产事故。    
那么放弃可用性，就没有存在的场景了么？  
大千世界，如此复杂，肯定还是会有CP发展的空间的。比如说银行系统来说，一致性是其生命线，分区容错也是要保证的，这时候允许出现不可用，当出现故障的时候，客户需要耐心等待一下，但是金融数据绝对不能出错。  

同时我们还注意到，关于可用性，这其中有一些弹性空间的。也就是好的系统，会出现部分不可用，而不是完全不可用。这方面，著名的Paxos就是其中翘楚。

### Paxos 
Mike Burrows说世界上只有一种一致性算法，就是Paxos。  
Paxos算法基本上是一个民主选举算法--大多数的决定会成为整个集群的统一决定。任何一个点都可以提出要修改某个数据的提案，是否通过这个提案取决于这个集群中是否有超过半数的结点同意。  
在业界，Paxos算法因为Google的chubby和ZooKeeper而被人熟知。  

关于Paxos算法的详解，参考[维基百科](https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95)  
其实Zookeeper也未完全实现Paxos，而是使用了ZAB协议，参考[Zookeeper协议篇-Paxos算法与ZAB协议](https://zhuanlan.zhihu.com/p/145305409)

## 为何选择CA：放弃分区容错性，加强一致性和可用性
选择CA的系统，就是要放弃分区容错，那么简单理解，可以说我们放弃了系统是分布式的，而追求一个单体架构。       
最容易想到的就是单节点的关系型数据库，保持了强一致性和可用性，但天生不支持分布式。    
那不禁要问，没有了分区容忍，还叫分布式系统么？ 确实不能叫分布式系统了。  
其实对于分布式系统工程实践，CAP 理论更合适的描述是：在满足分区容错的前提下，没有算法能同时满足数据一致性和服务可用性。

## 为何选择AP：放弃一致性，追求分区容错性和可用性
我们首先要明确，CAP中的C值得是强一致性，也就是要求多节点组成的被调要能像单节点一样运作、操作具备原子性，数据在时间、时序上都有要求。  
前面讲到的可用性，显然是在 0% 到 100% 之间连续变化的。对于一致性来说，也是如此，大多数情况下，工程实现上是灵活的，一致性也可以分为多个不同的含义。  
* Weak 弱一致性：当你写入一个新值后，读操作在数据副本上可能读出来，也可能读不出来。比如说一些日志系统
* Eventually 最终一致性：当你写入一个新值后，有可能读不出来，但在某个时间窗口之后保证最终能读出来。比如说事务补偿
* Strong 强一致性：新的数据一旦写入，在任意副本任意时刻都能读到新值。比如说文件系统

Eureka，保证了最终一致性。https://juejin.cn/post/6844904033195409422
RocketMq最终一致性：https://developer.51cto.com/article/648202.html
分布式事务：https://seata.io/zh-cn/docs/dev/mode/at-mode.html，xa和at都是强一致性，tcc和saga是最终一致性
gossip
raft。非拜占庭错误的情况，一般包括 Paxos、Raft 及其变种；要能容忍拜占庭错误的情况，一般包括 PBFT 系列、PoW 系列算法
Dynamo：https://coolshell.cn/articles/10910.html
mongodb的事务支持：https://blog.51cto.com/u_15127651/2901729

## BASE理论
https://www.modb.pro/db/326622

## 总结：CAP的权衡
https://leeweir.github.io/posts/acid-cap-base/
