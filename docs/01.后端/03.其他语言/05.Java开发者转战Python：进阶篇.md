---
title: Javaå¼€å‘è€…è½¬æˆ˜Pythonï¼šè¿›é˜¶ç¯‡
date: 2025-01-20 20:10:00
permalink: /pages/python-for-java-dev-raise/
categories:
  - åç«¯
  - å…¶ä»–è¯­è¨€
tags:
  - Python
author:
  name: è½©è¾•æ
  link: https://github.com/xuanyuanli
---

**ğŸ“– ç³»åˆ—æ–‡ç« å¯¼èˆª**

æœ¬æ–‡æ˜¯"Javaå¼€å‘è€…è½¬æˆ˜Python"ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œæ·±å…¥å­¦ä¹ Pythonçš„è¿›é˜¶ç‰¹æ€§ã€‚

ğŸ“š **ç³»åˆ—**ï¼š
- [åŸºç¡€ç¯‡](/pages/python-for-java-dev-base/) - PythonåŸºç¡€è¯­æ³•ã€æ•°æ®ç»“æ„ã€é¢å‘å¯¹è±¡
- [çƒ­é—¨åº“ä¸è´¨é‡ç®¡ç†](/pages/python-for-java-dev-package/) - Pythonç”Ÿæ€ã€è´¨é‡ç®¡ç†

<!-- more -->

---

## ä¸€ã€Pythonè¿›é˜¶ç‰¹æ€§

### 1ã€å¼‚å¸¸å¤„ç†

Pythonçš„å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸Javaç±»ä¼¼ï¼Œä½†è¯­æ³•æ›´ç®€æ´ï¼Œå¹¶æä¾›äº†ä¸€äº›ç‹¬ç‰¹çš„ç‰¹æ€§ã€‚

#### 1.1ã€try-exceptåŸºæœ¬è¯­æ³•

**åŸºæœ¬ç”¨æ³•**

```python
# åŸºæœ¬å¼‚å¸¸æ•è·
try:
    number = int(input("è¯·è¾“å…¥æ•°å­—: "))
    result = 10 / number
    print(f"ç»“æœ: {result}")
except ValueError:
    print("è¾“å…¥çš„ä¸æ˜¯æœ‰æ•ˆæ•°å­—")
except ZeroDivisionError:
    print("ä¸èƒ½é™¤ä»¥é›¶")
```

å¯¹æ¯”Javaï¼š

```java
// Javaå¼‚å¸¸å¤„ç†
try {
    int number = Integer.parseInt(scanner.nextLine());
    int result = 10 / number;
    System.out.println("ç»“æœ: " + result);
} catch (NumberFormatException e) {
    System.out.println("è¾“å…¥çš„ä¸æ˜¯æœ‰æ•ˆæ•°å­—");
} catch (ArithmeticException e) {
    System.out.println("ä¸èƒ½é™¤ä»¥é›¶");
}
```

**æ•è·å¤šä¸ªå¼‚å¸¸**

```python
# æ–¹å¼1ï¼šåˆ†åˆ«æ•è·
try:
    data = json.loads(json_string)
except ValueError as e:
    print(f"JSONè§£æé”™è¯¯: {e}")
except KeyError as e:
    print(f"é”®ä¸å­˜åœ¨: {e}")

# æ–¹å¼2ï¼šåˆå¹¶æ•è·ï¼ˆå¼‚å¸¸å¤„ç†é€»è¾‘ç›¸åŒæ—¶ï¼‰
try:
    file = open("data.txt")
    data = process(file)
except (FileNotFoundError, PermissionError) as e:
    print(f"æ–‡ä»¶è®¿é—®é”™è¯¯: {e}")

# æ–¹å¼3ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆä¸æ¨èç”¨äºç”Ÿäº§ï¼‰
try:
    risky_operation()
except Exception as e:
    print(f"å‘ç”Ÿé”™è¯¯: {e}")
```

#### 1.2ã€try-except-else-finally

Pythonçš„å¼‚å¸¸å¤„ç†æä¾›äº†`else`å’Œ`finally`å­å¥ã€‚

**elseå­å¥**

```python
try:
    file = open("data.txt", "r")
    data = file.read()
except FileNotFoundError:
    print("æ–‡ä»¶ä¸å­˜åœ¨")
else:
    # åªæœ‰tryå—æˆåŠŸæ—¶æ‰æ‰§è¡Œ
    print(f"è¯»å–äº†{len(data)}ä¸ªå­—ç¬¦")
    process_data(data)
finally:
    # æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œ
    if 'file' in locals():
        file.close()
        print("æ–‡ä»¶å·²å…³é—­")
```

**å®Œæ•´ç¤ºä¾‹**

```python
def divide(a, b):
    try:
        result = a / b
    except ZeroDivisionError:
        print("é”™è¯¯ï¼šé™¤æ•°ä¸èƒ½ä¸ºé›¶")
        return None
    except TypeError:
        print("é”™è¯¯ï¼šå‚æ•°ç±»å‹é”™è¯¯")
        return None
    else:
        print(f"è®¡ç®—æˆåŠŸ: {a} / {b} = {result}")
        return result
    finally:
        print("é™¤æ³•æ“ä½œå®Œæˆ")

# ä½¿ç”¨
divide(10, 2)
# è¾“å‡º:
# è®¡ç®—æˆåŠŸ: 10 / 2 = 5.0
# é™¤æ³•æ“ä½œå®Œæˆ

divide(10, 0)
# è¾“å‡º:
# é”™è¯¯ï¼šé™¤æ•°ä¸èƒ½ä¸ºé›¶
# é™¤æ³•æ“ä½œå®Œæˆ
```

å¯¹æ¯”Javaï¼š

```java
// Javaæ²¡æœ‰elseï¼Œä½†æœ‰finally
try {
    result = a / b;
    System.out.println("è®¡ç®—æˆåŠŸ");  // éœ€è¦æ‰‹åŠ¨åˆ¤æ–­
} catch (ArithmeticException e) {
    System.out.println("é”™è¯¯ï¼šé™¤æ•°ä¸èƒ½ä¸ºé›¶");
} finally {
    System.out.println("é™¤æ³•æ“ä½œå®Œæˆ");
}
```

#### 1.3ã€å¼‚å¸¸ç±»å‹ä¸ç»§æ‰¿ä½“ç³»

Pythonçš„å¼‚å¸¸éƒ½ç»§æ‰¿è‡ª`BaseException`ã€‚

**å¼‚å¸¸å±‚æ¬¡ç»“æ„**

```
BaseException
â”œâ”€â”€ SystemExit           # ç³»ç»Ÿé€€å‡º
â”œâ”€â”€ KeyboardInterrupt    # ç”¨æˆ·ä¸­æ–­ï¼ˆCtrl+Cï¼‰
â”œâ”€â”€ GeneratorExit        # ç”Ÿæˆå™¨é€€å‡º
â””â”€â”€ Exception            # å¸¸è§„å¼‚å¸¸çš„åŸºç±»
    â”œâ”€â”€ StopIteration
    â”œâ”€â”€ ArithmeticError
    â”‚   â”œâ”€â”€ ZeroDivisionError
    â”‚   â”œâ”€â”€ OverflowError
    â”‚   â””â”€â”€ FloatingPointError
    â”œâ”€â”€ AssertionError
    â”œâ”€â”€ AttributeError
    â”œâ”€â”€ EOFError
    â”œâ”€â”€ ImportError
    â”‚   â””â”€â”€ ModuleNotFoundError
    â”œâ”€â”€ LookupError
    â”‚   â”œâ”€â”€ IndexError
    â”‚   â””â”€â”€ KeyError
    â”œâ”€â”€ MemoryError
    â”œâ”€â”€ NameError
    â”‚   â””â”€â”€ UnboundLocalError
    â”œâ”€â”€ OSError
    â”‚   â”œâ”€â”€ FileNotFoundError
    â”‚   â”œâ”€â”€ PermissionError
    â”‚   â””â”€â”€ TimeoutError
    â”œâ”€â”€ RuntimeError
    â”‚   â”œâ”€â”€ NotImplementedError
    â”‚   â””â”€â”€ RecursionError
    â”œâ”€â”€ TypeError
    â”œâ”€â”€ ValueError
    â”‚   â””â”€â”€ UnicodeError
    â””â”€â”€ Warning
```

**å¸¸è§å¼‚å¸¸**

```python
# ValueErrorï¼šå€¼é”™è¯¯
int("abc")  # ValueError: invalid literal

# TypeErrorï¼šç±»å‹é”™è¯¯
"string" + 123  # TypeError: can only concatenate str

# KeyErrorï¼šå­—å…¸é”®ä¸å­˜åœ¨
{"a": 1}["b"]  # KeyError: 'b'

# IndexErrorï¼šç´¢å¼•è¶Šç•Œ
[1, 2, 3][5]  # IndexError: list index out of range

# AttributeErrorï¼šå±æ€§ä¸å­˜åœ¨
"string".non_existent  # AttributeError: 'str' object has no attribute

# FileNotFoundErrorï¼šæ–‡ä»¶ä¸å­˜åœ¨
open("non_existent.txt")  # FileNotFoundError

# ImportErrorï¼šæ¨¡å—å¯¼å…¥å¤±è´¥
import non_existent_module  # ModuleNotFoundError
```

#### 1.4ã€raiseè¯­å¥

**æŠ›å‡ºå¼‚å¸¸**

```python
def withdraw(amount, balance):
    if amount <= 0:
        raise ValueError("å–æ¬¾é‡‘é¢å¿…é¡»å¤§äº0")

    if amount > balance:
        raise ValueError(f"ä½™é¢ä¸è¶³ï¼šéœ€è¦{amount}ï¼Œå½“å‰{balance}")

    return balance - amount

# ä½¿ç”¨
try:
    new_balance = withdraw(1000, 500)
except ValueError as e:
    print(f"æ“ä½œå¤±è´¥: {e}")
# è¾“å‡º: æ“ä½œå¤±è´¥: ä½™é¢ä¸è¶³ï¼šéœ€è¦1000ï¼Œå½“å‰500
```

**é‡æ–°æŠ›å‡ºå¼‚å¸¸**

```python
def process_data(data):
    try:
        result = risky_operation(data)
    except ValueError as e:
        print(f"è­¦å‘Š: {e}")
        raise  # é‡æ–°æŠ›å‡ºåŸå¼‚å¸¸

# æˆ–è€…æŠ›å‡ºæ–°å¼‚å¸¸
def process_file(filename):
    try:
        # æç¤ºï¼šæ–‡ä»¶æ“ä½œçš„è¯¦ç»†å†…å®¹è¯·è§ç¬¬8ç« "æ–‡ä»¶æ“ä½œä¸I/O"
        with open(filename) as f:
            return f.read()
    except FileNotFoundError:
        raise ValueError(f"é…ç½®æ–‡ä»¶{filename}ä¸å­˜åœ¨")
```

#### 1.5ã€è‡ªå®šä¹‰å¼‚å¸¸

```python
# åŸºæœ¬è‡ªå®šä¹‰å¼‚å¸¸
class ValidationError(Exception):
    """æ•°æ®éªŒè¯é”™è¯¯"""
    pass

# å¸¦é¢å¤–ä¿¡æ¯çš„å¼‚å¸¸
class InsufficientFundsError(Exception):
    """ä½™é¢ä¸è¶³å¼‚å¸¸"""
    def __init__(self, balance, amount):
        self.balance = balance
        self.amount = amount
        self.shortage = amount - balance
        super().__init__(f"ä½™é¢ä¸è¶³ï¼šéœ€è¦{amount}ï¼Œå½“å‰{balance}ï¼Œç¼ºå°‘{self.shortage}")

# ä½¿ç”¨
def withdraw(balance, amount):
    if amount > balance:
        raise InsufficientFundsError(balance, amount)
    return balance - amount

try:
    new_balance = withdraw(100, 150)
except InsufficientFundsError as e:
    print(e)
    print(f"ç¼ºå°‘é‡‘é¢: {e.shortage}")
# è¾“å‡º:
# ä½™é¢ä¸è¶³ï¼šéœ€è¦150ï¼Œå½“å‰100ï¼Œç¼ºå°‘50
# ç¼ºå°‘é‡‘é¢: 50
```

**å¼‚å¸¸åŸºç±»æœ€ä½³å®è·µ**

```python
class AppError(Exception):
    """åº”ç”¨ç¨‹åºåŸºç¡€å¼‚å¸¸"""
    pass

class DatabaseError(AppError):
    """æ•°æ®åº“ç›¸å…³é”™è¯¯"""
    pass

class NetworkError(AppError):
    """ç½‘ç»œç›¸å…³é”™è¯¯"""
    pass

class APIError(AppError):
    """APIè°ƒç”¨é”™è¯¯"""
    def __init__(self, status_code, message):
        self.status_code = status_code
        self.message = message
        super().__init__(f"APIé”™è¯¯ {status_code}: {message}")

# ä½¿ç”¨å±‚æ¬¡åŒ–æ•è·
try:
    call_api()
except APIError as e:
    print(f"APIè°ƒç”¨å¤±è´¥: {e}")
except NetworkError as e:
    print(f"ç½‘ç»œé”™è¯¯: {e}")
except AppError as e:
    print(f"åº”ç”¨é”™è¯¯: {e}")
```

å¯¹æ¯”Javaï¼š

```java
// Javaè‡ªå®šä¹‰å¼‚å¸¸
public class InsufficientFundsException extends Exception {
    private double balance;
    private double amount;

    public InsufficientFundsException(double balance, double amount) {
        super("ä½™é¢ä¸è¶³ï¼šéœ€è¦" + amount + "ï¼Œå½“å‰" + balance);
        this.balance = balance;
        this.amount = amount;
    }

    public double getShortage() {
        return amount - balance;
    }
}
```

#### 1.6ã€å¼‚å¸¸é“¾ï¼ˆException Chainingï¼‰

Python 3æ”¯æŒå¼‚å¸¸é“¾ï¼Œä¿ç•™åŸå§‹å¼‚å¸¸ä¿¡æ¯ã€‚

**ä½¿ç”¨`from`å…³é”®å­—**

```python
def parse_config(filename):
    try:
        with open(filename) as f:
            return json.load(f)
    except FileNotFoundError as e:
        raise ValueError(f"é…ç½®æ–‡ä»¶{filename}ä¸å­˜åœ¨") from e
    except json.JSONDecodeError as e:
        raise ValueError(f"é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯") from e

try:
    config = parse_config("config.json")
except ValueError as e:
    print(f"é”™è¯¯: {e}")
    print(f"åŸå› : {e.__cause__}")
    # å¯ä»¥è¿½æº¯åˆ°åŸå§‹å¼‚å¸¸
```

**éšå¼å¼‚å¸¸é“¾**

```python
try:
    try:
        result = 10 / 0
    except ZeroDivisionError:
        # åœ¨å¼‚å¸¸å¤„ç†ä¸­åˆå‘ç”Ÿäº†å¼‚å¸¸
        undefined_variable  # NameError
except NameError as e:
    print(f"å½“å‰å¼‚å¸¸: {e}")
    print(f"ä¹‹å‰çš„å¼‚å¸¸: {e.__context__}")
```

**æŠ‘åˆ¶å¼‚å¸¸é“¾**

```python
try:
    result = 10 / 0
except ZeroDivisionError:
    # ä½¿ç”¨from NoneæŠ‘åˆ¶å¼‚å¸¸é“¾
    raise ValueError("è®¡ç®—é”™è¯¯") from None
```

#### 1.7ã€å®ç”¨å¼‚å¸¸å¤„ç†æ¨¡å¼

**èµ„æºæ¸…ç†**

```python
# âŒ ä¸æ¨è
file = open("data.txt")
try:
    data = file.read()
    process(data)
finally:
    file.close()

# âœ… æ¨èï¼šä½¿ç”¨withè¯­å¥
with open("data.txt") as file:
    data = file.read()
    process(data)
# è‡ªåŠ¨å…³é—­æ–‡ä»¶
```

**å¤šä¸ªèµ„æº**

```python
# ç®¡ç†å¤šä¸ªèµ„æº
with open("input.txt") as infile, open("output.txt", "w") as outfile:
    data = infile.read()
    outfile.write(data.upper())
```

**EAFP vs LBYL**

Pythonæ¨å´‡EAFPï¼ˆEasier to Ask for Forgiveness than Permissionï¼Œè¯·æ±‚åŸè°…æ¯”è¯·æ±‚è®¸å¯æ›´å®¹æ˜“ï¼‰è€ŒéLBYLï¼ˆLook Before You Leapï¼Œå…ˆæ£€æŸ¥å†è¡ŒåŠ¨ï¼‰ã€‚

```python
# LBYLï¼ˆJavaé£æ ¼ï¼‰- ä¸æ¨è
if key in dictionary:
    value = dictionary[key]
else:
    value = default_value

# EAFPï¼ˆPythoné£æ ¼ï¼‰- æ¨è
try:
    value = dictionary[key]
except KeyError:
    value = default_value

# æˆ–è€…ä½¿ç”¨getæ–¹æ³•
value = dictionary.get(key, default_value)
```

**å¼‚å¸¸ä¼ æ’­ä¸æ—¥å¿—**

```python
import logging

def process_user_data(user_id):
    try:
        user = fetch_user(user_id)
        data = transform_data(user)
        save_data(data)
    except DatabaseError as e:
        logging.error(f"æ•°æ®åº“é”™è¯¯å¤„ç†ç”¨æˆ·{user_id}: {e}")
        raise  # é‡æ–°æŠ›å‡ºï¼Œè®©ä¸Šå±‚å¤„ç†
    except ValidationError as e:
        logging.warning(f"éªŒè¯å¤±è´¥ç”¨æˆ·{user_id}: {e}")
        return None  # åæ‰å¼‚å¸¸ï¼Œè¿”å›é»˜è®¤å€¼
    except Exception as e:
        logging.critical(f"æœªçŸ¥é”™è¯¯å¤„ç†ç”¨æˆ·{user_id}: {e}", exc_info=True)
        raise  # è‡´å‘½é”™è¯¯ï¼Œå¿…é¡»æŠ›å‡º
```

**å°ç»“å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | Python | Java |
|-----|--------|------|
| åŸºæœ¬è¯­æ³• | `try-except` | `try-catch` |
| å¤šå¼‚å¸¸ | `except (E1, E2)` | å¤šä¸ª`catch`å—æˆ–`\|` |
| elseå­å¥ | æ”¯æŒ | ä¸æ”¯æŒ |
| finally | æ”¯æŒ | æ”¯æŒ |
| å¼‚å¸¸é“¾ | `raise ... from` | `Throwable.initCause()` |
| æ£€æŸ¥å¼‚å¸¸ | æ—  | æœ‰ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ |
| è‡ªå®šä¹‰å¼‚å¸¸ | ç»§æ‰¿`Exception` | ç»§æ‰¿`Exception` |

Pythonçš„å¼‚å¸¸å¤„ç†æ›´ç®€æ´ï¼Œä½†ç¼ºå°‘Javaçš„æ£€æŸ¥å¼‚å¸¸æœºåˆ¶ã€‚è¿™è®©Pythonæ›´çµæ´»ï¼Œä½†ä¹Ÿéœ€è¦å¼€å‘è€…æ›´è‡ªå¾‹åœ°å¤„ç†å¼‚å¸¸ï¼

### 2ã€æ–‡ä»¶æ“ä½œä¸I/O

Pythonçš„æ–‡ä»¶æ“ä½œæ¯”Javaç®€å•ç›´è§‚å¾—å¤šï¼Œæ— éœ€å¤„ç†ç¹ççš„æµå’Œç¼“å†²åŒºã€‚

> **å‰ç½®çŸ¥è¯†**ï¼šå¼‚å¸¸å¤„ç†å·²åœ¨ç¬¬1ç« "å¼‚å¸¸å¤„ç†"ä¸­ä»‹ç»ï¼Œæœ¬ç« ä¼šå¤§é‡ä½¿ç”¨`with`è¯­å¥ã€‚

#### 2.1ã€æ–‡ä»¶æ‰“å¼€ä¸å…³é—­

**åŸºæœ¬æ“ä½œ**

```python
# æ‰“å¼€æ–‡ä»¶
file = open("data.txt", "r")  # è¯»æ¨¡å¼
content = file.read()
file.close()  # å¿…é¡»æ‰‹åŠ¨å…³é—­

# âœ… æ¨èï¼šä½¿ç”¨withè¯­å¥è‡ªåŠ¨å…³é—­
with open("data.txt", "r") as file:
    content = file.read()
# è‡ªåŠ¨å…³é—­ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šå…³é—­
```

**æ–‡ä»¶æ¨¡å¼**

| æ¨¡å¼ | è¯´æ˜ | Javaå¯¹åº” |
|-----|------|---------|
| `'r'` | åªè¯»ï¼ˆé»˜è®¤ï¼‰ | `FileReader` |
| `'w'` | å†™å…¥ï¼ˆè¦†ç›–ï¼‰ | `FileWriter` |
| `'a'` | è¿½åŠ  | `FileWriter(file, true)` |
| `'x'` | ç‹¬å åˆ›å»ºï¼ˆæ–‡ä»¶å·²å­˜åœ¨åˆ™å¤±è´¥ï¼‰ | - |
| `'b'` | äºŒè¿›åˆ¶æ¨¡å¼ | `FileInputStream` |
| `'t'` | æ–‡æœ¬æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | - |
| `'+'` | è¯»å†™æ¨¡å¼ | `RandomAccessFile` |

**å¸¸ç”¨ç»„åˆ**

```python
# æ–‡æœ¬æ–‡ä»¶
open("file.txt", "r")      # è¯»
open("file.txt", "w")      # å†™ï¼ˆè¦†ç›–ï¼‰
open("file.txt", "a")      # è¿½åŠ 
open("file.txt", "r+")     # è¯»å†™

# äºŒè¿›åˆ¶æ–‡ä»¶
open("image.png", "rb")    # è¯»äºŒè¿›åˆ¶
open("image.png", "wb")    # å†™äºŒè¿›åˆ¶
```

å¯¹æ¯”Javaï¼š

```java
// Javaéœ€è¦æ›´å¤šä»£ç 
try (BufferedReader reader = new BufferedReader(
        new FileReader("data.txt"))) {
    String content = reader.readLine();
} catch (IOException e) {
    e.printStackTrace();
}
```

#### 2.2ã€æ–‡æœ¬æ–‡ä»¶è¯»å†™

**è¯»å–æ–‡ä»¶**

```python
# æ–¹å¼1ï¼šä¸€æ¬¡æ€§è¯»å–å…¨éƒ¨å†…å®¹
with open("data.txt", "r", encoding="utf-8") as f:
    content = f.read()
    print(content)

# æ–¹å¼2ï¼šæŒ‰è¡Œè¯»å–ï¼ˆè¿”å›åˆ—è¡¨ï¼‰
with open("data.txt", "r", encoding="utf-8") as f:
    lines = f.readlines()
    for line in lines:
        print(line.strip())  # å»é™¤æ¢è¡Œç¬¦

# æ–¹å¼3ï¼šé€è¡Œè¿­ä»£ï¼ˆæ¨èï¼Œå†…å­˜å‹å¥½ï¼‰
with open("data.txt", "r", encoding="utf-8") as f:
    for line in f:
        print(line.strip())

# æ–¹å¼4ï¼šè¯»å–æŒ‡å®šå­—èŠ‚æ•°
with open("data.txt", "r") as f:
    chunk = f.read(100)  # è¯»å–å‰100ä¸ªå­—ç¬¦
```

**å†™å…¥æ–‡ä»¶**

```python
# å†™å…¥å­—ç¬¦ä¸²
with open("output.txt", "w", encoding="utf-8") as f:
    f.write("Hello, World!\n")
    f.write("ç¬¬äºŒè¡Œ\n")

# å†™å…¥å¤šè¡Œ
lines = ["ç¬¬ä¸€è¡Œ\n", "ç¬¬äºŒè¡Œ\n", "ç¬¬ä¸‰è¡Œ\n"]
with open("output.txt", "w", encoding="utf-8") as f:
    f.writelines(lines)

# è¿½åŠ å†…å®¹
with open("output.txt", "a", encoding="utf-8") as f:
    f.write("è¿½åŠ çš„å†…å®¹\n")
```

**å®ç”¨ç¤ºä¾‹**

```python
# å¤åˆ¶æ–‡ä»¶
with open("source.txt", "r") as src, open("dest.txt", "w") as dst:
    dst.write(src.read())

# å¤„ç†CSV
with open("data.csv", "r") as f:
    for line in f:
        fields = line.strip().split(",")
        print(fields)

# ç»Ÿè®¡è¡Œæ•°
with open("data.txt", "r") as f:
    line_count = sum(1 for line in f)
    print(f"æ€»è¡Œæ•°: {line_count}")

# æŸ¥æ‰¾å¹¶æ›¿æ¢
with open("input.txt", "r") as f:
    content = f.read()

content = content.replace("old", "new")

with open("output.txt", "w") as f:
    f.write(content)
```

#### 2.3ã€äºŒè¿›åˆ¶æ–‡ä»¶å¤„ç†

**è¯»å†™äºŒè¿›åˆ¶æ–‡ä»¶**

```python
# è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶
with open("image.png", "rb") as f:
    data = f.read()
    print(f"æ–‡ä»¶å¤§å°: {len(data)} å­—èŠ‚")

# å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶
with open("output.bin", "wb") as f:
    f.write(b"\x00\x01\x02\x03")

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
with open("source.png", "rb") as src, open("dest.png", "wb") as dst:
    dst.write(src.read())

# åˆ†å—è¯»å–å¤§æ–‡ä»¶ï¼ˆå†…å­˜å‹å¥½ï¼‰
with open("large_file.bin", "rb") as f:
    while chunk := f.read(8192):  # æ¯æ¬¡è¯»8KB
        process(chunk)
```

**ä½¿ç”¨structæ¨¡å—å¤„ç†äºŒè¿›åˆ¶æ•°æ®**

```python
import struct

# å†™å…¥ç»“æ„åŒ–äºŒè¿›åˆ¶æ•°æ®
with open("data.bin", "wb") as f:
    # å†™å…¥ï¼š1ä¸ªæ•´æ•°ï¼Œ1ä¸ªæµ®ç‚¹æ•°ï¼Œ5ä¸ªå­—ç¬¦
    data = struct.pack("if5s", 42, 3.14, b"hello")
    f.write(data)

# è¯»å–ç»“æ„åŒ–äºŒè¿›åˆ¶æ•°æ®
with open("data.bin", "rb") as f:
    data = f.read()
    num, pi, text = struct.unpack("if5s", data)
    print(f"æ•´æ•°: {num}, æµ®ç‚¹: {pi}, æ–‡æœ¬: {text.decode()}")
```

#### 2.4ã€pathlibæ¨¡å—ï¼ˆç°ä»£è·¯å¾„æ“ä½œï¼‰

`pathlib`æ˜¯Python 3.4+æ¨èçš„è·¯å¾„æ“ä½œæ–¹å¼ï¼Œé¢å‘å¯¹è±¡ï¼Œæ¯”`os.path`æ›´ç›´è§‚ã€‚

**åŸºæœ¬ç”¨æ³•**

```python
from pathlib import Path

# åˆ›å»ºPathå¯¹è±¡
file_path = Path("data/file.txt")
absolute_path = Path("/usr/local/bin/python")

# è·å–å½“å‰ç›®å½•
current_dir = Path.cwd()
print(current_dir)

# è·å–ç”¨æˆ·ä¸»ç›®å½•
home_dir = Path.home()
print(home_dir)

# è·¯å¾„æ‹¼æ¥
config_file = Path.home() / "config" / "settings.json"
# ç­‰åŒäºï¼šPath.home().joinpath("config", "settings.json")
```

**è·¯å¾„å±æ€§**

```python
file_path = Path("/home/user/documents/report.pdf")

print(file_path.name)        # report.pdfï¼ˆæ–‡ä»¶åï¼‰
print(file_path.stem)        # reportï¼ˆæ–‡ä»¶åä¸å«æ‰©å±•åï¼‰
print(file_path.suffix)      # .pdfï¼ˆæ‰©å±•åï¼‰
print(file_path.parent)      # /home/user/documentsï¼ˆçˆ¶ç›®å½•ï¼‰
print(file_path.parents[0])  # /home/user/documents
print(file_path.parents[1])  # /home/user
print(file_path.anchor)      # /ï¼ˆæ ¹ç›®å½•ï¼‰
print(file_path.parts)       # ('/', 'home', 'user', 'documents', 'report.pdf')
```

**æ–‡ä»¶ç³»ç»Ÿæ“ä½œ**

```python
from pathlib import Path

file_path = Path("data.txt")

# æ£€æŸ¥å­˜åœ¨æ€§
if file_path.exists():
    print("æ–‡ä»¶å­˜åœ¨")

# æ£€æŸ¥ç±»å‹
if file_path.is_file():
    print("æ˜¯æ–‡ä»¶")
if file_path.is_dir():
    print("æ˜¯ç›®å½•")

# è¯»å†™æ–‡ä»¶
file_path.write_text("Hello, World!", encoding="utf-8")
content = file_path.read_text(encoding="utf-8")

# äºŒè¿›åˆ¶è¯»å†™
file_path.write_bytes(b"\x00\x01\x02")
data = file_path.read_bytes()

# åˆ›å»ºç›®å½•
Path("new_dir").mkdir(exist_ok=True)           # åˆ›å»ºå•å±‚ç›®å½•
Path("parent/child").mkdir(parents=True, exist_ok=True)  # åˆ›å»ºå¤šå±‚

# åˆ é™¤æ–‡ä»¶
file_path.unlink(missing_ok=True)  # Python 3.8+

# éå†ç›®å½•
for item in Path(".").iterdir():
    print(item)

# æ¨¡å¼åŒ¹é…æŸ¥æ‰¾æ–‡ä»¶
for py_file in Path(".").glob("*.py"):
    print(py_file)

for py_file in Path(".").rglob("*.py"):  # é€’å½’æŸ¥æ‰¾
    print(py_file)
```

**å®ç”¨ç¤ºä¾‹**

```python
from pathlib import Path

# æŸ¥æ‰¾é¡¹ç›®ä¸­æ‰€æœ‰Pythonæ–‡ä»¶
project_root = Path(".")
python_files = list(project_root.rglob("*.py"))
print(f"æ‰¾åˆ°{len(python_files)}ä¸ªPythonæ–‡ä»¶")

# ç»Ÿè®¡ä»£ç è¡Œæ•°
total_lines = 0
for py_file in python_files:
    lines = py_file.read_text().count("\n")
    total_lines += lines
print(f"æ€»è¡Œæ•°: {total_lines}")

# å®‰å…¨åœ°å¤„ç†é…ç½®æ–‡ä»¶
config_file = Path.home() / ".myapp" / "config.json"
if not config_file.exists():
    config_file.parent.mkdir(parents=True, exist_ok=True)
    config_file.write_text('{"default": true}')
```

å¯¹æ¯”Javaï¼š

```java
// Javaä½¿ç”¨Pathå’ŒFilesï¼ˆJava 7+ï¼‰
import java.nio.file.*;

Path filePath = Paths.get("/home/user/data.txt");
String content = Files.readString(filePath);
Files.writeString(filePath, "Hello");

// éå†ç›®å½•
try (var stream = Files.list(Paths.get("."))) {
    stream.forEach(System.out::println);
}
```

#### 2.5ã€æ ‡å‡†è¾“å…¥è¾“å‡º

**è¾“å…¥**

```python
# input()ï¼šè¯»å–ä¸€è¡Œè¾“å…¥
name = input("è¯·è¾“å…¥å§“å: ")
print(f"ä½ å¥½, {name}!")

# è¯»å–æ•°å­—
age = int(input("è¯·è¾“å…¥å¹´é¾„: "))

# è¯»å–å¤šä¸ªå€¼
x, y = map(int, input("è¾“å…¥ä¸¤ä¸ªæ•°å­—(ç©ºæ ¼åˆ†éš”): ").split())
```

**è¾“å‡º**

```python
# print()ï¼šæ ‡å‡†è¾“å‡º
print("Hello, World!")

# å¤šä¸ªå‚æ•°
print("å§“å:", name, "å¹´é¾„:", age)

# è‡ªå®šä¹‰åˆ†éš”ç¬¦å’Œç»“æŸç¬¦
print("a", "b", "c", sep="-")      # a-b-c
print("loading", end="...")        # loading...ï¼ˆä¸æ¢è¡Œï¼‰
print(" done!")                    # loading... done!

# å†™å…¥æ–‡ä»¶
with open("output.txt", "w") as f:
    print("å†™å…¥æ–‡ä»¶", file=f)
```

**æ ¼å¼åŒ–è¾“å‡º**

```python
name = "å¼ ä¸‰"
age = 25
score = 95.678

# f-stringï¼ˆæ¨èï¼‰
print(f"å§“å: {name}, å¹´é¾„: {age}, æˆç»©: {score:.2f}")

# formatæ–¹æ³•
print("å§“å: {}, å¹´é¾„: {}, æˆç»©: {:.2f}".format(name, age, score))

# %æ ¼å¼åŒ–ï¼ˆè€å¼ï¼‰
print("å§“å: %s, å¹´é¾„: %d, æˆç»©: %.2f" % (name, age, score))
```

**å°ç»“å¯¹æ¯”è¡¨**

| æ“ä½œ | Python | Java |
|-----|--------|------|
| æ‰“å¼€æ–‡ä»¶ | `open()` | `FileReader`/`BufferedReader` |
| è‡ªåŠ¨å…³é—­ | `with`è¯­å¥ | try-with-resources |
| è¯»å–å…¨éƒ¨ | `read()` | `readAll()`æˆ–å¾ªç¯è¯»å– |
| é€è¡Œè¯»å– | `for line in f` | `BufferedReader.readLine()` |
| è·¯å¾„æ“ä½œ | `pathlib.Path` | `java.nio.file.Path` |
| æ–‡ä»¶å­˜åœ¨ | `path.exists()` | `Files.exists()` |
| åˆ›å»ºç›®å½• | `path.mkdir()` | `Files.createDirectories()` |

Pythonçš„æ–‡ä»¶I/Oæ“ä½œæ¯”Javaç®€æ´ä¼˜é›…å¾—å¤šï¼Œ`pathlib`æ¨¡å—æä¾›äº†ç°ä»£åŒ–çš„è·¯å¾„å¤„ç†æ–¹å¼ï¼

### 3ã€è¿­ä»£å™¨ä¸ç”Ÿæˆå™¨

è¿­ä»£å™¨å’Œç”Ÿæˆå™¨æ˜¯Pythonçš„å¼ºå¤§ç‰¹æ€§ï¼Œèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤§æ•°æ®é›†å’Œå®ç°æƒ°æ€§æ±‚å€¼ã€‚

#### 3.1ã€è¿­ä»£å™¨åè®®

Pythonçš„è¿­ä»£å™¨åŸºäºä¸¤ä¸ªé­”æœ¯æ–¹æ³•ï¼š`__iter__`å’Œ`__next__`ã€‚

**åŸºæœ¬æ¦‚å¿µ**

```python
# å¯è¿­ä»£å¯¹è±¡ï¼ˆIterableï¼‰ï¼šå®ç°äº†__iter__æ–¹æ³•
numbers = [1, 2, 3, 4, 5]
iterator = iter(numbers)  # è·å–è¿­ä»£å™¨

# è¿­ä»£å™¨ï¼ˆIteratorï¼‰ï¼šå®ç°äº†__iter__å’Œ__next__æ–¹æ³•
print(next(iterator))  # 1
print(next(iterator))  # 2
print(next(iterator))  # 3

# è¿­ä»£å®Œæ¯•åæŠ›å‡ºStopIteration
# next(iterator)  # è¿­ä»£å®Œæ¯•ä¼šæŠ›å‡ºStopIteration
```

**è‡ªå®šä¹‰è¿­ä»£å™¨**

```python
class Countdown:
    """å€’è®¡æ—¶è¿­ä»£å™¨"""
    def __init__(self, start):
        self.current = start

    def __iter__(self):
        return self

    def __next__(self):
        if self.current <= 0:
            raise StopIteration

        self.current -= 1
        return self.current + 1

# ä½¿ç”¨
for num in Countdown(5):
    print(num)  # 5, 4, 3, 2, 1
```

**å®ç”¨è¿­ä»£å™¨ç¤ºä¾‹**

```python
class FileReader:
    """é€è¡Œè¯»å–æ–‡ä»¶çš„è¿­ä»£å™¨"""
    def __init__(self, filename):
        self.file = open(filename, 'r')

    def __iter__(self):
        return self

    def __next__(self):
        line = self.file.readline()
        if not line:
            self.file.close()
            raise StopIteration
        return line.strip()

# ä½¿ç”¨
for line in FileReader("data.txt"):
    print(line)
```

å¯¹æ¯”Javaï¼š

```java
// Javaä½¿ç”¨Iteratoræ¥å£
Iterator<Integer> iterator = numbers.iterator();
while (iterator.hasNext()) {
    System.out.println(iterator.next());
}
```

#### 3.2ã€ç”Ÿæˆå™¨å‡½æ•°ï¼ˆyieldï¼‰

ç”Ÿæˆå™¨æ˜¯åˆ›å»ºè¿­ä»£å™¨çš„æœ€ç®€å•æ–¹å¼ï¼Œä½¿ç”¨`yield`å…³é”®å­—ã€‚

**åŸºæœ¬ç”¨æ³•**

```python
def countdown(n):
    """å€’è®¡æ—¶ç”Ÿæˆå™¨"""
    while n > 0:
        yield n
        n -= 1

# ä½¿ç”¨
for num in countdown(5):
    print(num)  # 5, 4, 3, 2, 1

# ç”Ÿæˆå™¨æ˜¯è¿­ä»£å™¨
gen = countdown(3)
print(next(gen))  # 3
print(next(gen))  # 2
print(next(gen))  # 1
# print(next(gen))  # StopIteration
```

**å·¥ä½œåŸç†**

```python
def simple_generator():
    print("å¼€å§‹")
    yield 1
    print("ç»§ç»­")
    yield 2
    print("ç»“æŸ")
    yield 3

gen = simple_generator()
print("åˆ›å»ºç”Ÿæˆå™¨")
print(next(gen))  # å¼€å§‹ -> 1
print(next(gen))  # ç»§ç»­ -> 2
print(next(gen))  # ç»“æŸ -> 3
```

**å®ç”¨ç¤ºä¾‹**

```python
# 1. æ–æ³¢é‚£å¥‘æ•°åˆ—
def fibonacci(n):
    """ç”Ÿæˆå‰nä¸ªæ–æ³¢é‚£å¥‘æ•°"""
    a, b = 0, 1
    count = 0
    while count < n:
        yield a
        a, b = b, a + b
        count += 1

print(list(fibonacci(10)))
# [0, 1, 1, 2, 3, 5, 8, 13, 21, 34]

# 2. é€è¡Œè¯»å–å¤§æ–‡ä»¶ï¼ˆå†…å­˜å‹å¥½ï¼‰
def read_large_file(file_path):
    """é€è¡Œè¯»å–æ–‡ä»¶"""
    with open(file_path) as f:
        for line in f:
            yield line.strip()

for line in read_large_file("huge_file.txt"):
    process(line)  # ä¸€æ¬¡åªåŠ è½½ä¸€è¡Œåˆ°å†…å­˜

# 3. æ‰¹é‡å¤„ç†æ•°æ®
def batch(items, size):
    """å°†æ•°æ®åˆ†æ‰¹"""
    batch = []
    for item in items:
        batch.append(item)
        if len(batch) == size:
            yield batch
            batch = []
    if batch:  # æœ€åä¸€æ‰¹
        yield batch

# ä½¿ç”¨
data = range(100)
for batch in batch(data, 10):
    print(f"å¤„ç†æ‰¹æ¬¡: {batch}")

# 4. æ— é™åºåˆ—
def infinite_sequence():
    """æ— é™é€’å¢åºåˆ—"""
    num = 0
    while True:
        yield num
        num += 1

gen = infinite_sequence()
print(next(gen))  # 0
print(next(gen))  # 1
print(next(gen))  # 2
```

#### 3.3ã€ç”Ÿæˆå™¨è¡¨è¾¾å¼

ç”Ÿæˆå™¨è¡¨è¾¾å¼æ˜¯åˆ—è¡¨æ¨å¯¼å¼çš„ç”Ÿæˆå™¨ç‰ˆæœ¬ï¼Œä½¿ç”¨åœ†æ‹¬å·ã€‚

> **æ³¨æ„**ï¼šåˆ—è¡¨æ¨å¯¼å¼å’Œç”Ÿæˆå™¨è¡¨è¾¾å¼çš„å®Œæ•´ç”¨æ³•ï¼Œè¯·å‚è€ƒç¬¬5ç« "æ•°æ®ç»“æ„ä¸æ¨å¯¼å¼"ã€‚

**åŸºæœ¬è¯­æ³•**

```python
# åˆ—è¡¨æ¨å¯¼å¼ï¼šç«‹å³è®¡ç®—ï¼Œå ç”¨å†…å­˜
squares_list = [x**2 for x in range(1000000)]

# ç”Ÿæˆå™¨è¡¨è¾¾å¼ï¼šæƒ°æ€§è®¡ç®—ï¼ŒèŠ‚çœå†…å­˜
squares_gen = (x**2 for x in range(1000000))

# ä½¿ç”¨
for square in squares_gen:
    if square > 100:
        break
    print(square)
```

**å¯¹æ¯”**

```python
import sys

# åˆ—è¡¨æ¨å¯¼å¼
list_comp = [x for x in range(10000)]
print(f"åˆ—è¡¨å¤§å°: {sys.getsizeof(list_comp)} bytes")  # ~87616 bytes

# ç”Ÿæˆå™¨è¡¨è¾¾å¼
gen_expr = (x for x in range(10000))
print(f"ç”Ÿæˆå™¨å¤§å°: {sys.getsizeof(gen_expr)} bytes")  # ~112 bytes
```

**å®ç”¨ç¤ºä¾‹**

```python
# 1. è¿‡æ»¤å’Œè½¬æ¢
numbers = range(1, 11)
even_squares = (x**2 for x in numbers if x % 2 == 0)
print(list(even_squares))  # [4, 16, 36, 64, 100]

# 2. é“¾å¼å¤„ç†
lines = (line.strip() for line in open("data.txt"))
non_empty = (line for line in lines if line)
uppercase = (line.upper() for line in non_empty)

for line in uppercase:
    print(line)

# 3. ä½œä¸ºå‡½æ•°å‚æ•°
sum_of_squares = sum(x**2 for x in range(10))
print(sum_of_squares)  # 285

max_value = max((x**2 for x in range(10)))
print(max_value)  # 81

# 4. å†…å­˜å‹å¥½çš„æ•°æ®å¤„ç†
total = sum(int(line) for line in open("numbers.txt"))
```

#### 3.4ã€itertoolsæ¨¡å—

`itertools`æä¾›äº†é«˜æ•ˆçš„è¿­ä»£å™¨å·¥å…·ã€‚

**æ— é™è¿­ä»£å™¨**

```python
from itertools import count, cycle, repeat

# countï¼šæ— é™è®¡æ•°
for i in count(10, 2):  # ä»10å¼€å§‹ï¼Œæ­¥é•¿2
    if i > 20:
        break
    print(i)  # 10, 12, 14, 16, 18, 20

# cycleï¼šæ— é™å¾ªç¯
counter = 0
for item in cycle(['A', 'B', 'C']):
    if counter >= 5:
        break
    print(item, end=" ")  # A B C A B
    counter += 1

# repeatï¼šé‡å¤å…ƒç´ 
for item in repeat('Hello', 3):
    print(item)  # Hello(3æ¬¡)
```

**ç»„åˆè¿­ä»£å™¨**

```python
from itertools import chain, zip_longest, product, combinations, permutations

# chainï¼šè¿æ¥å¤šä¸ªè¿­ä»£å™¨
for item in chain([1, 2], [3, 4], [5, 6]):
    print(item, end=" ")  # 1 2 3 4 5 6

# zip_longestï¼šé…å¯¹ï¼ˆè¡¥é½ï¼‰
for pair in zip_longest([1, 2, 3], ['a', 'b'], fillvalue='?'):
    print(pair)  # (1, 'a'), (2, 'b'), (3, '?')

# productï¼šç¬›å¡å°”ç§¯
for pair in product([1, 2], ['a', 'b']):
    print(pair)  # (1, 'a'), (1, 'b'), (2, 'a'), (2, 'b')

# combinationsï¼šç»„åˆ
for combo in combinations([1, 2, 3, 4], 2):
    print(combo)  # (1,2), (1,3), (1,4), (2,3), (2,4), (3,4)

# permutationsï¼šæ’åˆ—
for perm in permutations([1, 2, 3], 2):
    print(perm)  # (1,2), (1,3), (2,1), (2,3), (3,1), (3,2)
```

**è¿‡æ»¤å’Œåˆ†ç»„**

```python
from itertools import filterfalse, dropwhile, takewhile, groupby

# filterfalseï¼šè¿‡æ»¤å‡å€¼
data = [1, 0, 2, 0, 3]
non_zero = filterfalse(lambda x: x == 0, data)
print(list(non_zero))  # [1, 2, 3]

# dropwhileï¼šä¸¢å¼ƒç›´åˆ°æ¡ä»¶ä¸ºå‡
numbers = [1, 3, 5, 6, 7, 8, 9]
result = dropwhile(lambda x: x < 6, numbers)
print(list(result))  # [6, 7, 8, 9]

# takewhileï¼šè·å–ç›´åˆ°æ¡ä»¶ä¸ºå‡
result = takewhile(lambda x: x < 6, numbers)
print(list(result))  # [1, 3, 5]

# groupbyï¼šåˆ†ç»„
data = [('A', 1), ('A', 2), ('B', 3), ('B', 4), ('A', 5)]
for key, group in groupby(data, lambda x: x[0]):
    print(f"{key}: {list(group)}")
# A: [('A', 1), ('A', 2)]
# B: [('B', 3), ('B', 4)]
# A: [('A', 5)]
```

**å®ç”¨ç»„åˆ**

```python
from itertools import islice, tee, accumulate

# isliceï¼šåˆ‡ç‰‡è¿­ä»£å™¨
gen = (x**2 for x in range(100))
first_10 = list(islice(gen, 10))
print(first_10)  # [0, 1, 4, 9, 16, 25, 36, 49, 64, 81]

# teeï¼šå¤åˆ¶è¿­ä»£å™¨
gen1, gen2 = tee(range(5), 2)
print(list(gen1))  # [0, 1, 2, 3, 4]
print(list(gen2))  # [0, 1, 2, 3, 4]

# accumulateï¼šç´¯ç§¯
from operator import mul
numbers = [1, 2, 3, 4, 5]
print(list(accumulate(numbers)))        # [1, 3, 6, 10, 15]ï¼ˆç´¯åŠ ï¼‰
print(list(accumulate(numbers, mul)))   # [1, 2, 6, 24, 120]ï¼ˆç´¯ä¹˜ï¼‰
```

#### 3.5ã€æƒ°æ€§æ±‚å€¼ä¼˜åŠ¿

ç”Ÿæˆå™¨çš„æƒ°æ€§æ±‚å€¼ç‰¹æ€§å¸¦æ¥å·¨å¤§ä¼˜åŠ¿ã€‚

**å†…å­˜æ•ˆç‡**

```python
# âŒ åˆ—è¡¨ï¼šç«‹å³è®¡ç®—ï¼Œå ç”¨å¤§é‡å†…å­˜
def process_data_list():
    data = [expensive_operation(x) for x in range(1000000)]
    return sum(data)

# âœ… ç”Ÿæˆå™¨ï¼šæƒ°æ€§è®¡ç®—ï¼Œå†…å­˜å ç”¨å°
def process_data_generator():
    data = (expensive_operation(x) for x in range(1000000))
    return sum(data)
```

**æ— é™åºåˆ—**

```python
# ç”Ÿæˆå™¨å¯ä»¥è¡¨ç¤ºæ— é™åºåˆ—
def primes():
    """æ— é™ç´ æ•°ç”Ÿæˆå™¨"""
    yield 2
    candidates = count(3, 2)
    while True:
        prime = next(candidates)
        yield prime
        candidates = (x for x in candidates if x % prime != 0)

# å–å‰10ä¸ªç´ æ•°
prime_gen = primes()
first_10_primes = [next(prime_gen) for _ in range(10)]
print(first_10_primes)  # [2, 3, 5, 7, 11, 13, 17, 19, 23, 29]
```

**ç®¡é“å¼å¤„ç†**

```python
# æ•°æ®å¤„ç†ç®¡é“
def read_log(filename):
    """è¯»å–æ—¥å¿—"""
    with open(filename) as f:
        for line in f:
            yield line.strip()

def filter_errors(lines):
    """è¿‡æ»¤é”™è¯¯"""
    for line in lines:
        if 'ERROR' in line:
            yield line

def parse_timestamp(lines):
    """è§£ææ—¶é—´æˆ³"""
    for line in lines:
        # å‡è®¾æ ¼å¼ï¼š[2024-01-01 10:00:00] ERROR: message
        yield line.split(']')[0][1:]

# ç®¡é“ç»„åˆ
lines = read_log("app.log")
errors = filter_errors(lines)
timestamps = parse_timestamp(errors)

# æƒ°æ€§æ‰§è¡Œï¼Œåªåœ¨éœ€è¦æ—¶å¤„ç†
for ts in timestamps:
    print(ts)
```

**å°ç»“å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | åˆ—è¡¨ | ç”Ÿæˆå™¨ | Java Stream |
|-----|------|--------|------------|
| æ±‚å€¼æ–¹å¼ | ç«‹å³ | æƒ°æ€§ | æƒ°æ€§ |
| å†…å­˜å ç”¨ | å¤§ | å° | å° |
| å¯é‡å¤ä½¿ç”¨ | âœ… | âŒ | âŒ |
| ç´¢å¼•è®¿é—® | âœ… | âŒ | âŒ |
| é•¿åº¦è·å– | âœ… | âŒ | âŒ |
| æ— é™åºåˆ— | âŒ | âœ… | âœ… |

### 4ã€è£…é¥°å™¨

è£…é¥°å™¨æ˜¯Pythonçš„å¼ºå¤§ç‰¹æ€§ï¼Œå…è®¸åœ¨ä¸ä¿®æ”¹åŸå‡½æ•°/ç±»çš„æƒ…å†µä¸‹å¢å¼ºå…¶åŠŸèƒ½ã€‚è¿™ç±»ä¼¼äºJavaçš„æ³¨è§£+AOPï¼Œä½†æ›´çµæ´»å¼ºå¤§ã€‚

> **å‰ç½®çŸ¥è¯†**ï¼šè£…é¥°å™¨åŸºäºé—­åŒ…æ¦‚å¿µï¼Œé—­åŒ…å·²åœ¨ç¬¬6ç« "å‡½æ•°å®šä¹‰ä¸ä½¿ç”¨"ä¸­ä»‹ç»ã€‚

#### 4.1ã€å‡½æ•°è£…é¥°å™¨åŸºç¡€

**åŸºæœ¬æ¦‚å¿µ**

è£…é¥°å™¨æœ¬è´¨æ˜¯ä¸€ä¸ªæ¥å—å‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›æ–°å‡½æ•°çš„é«˜é˜¶å‡½æ•°ã€‚

```python
# æœ€ç®€å•çš„è£…é¥°å™¨
def my_decorator(func):
    """è£…é¥°å™¨å‡½æ•°"""
    def wrapper():
        print("å‡½æ•°æ‰§è¡Œå‰")
        func()
        print("å‡½æ•°æ‰§è¡Œå")
    return wrapper

# ä½¿ç”¨è£…é¥°å™¨ï¼ˆæ–¹å¼1ï¼šæ‰‹åŠ¨åŒ…è£…ï¼‰
def say_hello():
    print("Hello!")

say_hello = my_decorator(say_hello)
say_hello()
# è¾“å‡º:
# å‡½æ•°æ‰§è¡Œå‰
# Hello!
# å‡½æ•°æ‰§è¡Œå

# ä½¿ç”¨è£…é¥°å™¨ï¼ˆæ–¹å¼2ï¼š@è¯­æ³•ç³–ï¼‰
@my_decorator
def say_world():
    print("World!")

say_world()
# è¾“å‡º:
# å‡½æ•°æ‰§è¡Œå‰
# World!
# å‡½æ•°æ‰§è¡Œå
```

**å¸¦å‚æ•°çš„å‡½æ•°è£…é¥°**

```python
def my_decorator(func):
    def wrapper(*args, **kwargs):
        """æ¥å—ä»»æ„å‚æ•°"""
        print(f"è°ƒç”¨ {func.__name__}ï¼Œå‚æ•°: {args}, {kwargs}")
        result = func(*args, **kwargs)
        print(f"è¿”å›å€¼: {result}")
        return result
    return wrapper

@my_decorator
def add(a, b):
    return a + b

@my_decorator
def greet(name, greeting="Hello"):
    return f"{greeting}, {name}!"

# ä½¿ç”¨
result = add(3, 5)
# è°ƒç”¨ addï¼Œå‚æ•°: (3, 5), {}
# è¿”å›å€¼: 8

message = greet("å¼ ä¸‰", greeting="ä½ å¥½")
# è°ƒç”¨ greetï¼Œå‚æ•°: ('å¼ ä¸‰',), {'greeting': 'ä½ å¥½'}
# è¿”å›å€¼: ä½ å¥½, å¼ ä¸‰!
```

å¯¹æ¯”Javaï¼š

```java
// Javaéœ€è¦ä½¿ç”¨æ³¨è§£+AOPæˆ–ä»£ç†æ¨¡å¼
@Around("@annotation(LogExecution)")
public Object logExecution(ProceedingJoinPoint joinPoint) throws Throwable {
    System.out.println("æ–¹æ³•æ‰§è¡Œå‰");
    Object result = joinPoint.proceed();
    System.out.println("æ–¹æ³•æ‰§è¡Œå");
    return result;
}

@LogExecution
public void sayHello() {
    System.out.println("Hello!");
}
```

#### 4.2ã€functools.wrapsä¿ç•™å…ƒä¿¡æ¯

è£…é¥°å™¨ä¼šæ”¹å˜å‡½æ•°çš„å…ƒä¿¡æ¯ï¼Œ`functools.wraps`ç”¨äºä¿ç•™åŸå‡½æ•°çš„å…ƒæ•°æ®ã€‚

```python
from functools import wraps

# âŒ ä¸ä½¿ç”¨wraps
def bad_decorator(func):
    def wrapper(*args, **kwargs):
        """è¿™æ˜¯wrapperçš„æ–‡æ¡£"""
        return func(*args, **kwargs)
    return wrapper

@bad_decorator
def my_function():
    """è¿™æ˜¯my_functionçš„æ–‡æ¡£"""
    pass

print(my_function.__name__)  # wrapperï¼ˆé”™è¯¯ï¼ï¼‰
print(my_function.__doc__)   # è¿™æ˜¯wrapperçš„æ–‡æ¡£ï¼ˆé”™è¯¯ï¼ï¼‰

# âœ… ä½¿ç”¨wraps
def good_decorator(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        """è¿™æ˜¯wrapperçš„æ–‡æ¡£"""
        return func(*args, **kwargs)
    return wrapper

@good_decorator
def my_function2():
    """è¿™æ˜¯my_function2çš„æ–‡æ¡£"""
    pass

print(my_function2.__name__)  # my_function2ï¼ˆæ­£ç¡®ï¼ï¼‰
print(my_function2.__doc__)   # è¿™æ˜¯my_function2çš„æ–‡æ¡£ï¼ˆæ­£ç¡®ï¼ï¼‰
```

**æ ‡å‡†è£…é¥°å™¨æ¨¡æ¿**

```python
from functools import wraps

def my_decorator(func):
    """æ ‡å‡†è£…é¥°å™¨æ¨¡æ¿"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        # æ‰§è¡Œå‰çš„é€»è¾‘
        print(f"Before calling {func.__name__}")

        # è°ƒç”¨åŸå‡½æ•°
        result = func(*args, **kwargs)

        # æ‰§è¡Œåçš„é€»è¾‘
        print(f"After calling {func.__name__}")

        return result
    return wrapper
```

#### 4.3ã€å¸¦å‚æ•°çš„è£…é¥°å™¨

è£…é¥°å™¨æœ¬èº«ä¹Ÿå¯ä»¥æ¥å—å‚æ•°ã€‚

```python
from functools import wraps

def repeat(times):
    """é‡å¤æ‰§è¡Œè£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for i in range(times):
                print(f"ç¬¬{i+1}æ¬¡æ‰§è¡Œ:")
                result = func(*args, **kwargs)
            return result
        return wrapper
    return decorator

@repeat(3)
def greet(name):
    print(f"Hello, {name}!")

greet("å¼ ä¸‰")
# è¾“å‡º:
# ç¬¬1æ¬¡æ‰§è¡Œ:
# Hello, å¼ ä¸‰!
# ç¬¬2æ¬¡æ‰§è¡Œ:
# Hello, å¼ ä¸‰!
# ç¬¬3æ¬¡æ‰§è¡Œ:
# Hello, å¼ ä¸‰!
```

**å·¥ä½œåŸç†**

```python
# @repeat(3) ç­‰ä»·äº:
# greet = repeat(3)(greet)

# åˆ†æ­¥ç†è§£:
decorator = repeat(3)      # è°ƒç”¨repeat(3)ï¼Œè¿”å›decoratorå‡½æ•°
greet = decorator(greet)   # è°ƒç”¨decorator(greet)ï¼Œè¿”å›wrapper
```

**å®ç”¨å¸¦å‚æ•°è£…é¥°å™¨ç¤ºä¾‹**

```python
from functools import wraps
import time

def retry(max_attempts=3, delay=1):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_attempts - 1:
                        raise e
                    print(f"ç¬¬{attempt + 1}æ¬¡å°è¯•å¤±è´¥ï¼Œ{delay}ç§’åé‡è¯•...")
                    time.sleep(delay)
        return wrapper
    return decorator

@retry(max_attempts=5, delay=2)
def unstable_api_call():
    """ä¸ç¨³å®šçš„APIè°ƒç”¨"""
    import random
    if random.random() < 0.7:
        raise ConnectionError("APIè°ƒç”¨å¤±è´¥")
    return "æˆåŠŸ"

# ä½¿ç”¨
result = unstable_api_call()
```

#### 4.4ã€ç±»è£…é¥°å™¨

ç±»ä¹Ÿå¯ä»¥ä½œä¸ºè£…é¥°å™¨ï¼Œé€šè¿‡å®ç°`__call__`æ–¹æ³•ã€‚

```python
from functools import wraps

class CountCalls:
    """ç»Ÿè®¡å‡½æ•°è°ƒç”¨æ¬¡æ•°"""
    def __init__(self, func):
        wraps(func)(self)
        self.func = func
        self.count = 0

    def __call__(self, *args, **kwargs):
        self.count += 1
        print(f"{self.func.__name__} å·²è¢«è°ƒç”¨ {self.count} æ¬¡")
        return self.func(*args, **kwargs)

@CountCalls
def say_hello():
    print("Hello!")

say_hello()  # say_hello å·²è¢«è°ƒç”¨ 1 æ¬¡ -> Hello!
say_hello()  # say_hello å·²è¢«è°ƒç”¨ 2 æ¬¡ -> Hello!
say_hello()  # say_hello å·²è¢«è°ƒç”¨ 3 æ¬¡ -> Hello!

print(say_hello.count)  # 3
```

**å¸¦å‚æ•°çš„ç±»è£…é¥°å™¨**

```python
from functools import wraps

class LogWith:
    """å¸¦æ—¥å¿—çº§åˆ«çš„è£…é¥°å™¨"""
    def __init__(self, level="INFO"):
        self.level = level

    def __call__(self, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            print(f"[{self.level}] è°ƒç”¨ {func.__name__}")
            result = func(*args, **kwargs)
            print(f"[{self.level}] {func.__name__} è¿”å› {result}")
            return result
        return wrapper

@LogWith(level="DEBUG")
def add(a, b):
    return a + b

result = add(3, 5)
# [DEBUG] è°ƒç”¨ add
# [DEBUG] add è¿”å› 8
```

#### 4.5ã€è£…é¥°å™¨å åŠ 

å¤šä¸ªè£…é¥°å™¨å¯ä»¥å åŠ ä½¿ç”¨ã€‚

```python
def make_bold(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        return "<b>" + func(*args, **kwargs) + "</b>"
    return wrapper

def make_italic(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        return "<i>" + func(*args, **kwargs) + "</i>"
    return wrapper

@make_bold
@make_italic
def say_hello():
    return "Hello!"

print(say_hello())  # <b><i>Hello!</i></b>

# ç­‰ä»·äº:
# say_hello = make_bold(make_italic(say_hello))
# æ‰§è¡Œé¡ºåºï¼šä»ä¸‹åˆ°ä¸Šè£…é¥°ï¼Œä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ
```

**é¡ºåºç†è§£**

```python
def decorator1(func):
    print(f"è£…é¥°å™¨1 è£…é¥° {func.__name__}")
    @wraps(func)
    def wrapper(*args, **kwargs):
        print("è£…é¥°å™¨1: æ‰§è¡Œå‰")
        result = func(*args, **kwargs)
        print("è£…é¥°å™¨1: æ‰§è¡Œå")
        return result
    return wrapper

def decorator2(func):
    print(f"è£…é¥°å™¨2 è£…é¥° {func.__name__}")
    @wraps(func)
    def wrapper(*args, **kwargs):
        print("è£…é¥°å™¨2: æ‰§è¡Œå‰")
        result = func(*args, **kwargs)
        print("è£…é¥°å™¨2: æ‰§è¡Œå")
        return result
    return wrapper

@decorator1
@decorator2
def test():
    print("æ‰§è¡Œtestå‡½æ•°")

# è£…é¥°é˜¶æ®µè¾“å‡º:
# è£…é¥°å™¨2 è£…é¥° test
# è£…é¥°å™¨1 è£…é¥° wrapper

test()
# æ‰§è¡Œé˜¶æ®µè¾“å‡º:
# è£…é¥°å™¨1: æ‰§è¡Œå‰
# è£…é¥°å™¨2: æ‰§è¡Œå‰
# æ‰§è¡Œtestå‡½æ•°
# è£…é¥°å™¨2: æ‰§è¡Œå
# è£…é¥°å™¨1: æ‰§è¡Œå
```

#### 4.6ã€å¸¸ç”¨å†…ç½®è£…é¥°å™¨

Pythonæä¾›äº†ä¸€äº›å¸¸ç”¨çš„å†…ç½®è£…é¥°å™¨ã€‚

**@propertyï¼ˆå±æ€§è£…é¥°å™¨ï¼‰**

> **è¯¦ç»†å†…å®¹**ï¼špropertyè£…é¥°å™¨çš„å®Œæ•´ç”¨æ³•å·²åœ¨ç¬¬3ç« "é¢å‘å¯¹è±¡ç¼–ç¨‹"ä¸­è¯¦ç»†ä»‹ç»ã€‚

```python
class Circle:
    def __init__(self, radius):
        self._radius = radius

    @property
    def radius(self):
        """åŠå¾„ï¼ˆåªè¯»ï¼‰"""
        return self._radius

    @property
    def area(self):
        """é¢ç§¯ï¼ˆè®¡ç®—å±æ€§ï¼‰"""
        return 3.14159 * self._radius ** 2

    @area.setter
    def area(self, value):
        """é€šè¿‡é¢ç§¯åæ¨åŠå¾„"""
        self._radius = (value / 3.14159) ** 0.5

circle = Circle(5)
print(circle.area)    # 78.53975
circle.area = 100
print(circle.radius)  # 5.641895835477563
```

**@staticmethodï¼ˆé™æ€æ–¹æ³•ï¼‰**

```python
class MathUtils:
    @staticmethod
    def add(a, b):
        """é™æ€æ–¹æ³•ï¼Œä¸éœ€è¦è®¿é—®ç±»æˆ–å®ä¾‹"""
        return a + b

    @staticmethod
    def is_even(n):
        return n % 2 == 0

# ä½¿ç”¨
print(MathUtils.add(3, 5))      # 8
print(MathUtils.is_even(4))     # True
```

**@classmethodï¼ˆç±»æ–¹æ³•ï¼‰**

```python
class Date:
    def __init__(self, year, month, day):
        self.year = year
        self.month = month
        self.day = day

    @classmethod
    def from_string(cls, date_string):
        """å·¥å‚æ–¹æ³•ï¼šä»å­—ç¬¦ä¸²åˆ›å»º"""
        year, month, day = map(int, date_string.split('-'))
        return cls(year, month, day)

    @classmethod
    def today(cls):
        """å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºä»Šå¤©çš„æ—¥æœŸ"""
        import datetime
        now = datetime.date.today()
        return cls(now.year, now.month, now.day)

# ä½¿ç”¨
date1 = Date.from_string("2024-10-26")
date2 = Date.today()
```

**@cached_propertyï¼ˆç¼“å­˜å±æ€§ï¼‰**

```python
from functools import cached_property

class DataProcessor:
    def __init__(self, data):
        self.data = data

    @cached_property
    def processed_data(self):
        """è®¡ç®—é‡å¤§çš„å±æ€§ï¼Œåªè®¡ç®—ä¸€æ¬¡"""
        print("å¤„ç†æ•°æ®ä¸­...")
        import time
        time.sleep(2)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        return [x * 2 for x in self.data]

processor = DataProcessor([1, 2, 3, 4, 5])
print(processor.processed_data)  # å¤„ç†æ•°æ®ä¸­... [2, 4, 6, 8, 10]
print(processor.processed_data)  # [2, 4, 6, 8, 10]ï¼ˆç›´æ¥è¿”å›ç¼“å­˜ï¼‰
```

#### 4.7ã€è£…é¥°å™¨å®æˆ˜æ¡ˆä¾‹

**æ¡ˆä¾‹1ï¼šæ€§èƒ½è®¡æ—¶å™¨**

```python
from functools import wraps
import time

def timer(func):
    """æµ‹é‡å‡½æ•°æ‰§è¡Œæ—¶é—´"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {end - start:.4f}ç§’")
        return result
    return wrapper

@timer
def slow_function():
    time.sleep(1)
    return "å®Œæˆ"

result = slow_function()
# slow_function æ‰§è¡Œæ—¶é—´: 1.0012ç§’
```

**æ¡ˆä¾‹2ï¼šæƒé™æ£€æŸ¥**

```python
from functools import wraps

def require_auth(func):
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        # å‡è®¾æœ‰ä¸€ä¸ªå…¨å±€çš„å½“å‰ç”¨æˆ·å¯¹è±¡
        if not hasattr(wrapper, 'current_user') or not wrapper.current_user:
            raise PermissionError("éœ€è¦ç™»å½•")
        return func(*args, **kwargs)
    return wrapper

def require_role(role):
    """æ£€æŸ¥ç”¨æˆ·è§’è‰²"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            if not hasattr(wrapper, 'current_user'):
                raise PermissionError("éœ€è¦ç™»å½•")
            if wrapper.current_user.get('role') != role:
                raise PermissionError(f"éœ€è¦{role}æƒé™")
            return func(*args, **kwargs)
        return wrapper
    return decorator

@require_auth
def view_profile():
    return "ä¸ªäººèµ„æ–™"

@require_role('admin')
def delete_user(user_id):
    return f"åˆ é™¤ç”¨æˆ· {user_id}"

# è®¾ç½®å½“å‰ç”¨æˆ·
view_profile.current_user = {"username": "å¼ ä¸‰", "role": "user"}
delete_user.current_user = {"username": "ç®¡ç†å‘˜", "role": "admin"}

print(view_profile())      # ä¸ªäººèµ„æ–™
print(delete_user(123))    # åˆ é™¤ç”¨æˆ· 123
```

**æ¡ˆä¾‹3ï¼šç¼“å­˜/è®°å¿†åŒ–**

```python
from functools import wraps

def memoize(func):
    """ç¼“å­˜å‡½æ•°ç»“æœ"""
    cache = {}

    @wraps(func)
    def wrapper(*args):
        if args not in cache:
            print(f"è®¡ç®— {func.__name__}{args}")
            cache[args] = func(*args)
        else:
            print(f"ä»ç¼“å­˜è·å– {args}")
        return cache[args]

    # æ·»åŠ æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•
    wrapper.cache = cache
    wrapper.clear_cache = lambda: cache.clear()

    return wrapper

@memoize
def fibonacci(n):
    if n < 2:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

print(fibonacci(10))
# è®¡ç®— fibonacci(10)
# è®¡ç®— fibonacci(9)
# ...
# 55

print(fibonacci(10))  # ä»ç¼“å­˜è·å– (10)
print(fibonacci.cache)  # æŸ¥çœ‹ç¼“å­˜å†…å®¹
fibonacci.clear_cache()  # æ¸…é™¤ç¼“å­˜
```

**æ¡ˆä¾‹4ï¼šè¾“å…¥éªŒè¯**

```python
from functools import wraps

def validate_types(**type_hints):
    """éªŒè¯å‡½æ•°å‚æ•°ç±»å‹"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # è·å–å‡½æ•°ç­¾å
            import inspect
            sig = inspect.signature(func)
            bound = sig.bind(*args, **kwargs)
            bound.apply_defaults()

            # éªŒè¯ç±»å‹
            for param_name, expected_type in type_hints.items():
                if param_name in bound.arguments:
                    value = bound.arguments[param_name]
                    if not isinstance(value, expected_type):
                        raise TypeError(
                            f"{param_name} åº”ä¸º {expected_type.__name__}ï¼Œ"
                            f"å®é™…ä¸º {type(value).__name__}"
                        )

            return func(*args, **kwargs)
        return wrapper
    return decorator

@validate_types(name=str, age=int, salary=float)
def create_employee(name, age, salary):
    return f"{name}, {age}å², è–ªèµ„{salary}"

# æ­£ç¡®è°ƒç”¨
print(create_employee("å¼ ä¸‰", 25, 5000.0))

# é”™è¯¯è°ƒç”¨
try:
    create_employee("æå››", "30", 6000.0)  # ageç±»å‹é”™è¯¯
except TypeError as e:
    print(e)  # age åº”ä¸º intï¼Œå®é™…ä¸º str
```

**æ¡ˆä¾‹5ï¼šæ—¥å¿—è®°å½•**

```python
from functools import wraps
import logging

logging.basicConfig(level=logging.INFO)

def log_calls(log_args=True, log_result=True):
    """è®°å½•å‡½æ•°è°ƒç”¨æ—¥å¿—"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            logger = logging.getLogger(func.__module__)

            # è®°å½•è°ƒç”¨
            if log_args:
                logger.info(f"è°ƒç”¨ {func.__name__}ï¼Œå‚æ•°: {args}, {kwargs}")
            else:
                logger.info(f"è°ƒç”¨ {func.__name__}")

            try:
                result = func(*args, **kwargs)

                # è®°å½•ç»“æœ
                if log_result:
                    logger.info(f"{func.__name__} è¿”å›: {result}")

                return result
            except Exception as e:
                logger.error(f"{func.__name__} æŠ›å‡ºå¼‚å¸¸: {e}")
                raise

        return wrapper
    return decorator

@log_calls(log_args=True, log_result=True)
def divide(a, b):
    return a / b

result = divide(10, 2)
# INFO:__main__:è°ƒç”¨ divideï¼Œå‚æ•°: (10, 2), {}
# INFO:__main__:divide è¿”å›: 5.0

try:
    divide(10, 0)
except ZeroDivisionError:
    pass
# INFO:__main__:è°ƒç”¨ divideï¼Œå‚æ•°: (10, 0), {}
# ERROR:__main__:divide æŠ›å‡ºå¼‚å¸¸: division by zero
```

**æ¡ˆä¾‹6ï¼šå•ä¾‹æ¨¡å¼**

```python
from functools import wraps

def singleton(cls):
    """å•ä¾‹è£…é¥°å™¨"""
    instances = {}

    @wraps(cls)
    def get_instance(*args, **kwargs):
        if cls not in instances:
            instances[cls] = cls(*args, **kwargs)
        return instances[cls]

    return get_instance

@singleton
class DatabaseConnection:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        print(f"è¿æ¥åˆ°æ•°æ®åº“ {host}:{port}")

# ä½¿ç”¨
db1 = DatabaseConnection("localhost", 5432)
# è¿æ¥åˆ°æ•°æ®åº“ localhost:5432

db2 = DatabaseConnection("localhost", 5432)
# ï¼ˆä¸ä¼šæ‰“å°ï¼Œå› ä¸ºè¿”å›çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼‰

print(db1 is db2)  # True
```

**å°ç»“å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | Pythonè£…é¥°å™¨ | Javaæ³¨è§£+AOP |
|-----|------------|-------------|
| è¯­æ³• | `@decorator` | `@Annotation` |
| çµæ´»æ€§ | é«˜ï¼ˆè¿è¡Œæ—¶ä¿®æ”¹è¡Œä¸ºï¼‰ | ä¸­ï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰ |
| åµŒå¥— | æ”¯æŒå¤šå±‚è£…é¥° | æ”¯æŒ |
| å¸¦å‚æ•° | æ”¯æŒ | æ”¯æŒ |
| ç±»è£…é¥° | æ”¯æŒè£…é¥°ç±» | ä¸»è¦ç”¨äºæ–¹æ³• |
| å†…çœ | å®¹æ˜“ï¼ˆ`__wrapped__`ï¼‰ | éœ€è¦åå°„ |

Pythonçš„è£…é¥°å™¨æ¯”Javaçš„æ³¨è§£æ›´çµæ´»å¼ºå¤§ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹å‡½æ•°/ç±»çš„è¡Œä¸ºï¼Œè€Œä¸”è¯­æ³•æ›´ç®€æ´ï¼

### 5ã€ä¸Šä¸‹æ–‡ç®¡ç†å™¨

ä¸Šä¸‹æ–‡ç®¡ç†å™¨è®©èµ„æºç®¡ç†å˜å¾—ä¼˜é›…å®‰å…¨ï¼Œè‡ªåŠ¨å¤„ç†èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚è¿™ç±»ä¼¼äºJavaçš„try-with-resourcesï¼Œä½†æ›´çµæ´»ã€‚

#### 5.1ã€withè¯­å¥åŸç†

**åŸºæœ¬æ¦‚å¿µ**

`with`è¯­å¥ç¡®ä¿èµ„æºåœ¨ä½¿ç”¨åè¢«æ­£ç¡®æ¸…ç†ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿèƒ½ä¿è¯ã€‚

```python
# ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†
file = open("data.txt", "r")
try:
    content = file.read()
    process(content)
finally:
    file.close()  # å¿…é¡»æ‰‹åŠ¨å…³é—­

# withè¯­å¥ï¼šè‡ªåŠ¨ç®¡ç†
with open("data.txt", "r") as file:
    content = file.read()
    process(content)
# è‡ªåŠ¨å…³é—­æ–‡ä»¶ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸
```

å¯¹æ¯”Javaï¼š

```java
// Java try-with-resourcesï¼ˆJava 7+ï¼‰
try (BufferedReader reader = new BufferedReader(new FileReader("data.txt"))) {
    String content = reader.readLine();
    process(content);
} // è‡ªåŠ¨å…³é—­èµ„æº
```

**ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®**

ä¸Šä¸‹æ–‡ç®¡ç†å™¨éœ€è¦å®ç°`__enter__`å’Œ`__exit__`æ–¹æ³•ï¼š

```python
class MyContextManager:
    def __enter__(self):
        """è¿›å…¥withå—æ—¶è°ƒç”¨"""
        print("è¿›å…¥ä¸Šä¸‹æ–‡")
        return self  # è¿”å›å€¼èµ‹ç»™asåçš„å˜é‡

    def __exit__(self, exc_type, exc_value, traceback):
        """é€€å‡ºwithå—æ—¶è°ƒç”¨"""
        print("é€€å‡ºä¸Šä¸‹æ–‡")
        if exc_type is not None:
            print(f"å‘ç”Ÿå¼‚å¸¸: {exc_type.__name__}: {exc_value}")
        return False  # Falseè¡¨ç¤ºä¸æŠ‘åˆ¶å¼‚å¸¸

# ä½¿ç”¨
with MyContextManager() as cm:
    print("æ‰§è¡Œä»£ç ")
    # raise ValueError("æµ‹è¯•å¼‚å¸¸")

# è¾“å‡º:
# è¿›å…¥ä¸Šä¸‹æ–‡
# æ‰§è¡Œä»£ç 
# é€€å‡ºä¸Šä¸‹æ–‡
```

**`__exit__`æ–¹æ³•å‚æ•°è¯´æ˜**

```python
def __exit__(self, exc_type, exc_value, traceback):
    """
    exc_type: å¼‚å¸¸ç±»å‹ï¼ˆå¦‚æœæ²¡æœ‰å¼‚å¸¸åˆ™ä¸ºNoneï¼‰
    exc_value: å¼‚å¸¸å®ä¾‹ï¼ˆå¦‚æœæ²¡æœ‰å¼‚å¸¸åˆ™ä¸ºNoneï¼‰
    traceback: å¼‚å¸¸å †æ ˆï¼ˆå¦‚æœæ²¡æœ‰å¼‚å¸¸åˆ™ä¸ºNoneï¼‰

    è¿”å›å€¼:
    - Falseæˆ–None: å¼‚å¸¸ç»§ç»­ä¼ æ’­
    - True: æŠ‘åˆ¶å¼‚å¸¸ï¼ˆå¼‚å¸¸è¢«åæ‰ï¼‰
    """
    pass
```

#### 5.2ã€è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨

**æ–‡ä»¶æ“ä½œç®¡ç†å™¨**

```python
class FileManager:
    """æ–‡ä»¶ç®¡ç†å™¨"""
    def __init__(self, filename, mode):
        self.filename = filename
        self.mode = mode
        self.file = None

    def __enter__(self):
        """æ‰“å¼€æ–‡ä»¶"""
        print(f"æ‰“å¼€æ–‡ä»¶: {self.filename}")
        self.file = open(self.filename, self.mode)
        return self.file

    def __exit__(self, exc_type, exc_value, traceback):
        """å…³é—­æ–‡ä»¶"""
        if self.file:
            print(f"å…³é—­æ–‡ä»¶: {self.filename}")
            self.file.close()
        return False

# ä½¿ç”¨
with FileManager("test.txt", "w") as f:
    f.write("Hello, World!")
# è¾“å‡º:
# æ‰“å¼€æ–‡ä»¶: test.txt
# å…³é—­æ–‡ä»¶: test.txt
```

**æ•°æ®åº“è¿æ¥ç®¡ç†å™¨**

```python
class DatabaseConnection:
    """æ•°æ®åº“è¿æ¥ç®¡ç†å™¨"""
    def __init__(self, host, database):
        self.host = host
        self.database = database
        self.connection = None

    def __enter__(self):
        """å»ºç«‹è¿æ¥"""
        print(f"è¿æ¥æ•°æ®åº“: {self.host}/{self.database}")
        # è¿™é‡Œæ¨¡æ‹Ÿè¿æ¥
        self.connection = f"Connection({self.host}, {self.database})"
        return self.connection

    def __exit__(self, exc_type, exc_value, traceback):
        """å…³é—­è¿æ¥"""
        print("å…³é—­æ•°æ®åº“è¿æ¥")
        self.connection = None

        # å¦‚æœæœ‰å¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
        if exc_type is not None:
            print("å‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡")
        else:
            print("æäº¤äº‹åŠ¡")

        return False

# ä½¿ç”¨
with DatabaseConnection("localhost", "mydb") as conn:
    print(f"ä½¿ç”¨è¿æ¥: {conn}")
    # æ‰§è¡Œæ•°æ®åº“æ“ä½œ
```

**è®¡æ—¶å™¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨**

```python
import time

class Timer:
    """è®¡æ—¶å™¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    def __init__(self, name="ä»£ç å—"):
        self.name = name
        self.start_time = None

    def __enter__(self):
        self.start_time = time.time()
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        elapsed = time.time() - self.start_time
        print(f"{self.name} æ‰§è¡Œæ—¶é—´: {elapsed:.4f}ç§’")
        return False

# ä½¿ç”¨
with Timer("æ•°æ®å¤„ç†"):
    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    time.sleep(1)
    result = sum(range(1000000))

# è¾“å‡º: æ•°æ®å¤„ç† æ‰§è¡Œæ—¶é—´: 1.xxxxç§’
```

**å¼‚å¸¸å¤„ç†ä¸Šä¸‹æ–‡ç®¡ç†å™¨**

```python
class IgnoreException:
    """å¿½ç•¥ç‰¹å®šå¼‚å¸¸"""
    def __init__(self, *exceptions):
        self.exceptions = exceptions

    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        # å¦‚æœå¼‚å¸¸ç±»å‹åœ¨æŒ‡å®šåˆ—è¡¨ä¸­ï¼ŒæŠ‘åˆ¶å¼‚å¸¸
        if exc_type is not None and issubclass(exc_type, self.exceptions):
            print(f"å¿½ç•¥å¼‚å¸¸: {exc_type.__name__}: {exc_value}")
            return True  # æŠ‘åˆ¶å¼‚å¸¸
        return False

# ä½¿ç”¨
with IgnoreException(ValueError, KeyError):
    data = {"a": 1}
    value = data["b"]  # KeyErrorï¼Œä½†ä¼šè¢«å¿½ç•¥
    print("ç»§ç»­æ‰§è¡Œ")  # è¿™è¡Œä¸ä¼šæ‰§è¡Œ

print("ç¨‹åºç»§ç»­")  # è¿™è¡Œä¼šæ‰§è¡Œ
# è¾“å‡º:
# å¿½ç•¥å¼‚å¸¸: KeyError: 'b'
# ç¨‹åºç»§ç»­
```

#### 5.3ã€contextlibæ¨¡å—

`contextlib`æ¨¡å—æä¾›äº†åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä¾¿æ·å·¥å…·ã€‚

**@contextmanagerè£…é¥°å™¨**

ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š

```python
from contextlib import contextmanager

@contextmanager
def file_manager(filename, mode):
    """ä½¿ç”¨è£…é¥°å™¨åˆ›å»ºä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    print(f"æ‰“å¼€æ–‡ä»¶: {filename}")
    file = open(filename, mode)
    try:
        yield file  # yieldå‰æ˜¯__enter__ï¼Œyieldåæ˜¯__exit__
    finally:
        print(f"å…³é—­æ–‡ä»¶: {filename}")
        file.close()

# ä½¿ç”¨
with file_manager("test.txt", "w") as f:
    f.write("Hello!")
```

**å·¥ä½œåŸç†**

```python
@contextmanager
def my_context():
    # __enter__é˜¶æ®µ
    print("è¿›å…¥")
    resource = "èµ„æºå¯¹è±¡"

    try:
        yield resource  # è¿”å›ç»™aså˜é‡
        # withå—æ­£å¸¸ç»“æŸåç»§ç»­æ‰§è¡Œ
        print("æ­£å¸¸é€€å‡º")
    except Exception as e:
        # withå—æŠ›å‡ºå¼‚å¸¸æ—¶æ‰§è¡Œ
        print(f"å¼‚å¸¸é€€å‡º: {e}")
        raise  # é‡æ–°æŠ›å‡ºå¼‚å¸¸
    finally:
        # __exit__é˜¶æ®µï¼Œæ— è®ºå¦‚ä½•éƒ½æ‰§è¡Œ
        print("æ¸…ç†èµ„æº")

# ä½¿ç”¨
with my_context() as res:
    print(f"ä½¿ç”¨: {res}")
```

**å®ç”¨ç¤ºä¾‹**

```python
from contextlib import contextmanager
import time

@contextmanager
def timing(label):
    """è®¡æ—¶ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    start = time.time()
    try:
        yield
    finally:
        end = time.time()
        print(f"{label}: {end - start:.4f}ç§’")

# ä½¿ç”¨
with timing("æ•°æ®åº“æŸ¥è¯¢"):
    time.sleep(0.5)
    # æ‰§è¡ŒæŸ¥è¯¢
```

**ä¸´æ—¶ä¿®æ”¹ç¯å¢ƒ**

```python
from contextlib import contextmanager
import os

@contextmanager
def temporary_env(**env_vars):
    """ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡"""
    old_env = {}

    # ä¿å­˜æ—§å€¼å¹¶è®¾ç½®æ–°å€¼
    for key, value in env_vars.items():
        old_env[key] = os.environ.get(key)
        os.environ[key] = value

    try:
        yield
    finally:
        # æ¢å¤æ—§å€¼
        for key, old_value in old_env.items():
            if old_value is None:
                os.environ.pop(key, None)
            else:
                os.environ[key] = old_value

# ä½¿ç”¨
with temporary_env(DEBUG="true", LOG_LEVEL="debug"):
    print(os.environ.get("DEBUG"))  # true
    # æ‰§è¡Œéœ€è¦ç‰¹å®šç¯å¢ƒçš„ä»£ç 

print(os.environ.get("DEBUG"))  # Noneï¼ˆå·²æ¢å¤ï¼‰
```

**suppressï¼ˆæŠ‘åˆ¶å¼‚å¸¸ï¼‰**

```python
from contextlib import suppress

# ä¼ ç»Ÿå†™æ³•
try:
    os.remove("somefile.txt")
except FileNotFoundError:
    pass

# ä½¿ç”¨suppress
with suppress(FileNotFoundError):
    os.remove("somefile.txt")

# æŠ‘åˆ¶å¤šä¸ªå¼‚å¸¸
with suppress(FileNotFoundError, PermissionError):
    os.remove("protected_file.txt")
```

**closingï¼ˆè‡ªåŠ¨å…³é—­ï¼‰**

```python
from contextlib import closing
from urllib.request import urlopen

# ç¡®ä¿å¯¹è±¡çš„close()æ–¹æ³•è¢«è°ƒç”¨
with closing(urlopen("http://example.com")) as page:
    content = page.read()
# è‡ªåŠ¨è°ƒç”¨page.close()
```

**redirect_stdout/redirect_stderrï¼ˆé‡å®šå‘è¾“å‡ºï¼‰**

```python
from contextlib import redirect_stdout, redirect_stderr
import io

# é‡å®šå‘æ ‡å‡†è¾“å‡º
f = io.StringIO()
with redirect_stdout(f):
    print("è¿™äº›å†…å®¹ä¼šè¢«æ•è·")
    print("ä¸ä¼šæ‰“å°åˆ°æ§åˆ¶å°")

output = f.getvalue()
print(f"æ•è·çš„è¾“å‡º: {output}")

# é‡å®šå‘åˆ°æ–‡ä»¶
with open("output.txt", "w") as f:
    with redirect_stdout(f):
        print("å†™å…¥æ–‡ä»¶")
        help(str.upper)
```

**ExitStackï¼ˆç®¡ç†å¤šä¸ªä¸Šä¸‹æ–‡ï¼‰**

```python
from contextlib import ExitStack

# åŠ¨æ€ç®¡ç†å¤šä¸ªä¸Šä¸‹æ–‡
with ExitStack() as stack:
    # åŠ¨æ€æ·»åŠ ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    files = [
        stack.enter_context(open(f"file{i}.txt", "w"))
        for i in range(5)
    ]

    # ä½¿ç”¨æ‰€æœ‰æ–‡ä»¶
    for i, f in enumerate(files):
        f.write(f"å†…å®¹ {i}\n")
# æ‰€æœ‰æ–‡ä»¶è‡ªåŠ¨å…³é—­

# æ¡ä»¶æ€§æ·»åŠ ä¸Šä¸‹æ–‡
def process_files(filenames, use_backup=False):
    with ExitStack() as stack:
        files = []

        for filename in filenames:
            file = stack.enter_context(open(filename, "r"))
            files.append(file)

            if use_backup:
                backup = stack.enter_context(
                    open(f"{filename}.bak", "w")
                )
                files.append(backup)

        # å¤„ç†æ–‡ä»¶
        for f in files:
            process(f)
```

#### 5.4ã€åµŒå¥—ä¸Šä¸‹æ–‡ç®¡ç†å™¨

**å¤šä¸ªwithè¯­å¥**

```python
# æ–¹å¼1ï¼šåµŒå¥—with
with open("input.txt", "r") as infile:
    with open("output.txt", "w") as outfile:
        data = infile.read()
        outfile.write(data.upper())

# æ–¹å¼2ï¼šå•è¡Œwithï¼ˆPython 2.7+ï¼‰
with open("input.txt", "r") as infile, open("output.txt", "w") as outfile:
    data = infile.read()
    outfile.write(data.upper())
```

**ç»„åˆä½¿ç”¨**

```python
from contextlib import contextmanager
import threading

@contextmanager
def acquire_lock(lock):
    """è·å–é”"""
    print("è·å–é”")
    lock.acquire()
    try:
        yield
    finally:
        print("é‡Šæ”¾é”")
        lock.release()

# ä½¿ç”¨
lock = threading.Lock()
with acquire_lock(lock):
    # ä¸´ç•ŒåŒºä»£ç 
    print("æ‰§è¡Œä¸´ç•ŒåŒºä»£ç ")
```

#### 5.5ã€èµ„æºç®¡ç†æœ€ä½³å®è·µ

**æ¡ˆä¾‹1ï¼šæ•°æ®åº“äº‹åŠ¡ç®¡ç†**

```python
from contextlib import contextmanager

class Database:
    def __init__(self):
        self.connection = None

    @contextmanager
    def transaction(self):
        """äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
        print("å¼€å§‹äº‹åŠ¡")
        try:
            yield self
            print("æäº¤äº‹åŠ¡")
            # self.connection.commit()
        except Exception as e:
            print(f"å›æ»šäº‹åŠ¡: {e}")
            # self.connection.rollback()
            raise

# ä½¿ç”¨
db = Database()
with db.transaction():
    # æ‰§è¡Œæ•°æ®åº“æ“ä½œ
    pass
```

**æ¡ˆä¾‹2ï¼šä¸´æ—¶ä¿®æ”¹é…ç½®**

```python
from contextlib import contextmanager

class Config:
    debug = False
    log_level = "INFO"

@contextmanager
def temporary_config(**changes):
    """ä¸´æ—¶ä¿®æ”¹é…ç½®"""
    original = {}

    # ä¿å­˜å¹¶ä¿®æ”¹
    for key, value in changes.items():
        original[key] = getattr(Config, key)
        setattr(Config, key, value)

    try:
        yield Config
    finally:
        # æ¢å¤
        for key, value in original.items():
            setattr(Config, key, value)

# ä½¿ç”¨
print(Config.debug)  # False

with temporary_config(debug=True, log_level="DEBUG"):
    print(Config.debug)  # True
    print(Config.log_level)  # DEBUG

print(Config.debug)  # Falseï¼ˆå·²æ¢å¤ï¼‰
```

**æ¡ˆä¾‹3ï¼šæ‰¹é‡æ“ä½œ**

```python
from contextlib import contextmanager

@contextmanager
def batch_operation(batch_size=100):
    """æ‰¹é‡æ“ä½œä¸Šä¸‹æ–‡"""
    items = []

    def add_item(item):
        """æ·»åŠ é¡¹ç›®"""
        items.append(item)
        if len(items) >= batch_size:
            process_batch(items)
            items.clear()

    try:
        yield add_item
    finally:
        # å¤„ç†å‰©ä½™é¡¹ç›®
        if items:
            process_batch(items)

def process_batch(items):
    print(f"å¤„ç†æ‰¹æ¬¡: {len(items)} é¡¹")

# ä½¿ç”¨
with batch_operation(batch_size=3) as add:
    for i in range(10):
        add(f"é¡¹ç›®{i}")
# è¾“å‡º:
# å¤„ç†æ‰¹æ¬¡: 3 é¡¹
# å¤„ç†æ‰¹æ¬¡: 3 é¡¹
# å¤„ç†æ‰¹æ¬¡: 3 é¡¹
# å¤„ç†æ‰¹æ¬¡: 1 é¡¹
```

**æ¡ˆä¾‹4ï¼šæ€§èƒ½åˆ†æ**

```python
from contextlib import contextmanager
import time
import functools

@contextmanager
def profile_section(name):
    """æ€§èƒ½åˆ†æä¸Šä¸‹æ–‡"""
    start_time = time.time()
    start_memory = 0  # ç®€åŒ–ç¤ºä¾‹

    try:
        yield
    finally:
        elapsed = time.time() - start_time
        print(f"{name}:")
        print(f"  æ—¶é—´: {elapsed:.4f}ç§’")

# ä½¿ç”¨
with profile_section("æ•°æ®å¤„ç†"):
    data = [i ** 2 for i in range(1000000)]

with profile_section("æ•°æ®ä¿å­˜"):
    time.sleep(0.1)
```

**æ¡ˆä¾‹5ï¼šèµ„æºæ± ç®¡ç†**

```python
from contextlib import contextmanager
from queue import Queue

class ConnectionPool:
    """è¿æ¥æ± """
    def __init__(self, size=5):
        self.pool = Queue(maxsize=size)
        for i in range(size):
            self.pool.put(f"Connection_{i}")

    @contextmanager
    def get_connection(self):
        """è·å–è¿æ¥"""
        conn = self.pool.get()
        print(f"è·å–è¿æ¥: {conn}")
        try:
            yield conn
        finally:
            print(f"å½’è¿˜è¿æ¥: {conn}")
            self.pool.put(conn)

# ä½¿ç”¨
pool = ConnectionPool(size=2)

with pool.get_connection() as conn1:
    print(f"ä½¿ç”¨ {conn1}")

    with pool.get_connection() as conn2:
        print(f"ä½¿ç”¨ {conn2}")
```

**å°ç»“å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | Pythonä¸Šä¸‹æ–‡ç®¡ç†å™¨ | Java try-with-resources |
|-----|------------------|------------------------|
| è¯­æ³• | `with obj as var:` | `try (Type var = ...) {}` |
| åè®® | `__enter__/__exit__` | `AutoCloseable.close()` |
| è‡ªå®šä¹‰ | ç±»æˆ–@contextmanager | å®ç°AutoCloseable |
| åµŒå¥— | æ”¯æŒ | æ”¯æŒ |
| å¼‚å¸¸æŠ‘åˆ¶ | æ”¯æŒï¼ˆ__exit__è¿”å›Trueï¼‰ | ä¸æ”¯æŒ |
| å¤šèµ„æº | `with a, b:` | `try (A a; B b)` |

### 6ã€å‡½æ•°å¼ç¼–ç¨‹

> **è¯´æ˜**ï¼šåˆ—è¡¨æ¨å¯¼å¼å’Œç”Ÿæˆå™¨è¡¨è¾¾å¼å·²åœ¨ç¬¬5ç« "æ•°æ®ç»“æ„ä¸æ¨å¯¼å¼"ä¸­è¯¦ç»†è®²è§£ï¼Œè¿™é‡Œä¸å†é‡å¤ã€‚

Pythonè™½ç„¶ä¸æ˜¯çº¯å‡½æ•°å¼è¯­è¨€,ä½†æä¾›äº†ä¸°å¯Œçš„å‡½æ•°å¼ç¼–ç¨‹å·¥å…·ã€‚å¯¹äºç†Ÿæ‚‰Java 8+ Stream APIçš„å¼€å‘è€…æ¥è¯´,Pythonçš„å‡½æ•°å¼ç‰¹æ€§ä¼šæ„Ÿè§‰å¾ˆäº²åˆ‡ã€‚

#### 6.1ã€map()ã€filter()ã€reduce()

è¿™ä¸‰ä¸ªå‡½æ•°æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„åŸºçŸ³ã€‚

```java
// Java Stream APIæ–¹å¼
List<Integer> squares = IntStream.range(0, 10)
    .map(x -> x * x)
    .boxed()
    .collect(Collectors.toList());

List<Integer> evenSquares = IntStream.range(0, 10)
    .filter(x -> x % 2 == 0)
    .map(x -> x * x)
    .boxed()
    .collect(Collectors.toList());

// å¤šé‡å¾ªç¯ - Javaéœ€è¦åµŒå¥—Streamæˆ–flatMap
List<String> pairs = IntStream.rangeClosed(1, 3)
    .boxed()
    .flatMap(x -> Stream.of("a", "b", "c")
        .map(y -> "(" + x + ", " + y + ")"))
    .collect(Collectors.toList());
```

**å­—ç¬¦ä¸²å¤„ç†ç¤ºä¾‹:**

```python
# æå–æ‰€æœ‰å•è¯çš„é¦–å­—æ¯
sentence = "Hello World Python Programming"
initials = [word[0] for word in sentence.split()]
print(initials)  # ['H', 'W', 'P', 'P']

# è¿‡æ»¤å¹¶è½¬æ¢
words = ["apple", "banana", "cherry", "date"]
upper_long_words = [w.upper() for w in words if len(w) > 5]
print(upper_long_words)  # ['BANANA', 'CHERRY']

# åµŒå¥—åˆ—è¡¨å±•å¹³
matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
flat = [num for row in matrix for num in row]
print(flat)  # [1, 2, 3, 4, 5, 6, 7, 8, 9]
```

#### 6.2ã€é«˜é˜¶å‡½æ•°

é«˜é˜¶å‡½æ•°æ˜¯æŒ‡æ¥å—å‡½æ•°ä½œä¸ºå‚æ•°æˆ–è¿”å›å‡½æ•°çš„å‡½æ•°ã€‚

**å‡½æ•°ä½œä¸ºå‚æ•°:**

```python
def apply_operation(numbers, operation):
    """å¯¹åˆ—è¡¨ä¸­æ¯ä¸ªæ•°å­—åº”ç”¨æ“ä½œ"""
    return [operation(x) for x in numbers]

# å®šä¹‰ä¸åŒçš„æ“ä½œ
def square(x):
    return x ** 2

def double(x):
    return x * 2

def negate(x):
    return -x

numbers = [1, 2, 3, 4, 5]
print(apply_operation(numbers, square))   # [1, 4, 9, 16, 25]
print(apply_operation(numbers, double))   # [2, 4, 6, 8, 10]
print(apply_operation(numbers, negate))   # [-1, -2, -3, -4, -5]

# ä½¿ç”¨lambda
print(apply_operation(numbers, lambda x: x**3))  # [1, 8, 27, 64, 125]
```

**å‡½æ•°ä½œä¸ºè¿”å›å€¼:**

```python
def make_multiplier(n):
    """è¿”å›ä¸€ä¸ªä¹˜ä»¥nçš„å‡½æ•°"""
    def multiplier(x):
        return x * n
    return multiplier

times2 = make_multiplier(2)
times10 = make_multiplier(10)

print(times2(5))   # 10
print(times10(5))  # 50

# å®é™…åº”ç”¨:åˆ›å»ºéªŒè¯å™¨
def make_range_validator(min_val, max_val):
    """åˆ›å»ºèŒƒå›´éªŒè¯å‡½æ•°"""
    def validator(value):
        return min_val <= value <= max_val
    return validator

age_validator = make_range_validator(0, 120)
percentage_validator = make_range_validator(0, 100)

print(age_validator(25))    # True
print(age_validator(150))   # False
print(percentage_validator(85))  # True
```

**å†…ç½®é«˜é˜¶å‡½æ•°:**

```python
# sorted() - è‡ªå®šä¹‰æ’åº
students = [
    {'name': 'Alice', 'age': 25, 'score': 85},
    {'name': 'Bob', 'age': 22, 'score': 92},
    {'name': 'Charlie', 'age': 23, 'score': 78}
]

# æŒ‰å¹´é¾„æ’åº
by_age = sorted(students, key=lambda s: s['age'])
print([s['name'] for s in by_age])  # ['Bob', 'Charlie', 'Alice']

# æŒ‰åˆ†æ•°é™åº
by_score = sorted(students, key=lambda s: s['score'], reverse=True)
print([s['name'] for s in by_score])  # ['Bob', 'Alice', 'Charlie']

# å¤šçº§æ’åº:å…ˆæŒ‰åˆ†æ•°é™åº,å†æŒ‰å¹´é¾„å‡åº
multi_sort = sorted(students, key=lambda s: (-s['score'], s['age']))

# max()/min() - è‡ªå®šä¹‰æ¯”è¾ƒ
oldest = max(students, key=lambda s: s['age'])
print(oldest['name'])  # Alice

highest_score = max(students, key=lambda s: s['score'])
print(highest_score['name'])  # Bob
```

#### 6.3ã€åå‡½æ•°(functools.partial)

åå‡½æ•°ç”¨äºå›ºå®šå‡½æ•°çš„æŸäº›å‚æ•°,åˆ›å»ºæ–°å‡½æ•°ã€‚

```python
from functools import partial

# åŸºæœ¬ç¤ºä¾‹
def power(base, exponent):
    return base ** exponent

# åˆ›å»ºåå‡½æ•° - å›ºå®šexponent=2
square = partial(power, exponent=2)
print(square(5))  # 25
print(square(10))  # 100

# å›ºå®šexponent=3
cube = partial(power, exponent=3)
print(cube(5))  # 125

# å®é™…åº”ç”¨1:æ—¥å¿—è®°å½•
def log_message(message, level='INFO', timestamp=True):
    import datetime
    prefix = f"[{datetime.datetime.now()}] " if timestamp else ""
    print(f"{prefix}{level}: {message}")

# åˆ›å»ºä¸“ç”¨æ—¥å¿—å‡½æ•°
log_error = partial(log_message, level='ERROR')
log_warning = partial(log_message, level='WARNING')
log_debug = partial(log_message, level='DEBUG', timestamp=False)

log_error("Database connection failed")
log_warning("Low memory")
log_debug("Variable value: 42")

# å®é™…åº”ç”¨2:æ•°æ®è½¬æ¢
def convert_value(value, multiplier=1, offset=0, round_digits=2):
    """é€šç”¨æ•°å€¼è½¬æ¢å‡½æ•°"""
    result = value * multiplier + offset
    return round(result, round_digits)

# æ‘„æ°åº¦è½¬åæ°åº¦: F = C * 9/5 + 32
celsius_to_fahrenheit = partial(convert_value, multiplier=9/5, offset=32)
print(celsius_to_fahrenheit(0))    # 32.0
print(celsius_to_fahrenheit(100))  # 212.0

# ç±³è½¬è‹±å°º: feet = meter * 3.28084
meter_to_feet = partial(convert_value, multiplier=3.28084)
print(meter_to_feet(10))  # 32.81

# å®é™…åº”ç”¨3:é…ç½®HTTPè¯·æ±‚
import functools

def make_request(url, method='GET', headers=None, timeout=30):
    """æ¨¡æ‹ŸHTTPè¯·æ±‚"""
    headers = headers or {}
    print(f"{method} {url}")
    print(f"Headers: {headers}")
    print(f"Timeout: {timeout}s")

# APIç‰¹å®šé…ç½®
api_headers = {'Authorization': 'Bearer token123', 'Content-Type': 'application/json'}
api_request = partial(make_request, headers=api_headers, timeout=60)

# ä½¿ç”¨
api_request('https://api.example.com/users')
api_request('https://api.example.com/posts', method='POST')
```

**ä¸Javaå¯¹æ¯”:**

```java
// Javaæ²¡æœ‰ç›´æ¥çš„åå‡½æ•°,éœ€è¦æ‰‹åŠ¨åŒ…è£…
BiFunction<Integer, Integer, Integer> power = (base, exp) -> (int) Math.pow(base, exp);

// åˆ›å»º"åå‡½æ•°"
Function<Integer, Integer> square = base -> power.apply(base, 2);
Function<Integer, Integer> cube = base -> power.apply(base, 3);
```

#### 6.4ã€å‡½æ•°ç»„åˆ

å‡½æ•°ç»„åˆæ˜¯å°†å¤šä¸ªå‡½æ•°ç»„åˆæˆä¸€ä¸ªæ–°å‡½æ•°ã€‚

```python
# æ‰‹åŠ¨å®ç°å‡½æ•°ç»„åˆ
def compose(*functions):
    """ä»å³åˆ°å·¦ç»„åˆå‡½æ•°"""
    def inner(arg):
        result = arg
        for func in reversed(functions):
            result = func(result)
        return result
    return inner

# å®šä¹‰åŸºç¡€å‡½æ•°
def add_one(x):
    return x + 1

def double(x):
    return x * 2

def square(x):
    return x ** 2

# ç»„åˆå‡½æ•°:(x+1) * 2 ç„¶åå¹³æ–¹
combined = compose(square, double, add_one)
print(combined(3))  # ((3+1)*2)^2 = 64

# æ›´ä¼˜é›…çš„å®ç°
from functools import reduce

def compose2(*functions):
    """ä½¿ç”¨reduceå®ç°å‡½æ•°ç»„åˆ"""
    return reduce(lambda f, g: lambda x: f(g(x)), functions)

combined2 = compose2(square, double, add_one)
print(combined2(3))  # 64

# å®é™…åº”ç”¨:æ•°æ®å¤„ç†ç®¡é“
def remove_spaces(text):
    return text.replace(' ', '')

def to_lowercase(text):
    return text.lower()

def remove_punctuation(text):
    import string
    return text.translate(str.maketrans('', '', string.punctuation))

# ç»„åˆæ–‡æœ¬æ¸…æ´—å‡½æ•°
clean_text = compose(remove_punctuation, to_lowercase, remove_spaces)

text = "Hello, World! Python is AWESOME."
print(clean_text(text))  # heloworldpythonisawesome

# æ›´Pythonicçš„æ–¹å¼:ä½¿ç”¨ç®¡é“
class Pipeline:
    """å‡½æ•°ç®¡é“"""
    def __init__(self, value):
        self.value = value

    def pipe(self, func):
        """åº”ç”¨å‡½æ•°å¹¶è¿”å›æ–°çš„Pipeline"""
        return Pipeline(func(self.value))

    def get(self):
        """è·å–æœ€ç»ˆå€¼"""
        return self.value

# ä½¿ç”¨ç®¡é“
result = (Pipeline("Hello, World!")
         .pipe(str.lower)
         .pipe(lambda s: s.replace(' ', ''))
         .pipe(lambda s: s.replace('!', ''))
         .get())
print(result)  # helloworld
```

**å®æˆ˜:æ•°æ®è½¬æ¢ç®¡é“**

```python
# å¤„ç†ç”¨æˆ·æ•°æ®
users = [
    {'name': '  ALICE  ', 'age': '25', 'email': 'ALICE@EXAMPLE.COM'},
    {'name': 'bob', 'age': '30', 'email': 'bob@example.com  '},
    {'name': '  Charlie  ', 'age': '22', 'email': '  charlie@EXAMPLE.com'}
]

# å®šä¹‰è½¬æ¢å‡½æ•°
def clean_name(user):
    user['name'] = user['name'].strip().capitalize()
    return user

def convert_age(user):
    user['age'] = int(user['age'])
    return user

def normalize_email(user):
    user['email'] = user['email'].strip().lower()
    return user

# ç»„åˆæ‰€æœ‰è½¬æ¢
from functools import reduce

def process_user(user):
    transformations = [clean_name, convert_age, normalize_email]
    return reduce(lambda u, transform: transform(u), transformations, user)

# åº”ç”¨åˆ°æ‰€æœ‰ç”¨æˆ·
processed = list(map(process_user, users))
for user in processed:
    print(user)
# {'name': 'Alice', 'age': 25, 'email': 'alice@example.com'}
# {'name': 'Bob', 'age': 30, 'email': 'bob@example.com'}
# {'name': 'Charlie', 'age': 22, 'email': 'charlie@example.com'}
```

#### 6.5ã€çº¯å‡½æ•°ä¸å‰¯ä½œç”¨

çº¯å‡½æ•°æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µã€‚

**çº¯å‡½æ•°çš„ç‰¹å¾:**

```python
# çº¯å‡½æ•° - ç›¸åŒè¾“å…¥æ€»æ˜¯äº§ç”Ÿç›¸åŒè¾“å‡º,æ— å‰¯ä½œç”¨
def add(a, b):
    return a + b

def multiply(a, b):
    return a * b

# çº¯å‡½æ•° - ä¸ä¿®æ”¹è¾“å…¥
def append_item_pure(lst, item):
    """è¿”å›æ–°åˆ—è¡¨,ä¸ä¿®æ”¹åŸåˆ—è¡¨"""
    return lst + [item]

original = [1, 2, 3]
new_list = append_item_pure(original, 4)
print(original)  # [1, 2, 3] - æœªè¢«ä¿®æ”¹
print(new_list)  # [1, 2, 3, 4]

# éçº¯å‡½æ•° - æœ‰å‰¯ä½œç”¨
def append_item_impure(lst, item):
    """ç›´æ¥ä¿®æ”¹åˆ—è¡¨"""
    lst.append(item)
    return lst

original = [1, 2, 3]
new_list = append_item_impure(original, 4)
print(original)  # [1, 2, 3, 4] - è¢«ä¿®æ”¹äº†!
print(new_list)  # [1, 2, 3, 4]

# éçº¯å‡½æ•° - ä¾èµ–å¤–éƒ¨çŠ¶æ€
counter = 0

def increment_impure():
    global counter
    counter += 1
    return counter

print(increment_impure())  # 1
print(increment_impure())  # 2 - ç›¸åŒè°ƒç”¨,ä¸åŒç»“æœ!

# çº¯å‡½æ•°æ›¿ä»£æ–¹æ¡ˆ
def increment_pure(value):
    return value + 1

counter = 0
counter = increment_pure(counter)  # 1
counter = increment_pure(counter)  # 2
```

**çº¯å‡½æ•°çš„ä¼˜åŠ¿:**

```python
# 1. å¯æµ‹è¯•æ€§
def calculate_total(items, tax_rate):
    """çº¯å‡½æ•° - æ˜“äºæµ‹è¯•"""
    subtotal = sum(item['price'] * item['quantity'] for item in items)
    return subtotal * (1 + tax_rate)

# æµ‹è¯•ç®€å•
items = [
    {'price': 10, 'quantity': 2},
    {'price': 5, 'quantity': 3}
]
assert calculate_total(items, 0.1) == 38.5

# 2. å¯ç»„åˆæ€§
def filter_active(users):
    return [u for u in users if u.get('active', False)]

def sort_by_name(users):
    return sorted(users, key=lambda u: u['name'])

def get_emails(users):
    return [u['email'] for u in users]

# è½»æ¾ç»„åˆ
users = [
    {'name': 'Alice', 'active': True, 'email': 'alice@example.com'},
    {'name': 'Bob', 'active': False, 'email': 'bob@example.com'},
    {'name': 'Charlie', 'active': True, 'email': 'charlie@example.com'}
]

active_emails = get_emails(sort_by_name(filter_active(users)))
print(active_emails)  # ['alice@example.com', 'charlie@example.com']

# 3. å¹¶å‘å®‰å…¨
from concurrent.futures import ThreadPoolExecutor

def square_pure(x):
    """çº¯å‡½æ•° - çº¿ç¨‹å®‰å…¨"""
    return x ** 2

numbers = range(100)
with ThreadPoolExecutor(max_workers=4) as executor:
    results = list(executor.map(square_pure, numbers))
```

**é¿å…å‰¯ä½œç”¨çš„æŠ€å·§:**

```python
# 1. ä½¿ç”¨copyé¿å…ä¿®æ”¹åŸå§‹æ•°æ®
import copy

def update_user_pure(user, **updates):
    """è¿”å›æ›´æ–°åçš„æ–°ç”¨æˆ·å¯¹è±¡"""
    new_user = copy.deepcopy(user)
    new_user.update(updates)
    return new_user

user = {'name': 'Alice', 'age': 25}
updated = update_user_pure(user, age=26)
print(user)     # {'name': 'Alice', 'age': 25}
print(updated)  # {'name': 'Alice', 'age': 26}

# 2. ä½¿ç”¨ä¸å¯å˜æ•°æ®ç»“æ„
from collections import namedtuple

User = namedtuple('User', ['name', 'age', 'email'])
user = User('Alice', 25, 'alice@example.com')

# åˆ›å»ºæ–°å¯¹è±¡è€Œä¸æ˜¯ä¿®æ”¹
updated = user._replace(age=26)
print(user)     # User(name='Alice', age=25, ...)
print(updated)  # User(name='Alice', age=26, ...)

# 3. ä½¿ç”¨dataclasses(Python 3.7+)
from dataclasses import dataclass, replace

@dataclass(frozen=True)  # frozen=Trueä½¿å…¶ä¸å¯å˜
class Product:
    name: str
    price: float
    quantity: int

product = Product('Book', 29.99, 10)
# product.price = 19.99  # é”™è¯¯!ä¸å¯ä¿®æ”¹

# ä½¿ç”¨replaceåˆ›å»ºæ–°å¯¹è±¡
discounted = replace(product, price=19.99)
print(product)     # Product(name='Book', price=29.99, quantity=10)
print(discounted)  # Product(name='Book', price=19.99, quantity=10)
```

### 7ã€ç±»å‹æç¤º(Type Hints)

ä½œä¸ºJavaå¼€å‘è€…,ä½ ä¹ æƒ¯äº†å¼ºç±»å‹ç³»ç»Ÿã€‚Pythonä»3.5ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº†ç±»å‹æç¤º,è™½ç„¶ä¸å¼ºåˆ¶æ£€æŸ¥,ä½†èƒ½è®©ä»£ç æ›´æ¸…æ™°ã€IDEæç¤ºæ›´å¥½ã€‚

#### 7.1ã€åŸºæœ¬ç±»å‹æ³¨è§£

```python
# å˜é‡ç±»å‹æ³¨è§£
name: str = "Alice"
age: int = 25
salary: float = 5000.50
is_active: bool = True

# å‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ³¨è§£
def greet(name: str, age: int) -> str:
    return f"Hello {name}, you are {age} years old"

def add(a: int, b: int) -> int:
    return a + b

def get_user_info() -> dict:
    return {"name": "Alice", "age": 25}

# æ— è¿”å›å€¼
def log_message(message: str) -> None:
    print(message)

# Javaå¯¹æ¯”
"""
// Javaå¼ºåˆ¶ç±»å‹
String name = "Alice";
int age = 25;

public String greet(String name, int age) {
    return "Hello " + name;
}
"""
```

#### 7.2ã€å¤åˆç±»å‹æ³¨è§£

```python
from typing import List, Dict, Tuple, Set

# åˆ—è¡¨ç±»å‹
numbers: List[int] = [1, 2, 3, 4]
names: List[str] = ["Alice", "Bob"]

# å­—å…¸ç±»å‹
user: Dict[str, int] = {"age": 25, "score": 90}
config: Dict[str, any] = {"host": "localhost", "port": 8080}

# å…ƒç»„ç±»å‹
point: Tuple[int, int] = (10, 20)
person: Tuple[str, int, bool] = ("Alice", 25, True)

# é›†åˆç±»å‹
unique_ids: Set[int] = {1, 2, 3}

# åµŒå¥—ç±»å‹
users: List[Dict[str, any]] = [
    {"name": "Alice", "age": 25},
    {"name": "Bob", "age": 30}
]

# å®é™…åº”ç”¨
def get_user_scores() -> Dict[str, List[int]]:
    """è¿”å›ç”¨æˆ·å’Œä»–ä»¬çš„åˆ†æ•°åˆ—è¡¨"""
    return {
        "Alice": [85, 90, 88],
        "Bob": [92, 87, 95]
    }

def process_data(items: List[Tuple[str, int]]) -> Dict[str, int]:
    """å¤„ç†æ•°æ®åˆ—è¡¨"""
    return {name: score for name, score in items}
```

#### 7.3ã€Optionalä¸Union

```python
from typing import Optional, Union

# Optional - å¯èƒ½ä¸ºNone
def find_user(user_id: int) -> Optional[dict]:
    """è¿”å›ç”¨æˆ·æˆ–None"""
    if user_id > 0:
        return {"id": user_id, "name": "Alice"}
    return None

# Optional[X] ç­‰ä»·äº Union[X, None]
def get_config(key: str) -> Optional[str]:
    return None

# Union - å¤šç§å¯èƒ½ç±»å‹
def process_value(value: Union[int, str, float]) -> str:
    """å¤„ç†intã€stræˆ–floatç±»å‹"""
    return str(value)

# å®é™…åº”ç”¨
def parse_input(data: Union[str, bytes]) -> str:
    """å¤„ç†å­—ç¬¦ä¸²æˆ–å­—èŠ‚"""
    if isinstance(data, bytes):
        return data.decode('utf-8')
    return data

# Javaå¯¹æ¯”
"""
// Javaä½¿ç”¨æ³›å‹å’Œnull
Optional<User> findUser(int id) {
    if (id > 0) {
        return Optional.of(new User(id));
    }
    return Optional.empty();
}
"""
```

#### 7.4ã€æ³›å‹ç±»å‹

```python
from typing import TypeVar, Generic, List

# å®šä¹‰ç±»å‹å˜é‡
T = TypeVar('T')

# æ³›å‹å‡½æ•°
def first_element(items: List[T]) -> Optional[T]:
    """è¿”å›åˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ """
    return items[0] if items else None

# æ³›å‹ç±»
class Stack(Generic[T]):
    """é€šç”¨æ ˆå®ç°"""
    def __init__(self) -> None:
        self._items: List[T] = []

    def push(self, item: T) -> None:
        self._items.append(item)

    def pop(self) -> Optional[T]:
        return self._items.pop() if self._items else None

# ä½¿ç”¨
int_stack: Stack[int] = Stack()
int_stack.push(1)
int_stack.push(2)

str_stack: Stack[str] = Stack()
str_stack.push("hello")
```

#### 7.5ã€typingæ¨¡å—å¸¸ç”¨ç±»å‹

```python
from typing import Callable, Any, Sequence, Mapping, Iterable

# Callable - å¯è°ƒç”¨å¯¹è±¡
def apply_func(func: Callable[[int, int], int], a: int, b: int) -> int:
    return func(a, b)

result = apply_func(lambda x, y: x + y, 3, 5)  # 8

# Any - ä»»æ„ç±»å‹
def process_data(data: Any) -> str:
    return str(data)

# Sequence - åºåˆ—ç±»å‹
def sum_values(numbers: Sequence[int]) -> int:
    return sum(numbers)

sum_values([1, 2, 3])  # List
sum_values((1, 2, 3))  # Tuple

# Mapping - æ˜ å°„ç±»å‹
def print_config(config: Mapping[str, any]) -> None:
    for key, value in config.items():
        print(f"{key}: {value}")

# Iterable - å¯è¿­ä»£å¯¹è±¡
def process_items(items: Iterable[str]) -> List[str]:
    return [item.upper() for item in items]
```

#### 7.6ã€ç±»å‹åˆ«å

```python
from typing import List, Dict, Tuple

# å®šä¹‰ç±»å‹åˆ«å
UserId = int
UserName = str
Score = float

# å¤æ‚ç±»å‹åˆ«å
User = Dict[str, any]
UserList = List[User]
Coordinate = Tuple[float, float]
ScoreBoard = Dict[UserName, List[Score]]

# ä½¿ç”¨ç±»å‹åˆ«å
def get_user(user_id: UserId) -> User:
    return {"id": user_id, "name": "Alice"}

def calculate_average(scores: ScoreBoard) -> Dict[UserName, Score]:
    return {
        name: sum(score_list) / len(score_list)
        for name, score_list in scores.items()
    }
```

#### 7.7ã€mypyé™æ€ç±»å‹æ£€æŸ¥

```python
# å®‰è£…mypy: pip install mypy

# ç¤ºä¾‹ä»£ç  example.py
def add_numbers(a: int, b: int) -> int:
    return a + b

result: str = add_numbers(1, 2)  # ç±»å‹é”™è¯¯!

# è¿è¡Œæ£€æŸ¥
# mypy example.py
# error: Incompatible types in assignment (expression has type "int", variable has type "str")

# é…ç½®mypy: mypy.ini
"""
[mypy]
python_version = 3.9
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
"""

# å®é™…é¡¹ç›®ç¤ºä¾‹
from typing import List, Optional

class UserService:
    """ç”¨æˆ·æœåŠ¡ç±»"""

    def __init__(self, db_connection: any) -> None:
        self.db = db_connection

    def find_user(self, user_id: int) -> Optional[Dict[str, any]]:
        """æŸ¥æ‰¾ç”¨æˆ·"""
        # å®ç°...
        return {"id": user_id, "name": "Alice"}

    def get_all_users(self) -> List[Dict[str, any]]:
        """è·å–æ‰€æœ‰ç”¨æˆ·"""
        return [{"id": 1, "name": "Alice"}]
```

**å¯¹æ¯”æ€»ç»“:**

| ç‰¹æ€§ | Pythonç±»å‹æç¤º | Javaç±»å‹ç³»ç»Ÿ |
|-----|--------------|-------------|
| å¼ºåˆ¶æ€§ | å¯é€‰,è¿è¡Œæ—¶ä¸æ£€æŸ¥ | å¼ºåˆ¶,ç¼–è¯‘æ—¶æ£€æŸ¥ |
| åŸºæœ¬è¯­æ³• | `name: str` | `String name` |
| æ³›å‹ | `List[int]` | `List<Integer>` |
| å¯é€‰ç±»å‹ | `Optional[int]` | `Optional<Integer>` |
| è”åˆç±»å‹ | `Union[int, str]` | ä¸ç›´æ¥æ”¯æŒ |
| ç±»å‹åˆ«å | `UserId = int` | `typedef`(C++)æˆ–æ¥å£ |
| æ£€æŸ¥å·¥å…· | mypy, pyright | javacå†…ç½® |
| IDEæ”¯æŒ | VSCode, PyCharm | IntelliJ IDEA |

### 8ã€åå°„ä¸å†…çœ

Pythonçš„åå°„èƒ½åŠ›æ¯”Javaæ›´å¼ºå¤§ã€‚ä½œä¸ºJavaå¼€å‘è€…,ä½ ä¼šå‘ç°Pythonçš„åå°„APIæ›´ç®€å•ç›´æ¥ã€‚

#### 8.1ã€inspectæ¨¡å—

```python
import inspect

# å®šä¹‰ç¤ºä¾‹ç±»
class User:
    """ç”¨æˆ·ç±»"""
    def __init__(self, name: str, age: int):
        self.name = name
        self.age = age

    def greet(self):
        return f"Hello, I'm {self.name}"

    @staticmethod
    def create_guest():
        return User("Guest", 0)

# æ£€æŸ¥å¯¹è±¡ç±»å‹
print(inspect.isclass(User))          # True
print(inspect.isfunction(User.greet)) # True
print(inspect.ismethod(User().greet)) # True

# è·å–æºä»£ç 
print(inspect.getsource(User))        # æ‰“å°Userç±»çš„æºä»£ç 
print(inspect.getfile(User))          # è·å–æ–‡ä»¶è·¯å¾„

# è·å–å‡½æ•°ç­¾å
def example_func(name: str, age: int = 18) -> str:
    return f"{name}: {age}"

sig = inspect.signature(example_func)
print(sig)  # (name: str, age: int = 18) -> str

for param_name, param in sig.parameters.items():
    print(f"{param_name}: {param.annotation}, default={param.default}")

# è·å–ç±»æˆå‘˜
members = inspect.getmembers(User)
for name, value in members:
    print(f"{name}: {type(value)}")
```

#### 8.2ã€åŠ¨æ€å±æ€§æ“ä½œ

```python
class Config:
    host = "localhost"
    port = 8080

# getattr - è·å–å±æ€§
print(getattr(Config, 'host'))  # localhost
print(getattr(Config, 'timeout', 30))  # 30 (é»˜è®¤å€¼)

# setattr - è®¾ç½®å±æ€§
setattr(Config, 'host', '192.168.1.1')
print(Config.host)  # 192.168.1.1

# hasattr - æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨
print(hasattr(Config, 'host'))    # True
print(hasattr(Config, 'timeout')) # False

# delattr - åˆ é™¤å±æ€§
delattr(Config, 'port')
print(hasattr(Config, 'port'))  # False

# å®é™…åº”ç”¨:åŠ¨æ€é…ç½®åŠ è½½
config_data = {
    'database_host': 'localhost',
    'database_port': 3306,
    'cache_enabled': True
}

class AppConfig:
    pass

for key, value in config_data.items():
    setattr(AppConfig, key, value)

print(AppConfig.database_host)  # localhost
```

#### 8.3ã€åŠ¨æ€å¯¼å…¥æ¨¡å—

```python
import importlib

# åŠ¨æ€å¯¼å…¥æ¨¡å—
math_module = importlib.import_module('math')
print(math_module.sqrt(16))  # 4.0

# åŠ¨æ€å¯¼å…¥å¹¶è·å–å±æ€§
module = importlib.import_module('json')
dumps_func = getattr(module, 'dumps')
print(dumps_func({'name': 'Alice'}))  # {"name": "Alice"}

# __import__() å‡½æ•°
os_module = __import__('os')
print(os_module.getcwd())

# å®é™…åº”ç”¨:æ’ä»¶ç³»ç»Ÿ
def load_plugin(plugin_name: str):
    """åŠ¨æ€åŠ è½½æ’ä»¶"""
    try:
        module = importlib.import_module(f'plugins.{plugin_name}')
        if hasattr(module, 'Plugin'):
            return module.Plugin()
        else:
            raise AttributeError(f"Plugin class not found in {plugin_name}")
    except ImportError as e:
        print(f"Failed to load plugin: {e}")
        return None
```

#### 8.4ã€ç±»å‹æ£€æŸ¥

```python
# type() vs isinstance()
value = [1, 2, 3]
print(type(value))  # <class 'list'>
print(type(value) == list)  # True

# isinstance() - æ¨èä½¿ç”¨,æ”¯æŒç»§æ‰¿
print(isinstance(value, list))  # True
print(isinstance(value, (list, tuple)))  # True - æ£€æŸ¥å¤šä¸ªç±»å‹

# issubclass() - åˆ¤æ–­ç»§æ‰¿å…³ç³»
class Animal:
    pass

class Dog(Animal):
    pass

print(issubclass(Dog, Animal))  # True
print(issubclass(Dog, object))  # True - æ‰€æœ‰ç±»éƒ½ç»§æ‰¿è‡ªobject

# é¸­å­ç±»å‹åº”ç”¨
def process_iterable(obj):
    """å¤„ç†ä»»ä½•å¯è¿­ä»£å¯¹è±¡"""
    if hasattr(obj, '__iter__'):
        for item in obj:
            print(item)
    else:
        print("Not iterable")

process_iterable([1, 2, 3])      # å¤„ç†åˆ—è¡¨
process_iterable("hello")        # å¤„ç†å­—ç¬¦ä¸²
process_iterable(range(5))       # å¤„ç†rangeå¯¹è±¡
```

#### 8.5ã€åŠ¨æ€åˆ›å»ºç±»

```python
# ä½¿ç”¨type()åˆ›å»ºç±»
# type(name, bases, dict)
User = type('User', (object,), {
    'name': 'Alice',
    'greet': lambda self: f"Hello, {self.name}"
})

user = User()
print(user.name)     # Alice
print(user.greet())  # Hello, Alice

# æ›´å¤æ‚çš„ç¤ºä¾‹
def __init__(self, name, age):
    self.name = name
    self.age = age

def get_info(self):
    return f"{self.name}, {self.age} years old"

Person = type('Person', (object,), {
    '__init__': __init__,
    'get_info': get_info
})

p = Person("Bob", 25)
print(p.get_info())  # Bob, 25 years old

# å®é™…åº”ç”¨:ORMæ¨¡å‹åŠ¨æ€ç”Ÿæˆ
def create_model(table_name: str, fields: dict):
    """åŠ¨æ€åˆ›å»ºæ•°æ®åº“æ¨¡å‹"""
    def __init__(self, **kwargs):
        for key, value in kwargs.items():
            setattr(self, key, value)

    def __repr__(self):
        field_strs = [f"{k}={getattr(self, k)}" for k in fields.keys()]
        return f"{table_name}({', '.join(field_strs)})"

    attrs = {
        '__init__': __init__,
        '__repr__': __repr__,
        '_table_name': table_name,
        '_fields': fields
    }

    return type(table_name, (object,), attrs)

# åˆ›å»ºUseræ¨¡å‹
UserModel = create_model('users', {
    'id': 'INTEGER',
    'name': 'VARCHAR(100)',
    'email': 'VARCHAR(100)'
})

user = UserModel(id=1, name='Alice', email='alice@example.com')
print(user)  # users(id=1, name=Alice, email=alice@example.com)
```

#### 8.6ã€å…ƒç±»(Metaclass)åŸºç¡€

```python
# å…ƒç±»æ˜¯åˆ›å»ºç±»çš„ç±»
class Meta(type):
    """è‡ªå®šä¹‰å…ƒç±»"""
    def __new__(mcs, name, bases, attrs):
        # åœ¨ç±»åˆ›å»ºæ—¶æ‰§è¡Œ
        print(f"Creating class: {name}")
        # æ·»åŠ ç±»å±æ€§
        attrs['created_by'] = 'Meta'
        return super().__new__(mcs, name, bases, attrs)

# ä½¿ç”¨å…ƒç±»
class MyClass(metaclass=Meta):
    pass

# è¾“å‡º: Creating class: MyClass
print(MyClass.created_by)  # Meta

# å®é™…åº”ç”¨:è‡ªåŠ¨æ³¨å†Œç±»
_registry = {}

class RegisterMeta(type):
    """è‡ªåŠ¨æ³¨å†Œå…ƒç±»"""
    def __new__(mcs, name, bases, attrs):
        cls = super().__new__(mcs, name, bases, attrs)
        if name != 'Base':  # è·³è¿‡åŸºç±»
            _registry[name] = cls
        return cls

class Base(metaclass=RegisterMeta):
    pass

class PluginA(Base):
    pass

class PluginB(Base):
    pass

print(_registry)  # {'PluginA': <class '__main__.PluginA'>, 'PluginB': <class '__main__.PluginB'>}
```

#### 8.7ã€å®æˆ˜æ¡ˆä¾‹

**æ¡ˆä¾‹1:ç®€æ˜“ä¾èµ–æ³¨å…¥**

```python
class Container:
    """ä¾èµ–æ³¨å…¥å®¹å™¨"""
    def __init__(self):
        self._services = {}

    def register(self, interface, implementation):
        """æ³¨å†ŒæœåŠ¡"""
        self._services[interface] = implementation

    def resolve(self, interface):
        """è§£ææœåŠ¡"""
        implementation = self._services.get(interface)
        if implementation is None:
            raise ValueError(f"Service {interface} not registered")

        # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¾èµ–æ³¨å…¥
        sig = inspect.signature(implementation.__init__)
        dependencies = {}

        for param_name, param in sig.parameters.items():
            if param_name == 'self':
                continue
            if param.annotation != inspect.Parameter.empty:
                dependencies[param_name] = self.resolve(param.annotation)

        return implementation(**dependencies)

# ä½¿ç”¨ç¤ºä¾‹
class Database:
    def query(self, sql):
        return f"Executing: {sql}"

class UserRepository:
    def __init__(self, db: Database):
        self.db = db

    def find_all(self):
        return self.db.query("SELECT * FROM users")

# æ³¨å†ŒæœåŠ¡
container = Container()
container.register(Database, Database)
container.register(UserRepository, UserRepository)

# è§£ææœåŠ¡(è‡ªåŠ¨æ³¨å…¥ä¾èµ–)
repo = container.resolve(UserRepository)
print(repo.find_all())  # Executing: SELECT * FROM users
```

**æ¡ˆä¾‹2:åºåˆ—åŒ–/ååºåˆ—åŒ–**

```python
import json
from typing import get_type_hints

class Serializable:
    """å¯åºåˆ—åŒ–åŸºç±»"""

    def to_dict(self):
        """è½¬æ¢ä¸ºå­—å…¸"""
        result = {}
        for key, value in self.__dict__.items():
            if isinstance(value, Serializable):
                result[key] = value.to_dict()
            else:
                result[key] = value
        return result

    @classmethod
    def from_dict(cls, data: dict):
        """ä»å­—å…¸åˆ›å»ºå¯¹è±¡"""
        hints = get_type_hints(cls.__init__)
        kwargs = {}

        for key, value in data.items():
            if key in hints:
                hint = hints[key]
                # å¦‚æœæ˜¯Serializableå­ç±»,é€’å½’åˆ›å»º
                if isinstance(hint, type) and issubclass(hint, Serializable):
                    kwargs[key] = hint.from_dict(value)
                else:
                    kwargs[key] = value
            else:
                kwargs[key] = value

        return cls(**kwargs)

class Address(Serializable):
    def __init__(self, city: str, street: str):
        self.city = city
        self.street = street

class User(Serializable):
    def __init__(self, name: str, age: int, address: Address):
        self.name = name
        self.age = age
        self.address = address

# ä½¿ç”¨
user = User("Alice", 25, Address("Beijing", "Main St"))
user_dict = user.to_dict()
print(json.dumps(user_dict, indent=2))

# ååºåˆ—åŒ–
restored = User.from_dict(user_dict)
print(f"{restored.name} lives in {restored.address.city}")
```

**å¯¹æ¯”æ€»ç»“:**

| ç‰¹æ€§ | Python | Java |
|-----|--------|------|
| åå°„API | inspect, getattr, setattr | java.lang.reflect |
| è·å–ç±»ä¿¡æ¯ | `inspect.getmembers()` | `Class.getDeclaredMethods()` |
| åŠ¨æ€è°ƒç”¨ | `getattr(obj, 'method')()` | `method.invoke(obj)` |
| åŠ¨æ€åˆ›å»ºç±» | `type(name, bases, dict)` | `Proxy.newProxyInstance()` |
| ç±»å‹æ£€æŸ¥ | `isinstance()`, `issubclass()` | `instanceof`, `isAssignableFrom()` |
| å…ƒç±» | `class Meta(type)` | ä¸æ”¯æŒ(ä½¿ç”¨æ³¨è§£å¤„ç†å™¨) |
| çµæ´»æ€§ | æé«˜ | ä¸­ç­‰ |
| æ€§èƒ½ | è¾ƒæ…¢ | è¾ƒå¿« |

## äºŒã€Pythonæ ‡å‡†åº“

Pythonçš„æ ‡å‡†åº“éå¸¸ä¸°å¯Œ,å¼€ç®±å³ç”¨ã€‚ä½œä¸ºJavaå¼€å‘è€…,ä½ ä¼šå‘ç°å¾ˆå¤šåŠŸèƒ½åœ¨Pythonæ ‡å‡†åº“ä¸­å·²ç»å®ç°,æ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–ã€‚

### 1ã€å¸¸ç”¨å†…ç½®æ¨¡å—

#### 1.1ã€osä¸sysæ¨¡å—

**osæ¨¡å— - æ“ä½œç³»ç»Ÿäº¤äº’**

```python
import os

# è·å–å½“å‰å·¥ä½œç›®å½•
print(os.getcwd())  # D:\workspace\project

# æ”¹å˜å·¥ä½œç›®å½•
os.chdir('/tmp')

# åˆ—å‡ºç›®å½•å†…å®¹
files = os.listdir('.')
print(files)

# åˆ›å»ºç›®å½•
os.mkdir('new_folder')
os.makedirs('path/to/folder', exist_ok=True)  # é€’å½’åˆ›å»º

# åˆ é™¤æ–‡ä»¶å’Œç›®å½•
os.remove('file.txt')  # åˆ é™¤æ–‡ä»¶
os.rmdir('folder')     # åˆ é™¤ç©ºç›®å½•
import shutil
shutil.rmtree('folder')  # åˆ é™¤éç©ºç›®å½•

# æ–‡ä»¶å’Œç›®å½•åˆ¤æ–­
print(os.path.exists('file.txt'))  # æ˜¯å¦å­˜åœ¨
print(os.path.isfile('file.txt'))  # æ˜¯å¦æ˜¯æ–‡ä»¶
print(os.path.isdir('folder'))     # æ˜¯å¦æ˜¯ç›®å½•

# è·¯å¾„æ“ä½œ
full_path = os.path.join('path', 'to', 'file.txt')  # path/to/file.txt
dirname = os.path.dirname('/path/to/file.txt')      # /path/to
basename = os.path.basename('/path/to/file.txt')    # file.txt
name, ext = os.path.splitext('file.txt')            # ('file', '.txt')

# ç¯å¢ƒå˜é‡
print(os.environ.get('PATH'))
os.environ['MY_VAR'] = 'value'

# æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
os.system('ls -l')  # ä¸æ¨è,ä½¿ç”¨subprocessæ¨¡å—
```

**sysæ¨¡å— - Pythonè§£é‡Šå™¨äº¤äº’**

```python
import sys

# å‘½ä»¤è¡Œå‚æ•°
print(sys.argv)  # ['script.py', 'arg1', 'arg2']

# Pythonç‰ˆæœ¬ä¿¡æ¯
print(sys.version)
print(sys.version_info)  # sys.version_info(major=3, minor=9, ...)

# æ¨¡å—æœç´¢è·¯å¾„
print(sys.path)
sys.path.append('/custom/path')

# é€€å‡ºç¨‹åº
sys.exit(0)  # æ­£å¸¸é€€å‡º
sys.exit(1)  # å¼‚å¸¸é€€å‡º

# æ ‡å‡†è¾“å…¥è¾“å‡º
sys.stdout.write("Hello\n")
line = sys.stdin.readline()

# è·å–å¯¹è±¡å¤§å°
numbers = [1, 2, 3, 4, 5]
print(sys.getsizeof(numbers))  # å­—èŠ‚æ•°
```

**Javaå¯¹æ¯”:**

```java
// Javaè·å–å½“å‰ç›®å½•
String currentDir = System.getProperty("user.dir");

// Javaç¯å¢ƒå˜é‡
String path = System.getenv("PATH");

// Javaå‘½ä»¤è¡Œå‚æ•°
public static void main(String[] args) {
    // argsæ•°ç»„
}
```

#### 1.2ã€datetimeæ¨¡å—

```python
from datetime import datetime, date, time, timedelta

# è·å–å½“å‰æ—¶é—´
now = datetime.now()
print(now)  # 2025-01-26 15:30:45.123456

today = date.today()
print(today)  # 2025-01-26

# åˆ›å»ºæ—¥æœŸæ—¶é—´
dt = datetime(2025, 1, 26, 15, 30, 45)
d = date(2025, 1, 26)
t = time(15, 30, 45)

# æ ¼å¼åŒ–è¾“å‡º
print(now.strftime('%Y-%m-%d %H:%M:%S'))  # 2025-01-26 15:30:45
print(now.strftime('%Yå¹´%mæœˆ%dæ—¥'))        # 2025å¹´01æœˆ26æ—¥

# è§£æå­—ç¬¦ä¸²
dt = datetime.strptime('2025-01-26 15:30:45', '%Y-%m-%d %H:%M:%S')

# æ—¥æœŸè¿ç®—
tomorrow = today + timedelta(days=1)
next_week = today + timedelta(weeks=1)
one_hour_later = now + timedelta(hours=1)

# æ—¶é—´å·®
diff = datetime(2025, 12, 31) - now
print(diff.days)  # å‰©ä½™å¤©æ•°
print(diff.total_seconds())  # æ€»ç§’æ•°

# æ—¶é—´æˆ³
timestamp = now.timestamp()  # è½¬ä¸ºæ—¶é—´æˆ³
dt = datetime.fromtimestamp(timestamp)  # ä»æ—¶é—´æˆ³åˆ›å»º

# Javaå¯¹æ¯”
"""
// Java 8+
LocalDateTime now = LocalDateTime.now();
LocalDate today = LocalDate.now();

// æ ¼å¼åŒ–
DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
String formatted = now.format(formatter);

// æ—¥æœŸè¿ç®—
LocalDate tomorrow = today.plusDays(1);
"""
```

#### 1.3ã€jsonæ¨¡å—

```python
import json

# Pythonå¯¹è±¡è½¬JSONå­—ç¬¦ä¸²
data = {
    'name': 'Alice',
    'age': 25,
    'skills': ['Python', 'Java'],
    'active': True
}

json_str = json.dumps(data)
print(json_str)  # {"name": "Alice", "age": 25, ...}

# ç¾åŒ–è¾“å‡º
json_str = json.dumps(data, indent=2, ensure_ascii=False)
print(json_str)

# JSONå­—ç¬¦ä¸²è½¬Pythonå¯¹è±¡
data = json.loads(json_str)
print(data['name'])  # Alice

# è¯»å†™JSONæ–‡ä»¶
# å†™å…¥
with open('data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, indent=2, ensure_ascii=False)

# è¯»å–
with open('data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# è‡ªå®šä¹‰JSONç¼–ç 
from datetime import datetime

class DateTimeEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, datetime):
            return obj.isoformat()
        return super().default(obj)

data = {'created': datetime.now()}
json_str = json.dumps(data, cls=DateTimeEncoder)

# Javaå¯¹æ¯”
"""
// Javaä½¿ç”¨Jacksonæˆ–Gson
ObjectMapper mapper = new ObjectMapper();
String json = mapper.writeValueAsString(data);
Data data = mapper.readValue(json, Data.class);
"""
```

#### 1.4ã€reæ¨¡å—(æ­£åˆ™è¡¨è¾¾å¼)

```python
import re

# åŸºæœ¬åŒ¹é…
text = "My email is alice@example.com"
match = re.search(r'\w+@\w+\.\w+', text)
if match:
    print(match.group())  # alice@example.com

# æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…
text = "Phone: 123-456-7890, Mobile: 098-765-4321"
phones = re.findall(r'\d{3}-\d{3}-\d{4}', text)
print(phones)  # ['123-456-7890', '098-765-4321']

# æ›¿æ¢
text = "Hello World"
result = re.sub(r'World', 'Python', text)
print(result)  # Hello Python

# åˆ†å‰²
text = "apple,banana;orange:grape"
fruits = re.split(r'[,;:]', text)
print(fruits)  # ['apple', 'banana', 'orange', 'grape']

# ç¼–è¯‘æ­£åˆ™(æé«˜æ€§èƒ½)
pattern = re.compile(r'\d+')
numbers = pattern.findall("I have 3 apples and 5 oranges")
print(numbers)  # ['3', '5']

# æ•è·ç»„
text = "Name: Alice, Age: 25"
match = re.search(r'Name: (\w+), Age: (\d+)', text)
if match:
    print(match.group(1))  # Alice
    print(match.group(2))  # 25
    print(match.groups())  # ('Alice', '25')

# å¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼
email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
url_pattern = r'^https?://(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b'
phone_pattern = r'^\d{3}-\d{3}-\d{4}$'
```

#### 1.5ã€mathä¸randomæ¨¡å—

```python
import math
import random

# mathæ¨¡å—
print(math.pi)      # 3.141592653589793
print(math.e)       # 2.718281828459045

print(math.sqrt(16))    # 4.0
print(math.pow(2, 3))   # 8.0
print(math.ceil(4.3))   # 5
print(math.floor(4.7))  # 4
print(math.fabs(-5))    # 5.0

# ä¸‰è§’å‡½æ•°
print(math.sin(math.pi / 2))  # 1.0
print(math.cos(0))             # 1.0

# randomæ¨¡å—
print(random.random())  # 0.0åˆ°1.0çš„éšæœºæµ®ç‚¹æ•°

# éšæœºæ•´æ•°
print(random.randint(1, 10))  # 1åˆ°10çš„éšæœºæ•´æ•°(åŒ…å«10)
print(random.randrange(1, 10))  # 1åˆ°9çš„éšæœºæ•´æ•°(ä¸å«10)

# éšæœºé€‰æ‹©
colors = ['red', 'green', 'blue']
print(random.choice(colors))  # éšæœºé€‰æ‹©ä¸€ä¸ª

# éšæœºå¤šä¸ª(æœ‰æ”¾å›)
print(random.choices(colors, k=3))  # ['red', 'blue', 'red']

# éšæœºå¤šä¸ª(æ— æ”¾å›)
print(random.sample(colors, k=2))  # ['green', 'red']

# æ‰“ä¹±åˆ—è¡¨
numbers = [1, 2, 3, 4, 5]
random.shuffle(numbers)
print(numbers)  # [3, 1, 5, 2, 4]

# è®¾ç½®éšæœºç§å­(å¯å¤ç°)
random.seed(42)
print(random.random())  # ç›¸åŒç§å­äº§ç”Ÿç›¸åŒåºåˆ—
```

#### 1.6ã€collectionsæ¨¡å—

```python
from collections import Counter, defaultdict, deque, namedtuple, OrderedDict

# Counter - è®¡æ•°å™¨
words = ['apple', 'banana', 'apple', 'orange', 'banana', 'apple']
counter = Counter(words)
print(counter)  # Counter({'apple': 3, 'banana': 2, 'orange': 1})
print(counter.most_common(2))  # [('apple', 3), ('banana', 2)]

# defaultdict - é»˜è®¤å€¼å­—å…¸
dd = defaultdict(list)
dd['fruits'].append('apple')  # ä¸éœ€è¦æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨
print(dd)  # defaultdict(<class 'list'>, {'fruits': ['apple']})

# æŒ‰ç±»åˆ«åˆ†ç»„
data = [('fruit', 'apple'), ('veg', 'carrot'), ('fruit', 'banana')]
grouped = defaultdict(list)
for category, item in data:
    grouped[category].append(item)
print(dict(grouped))  # {'fruit': ['apple', 'banana'], 'veg': ['carrot']}

# deque - åŒç«¯é˜Ÿåˆ—
dq = deque([1, 2, 3])
dq.append(4)      # å³ç«¯æ·»åŠ 
dq.appendleft(0)  # å·¦ç«¯æ·»åŠ 
dq.pop()          # å³ç«¯ç§»é™¤
dq.popleft()      # å·¦ç«¯ç§»é™¤
print(dq)  # deque([1, 2, 3])

# é™åˆ¶é•¿åº¦çš„deque(ç”¨ä½œå¾ªç¯ç¼“å†²åŒº)
buffer = deque(maxlen=3)
for i in range(5):
    buffer.append(i)
print(buffer)  # deque([2, 3, 4], maxlen=3)

# namedtuple - å‘½åå…ƒç»„
Point = namedtuple('Point', ['x', 'y'])
p = Point(10, 20)
print(p.x, p.y)  # 10 20
print(p[0], p[1])  # ä¹Ÿå¯ä»¥ç”¨ç´¢å¼•

# OrderedDict - æœ‰åºå­—å…¸(Python 3.7+æ™®é€šdictä¹Ÿä¿åº)
od = OrderedDict()
od['a'] = 1
od['b'] = 2
od['c'] = 3
print(list(od.keys()))  # ['a', 'b', 'c']

# Javaå¯¹æ¯”
"""
// Java Counterç±»ä¼¼
Map<String, Integer> counter = new HashMap<>();
// éœ€è¦æ‰‹åŠ¨è®¡æ•°

// Java deque
Deque<Integer> deque = new ArrayDeque<>();
deque.addFirst(1);
deque.addLast(2);
"""
```

#### 1.7ã€pathlibæ¨¡å—

```python
from pathlib import Path

# åˆ›å»ºè·¯å¾„å¯¹è±¡
p = Path('/usr/local/bin')
p = Path.home()  # ç”¨æˆ·ä¸»ç›®å½•
p = Path.cwd()   # å½“å‰å·¥ä½œç›®å½•

# è·¯å¾„æ‹¼æ¥
config_path = Path.home() / '.config' / 'app' / 'settings.json'
print(config_path)  # /home/user/.config/app/settings.json

# è·¯å¾„å±æ€§
p = Path('/path/to/file.txt')
print(p.name)       # file.txt
print(p.stem)       # file
print(p.suffix)     # .txt
print(p.parent)     # /path/to
print(p.parts)      # ('/', 'path', 'to', 'file.txt')

# æ–‡ä»¶æ“ä½œ
p = Path('test.txt')
p.write_text('Hello World', encoding='utf-8')  # å†™å…¥
content = p.read_text(encoding='utf-8')        # è¯»å–
p.unlink()  # åˆ é™¤æ–‡ä»¶

# ç›®å½•æ“ä½œ
dir_path = Path('new_folder')
dir_path.mkdir(exist_ok=True)  # åˆ›å»ºç›®å½•
dir_path.mkdir(parents=True, exist_ok=True)  # é€’å½’åˆ›å»º

# åˆ¤æ–­
p = Path('file.txt')
print(p.exists())   # æ˜¯å¦å­˜åœ¨
print(p.is_file())  # æ˜¯å¦æ˜¯æ–‡ä»¶
print(p.is_dir())   # æ˜¯å¦æ˜¯ç›®å½•

# éå†ç›®å½•
for file in Path('.').iterdir():
    print(file)

# é€’å½’æŸ¥æ‰¾
for py_file in Path('.').rglob('*.py'):
    print(py_file)

# å¯¹æ¯”os.path
"""
# æ—§æ–¹å¼
import os
path = os.path.join(os.path.expanduser('~'), '.config', 'app')

# æ–°æ–¹å¼(pathlib)
path = Path.home() / '.config' / 'app'
"""
```

**æ¨¡å—å¯¹æ¯”æ€»ç»“:**

| åŠŸèƒ½ | Pythonæ¨¡å— | Javaå¯¹åº” |
|-----|-----------|---------|
| æ“ä½œç³»ç»Ÿäº¤äº’ | `os` | `System`, `Runtime` |
| æ–‡ä»¶è·¯å¾„ | `pathlib`, `os.path` | `java.nio.file.Path` |
| æ—¥æœŸæ—¶é—´ | `datetime` | `java.time.*` |
| JSONå¤„ç† | `json` | Jackson, Gson |
| æ­£åˆ™è¡¨è¾¾å¼ | `re` | `java.util.regex.Pattern` |
| éšæœºæ•° | `random` | `java.util.Random` |
| é«˜çº§é›†åˆ | `collections` | `java.util.*` |

### 2ã€æ•°æ®å¤„ç†

#### 2.1ã€csvæ¨¡å—

```python
import csv

# è¯»å–CSVæ–‡ä»¶
with open('data.csv', 'r', encoding='utf-8') as f:
    reader = csv.reader(f)
    headers = next(reader)  # è¯»å–è¡¨å¤´
    for row in reader:
        print(row)  # ['Alice', '25', 'Beijing']

# ä½¿ç”¨DictReader(æ¨è)
with open('data.csv', 'r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    for row in reader:
        print(row['name'], row['age'])  # æŒ‰åˆ—åè®¿é—®

# å†™å…¥CSVæ–‡ä»¶
data = [
    ['name', 'age', 'city'],
    ['Alice', 25, 'Beijing'],
    ['Bob', 30, 'Shanghai']
]

with open('output.csv', 'w', encoding='utf-8', newline='') as f:
    writer = csv.writer(f)
    writer.writerows(data)

# ä½¿ç”¨DictWriter
with open('output.csv', 'w', encoding='utf-8', newline='') as f:
    fieldnames = ['name', 'age', 'city']
    writer = csv.DictWriter(f, fieldnames=fieldnames)
    writer.writeheader()
    writer.writerow({'name': 'Alice', 'age': 25, 'city': 'Beijing'})
```

#### 2.2ã€XMLå¤„ç†

```python
import xml.etree.ElementTree as ET

# è§£æXML
xml_str = '''
<users>
    <user id="1">
        <name>Alice</name>
        <age>25</age>
    </user>
    <user id="2">
        <name>Bob</name>
        <age>30</age>
    </user>
</users>
'''

root = ET.fromstring(xml_str)

# éå†å…ƒç´ 
for user in root.findall('user'):
    user_id = user.get('id')
    name = user.find('name').text
    age = user.find('age').text
    print(f"ID: {user_id}, Name: {name}, Age: {age}")

# åˆ›å»ºXML
root = ET.Element('users')
user = ET.SubElement(root, 'user', id='1')
ET.SubElement(user, 'name').text = 'Alice'
ET.SubElement(user, 'age').text = '25'

# ä¿å­˜XML
tree = ET.ElementTree(root)
tree.write('users.xml', encoding='utf-8', xml_declaration=True)
```

#### 2.3ã€pickleæ¨¡å—(åºåˆ—åŒ–)

```python
import pickle

# Pythonå¯¹è±¡åºåˆ—åŒ–
data = {
    'name': 'Alice',
    'scores': [85, 90, 88],
    'metadata': {'created': '2025-01-26'}
}

# ä¿å­˜åˆ°æ–‡ä»¶
with open('data.pkl', 'wb') as f:
    pickle.dump(data, f)

# ä»æ–‡ä»¶åŠ è½½
with open('data.pkl', 'rb') as f:
    loaded_data = pickle.load(f)
    print(loaded_data)

# åºåˆ—åŒ–ä¸ºå­—èŠ‚ä¸²
bytes_data = pickle.dumps(data)
restored = pickle.loads(bytes_data)
```

#### 2.4ã€structæ¨¡å—(äºŒè¿›åˆ¶æ•°æ®)

```python
import struct

# æ‰“åŒ…äºŒè¿›åˆ¶æ•°æ®
# æ ¼å¼: i=int, f=float, s=string
packed = struct.pack('i f 10s', 42, 3.14, b'Hello')
print(packed)  # b'*\x00\x00\x00\xc3\xf5H@Hello\x00\x00\x00\x00\x00'

# è§£åŒ…äºŒè¿›åˆ¶æ•°æ®
unpacked = struct.unpack('i f 10s', packed)
print(unpacked)  # (42, 3.140000104904175, b'Hello\x00\x00\x00\x00\x00')

# å®é™…åº”ç”¨:è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶
with open('data.bin', 'rb') as f:
    data = f.read(struct.calcsize('i f'))
    values = struct.unpack('i f', data)
```

### 3ã€ç½‘ç»œç¼–ç¨‹

#### 3.1ã€socketæ¨¡å—

```python
import socket

# TCPæœåŠ¡å™¨
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(('localhost', 8080))
server.listen(5)
print("Server listening on port 8080...")

while True:
    client, addr = server.accept()
    print(f"Connection from {addr}")
    data = client.recv(1024)
    client.send(b"Hello from server")
    client.close()

# TCPå®¢æˆ·ç«¯
client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(('localhost', 8080))
client.send(b"Hello server")
response = client.recv(1024)
print(response.decode())
client.close()
```

#### 3.2ã€urllibæ¨¡å—

```python
from urllib import request, parse

# GETè¯·æ±‚
response = request.urlopen('https://api.github.com')
html = response.read().decode('utf-8')
print(html)

# POSTè¯·æ±‚
data = parse.urlencode({'key': 'value'}).encode()
req = request.Request('https://httpbin.org/post', data=data)
response = request.urlopen(req)
print(response.read().decode())

# è®¾ç½®è¯·æ±‚å¤´
req = request.Request('https://api.github.com')
req.add_header('User-Agent', 'Python App')
response = request.urlopen(req)
```

#### 3.3ã€http.server

```python
# å‘½ä»¤è¡Œå¯åŠ¨ç®€å•HTTPæœåŠ¡å™¨
# python -m http.server 8000

# è‡ªå®šä¹‰HTTPæœåŠ¡å™¨
from http.server import HTTPServer, BaseHTTPRequestHandler

class MyHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()
        self.wfile.write(b'<h1>Hello World</h1>')

server = HTTPServer(('localhost', 8000), MyHandler)
server.serve_forever()
```

### 4ã€å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹

#### 4.1ã€threadingæ¨¡å—

```python
import threading
import time

# åˆ›å»ºçº¿ç¨‹
def worker(name):
    print(f"Thread {name} starting")
    time.sleep(2)
    print(f"Thread {name} done")

threads = []
for i in range(5):
    t = threading.Thread(target=worker, args=(i,))
    threads.append(t)
    t.start()

# ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
for t in threads:
    t.join()

# çº¿ç¨‹ç±»
class MyThread(threading.Thread):
    def __init__(self, name):
        super().__init__()
        self.name = name

    def run(self):
        print(f"{self.name} is running")

# çº¿ç¨‹é”
lock = threading.Lock()

def safe_increment():
    global counter
    with lock:
        counter += 1
```

#### 4.2ã€multiprocessingæ¨¡å—

```python
from multiprocessing import Process, Pool, Queue

# åˆ›å»ºè¿›ç¨‹
def worker(name):
    print(f"Process {name} starting")

if __name__ == '__main__':
    processes = []
    for i in range(5):
        p = Process(target=worker, args=(i,))
        processes.append(p)
        p.start()

    for p in processes:
        p.join()

# è¿›ç¨‹æ± 
def square(x):
    return x ** 2

if __name__ == '__main__':
    with Pool(processes=4) as pool:
        results = pool.map(square, range(10))
        print(results)
```

#### 4.3ã€concurrent.futuresæ¨¡å—

```python
from concurrent.futures import ThreadPoolExecutor, ProcessPoolExecutor
import time

def task(n):
    time.sleep(1)
    return n ** 2

# çº¿ç¨‹æ± 
with ThreadPoolExecutor(max_workers=5) as executor:
    futures = [executor.submit(task, i) for i in range(10)]
    for future in futures:
        print(future.result())

# è¿›ç¨‹æ± 
with ProcessPoolExecutor(max_workers=4) as executor:
    results = executor.map(task, range(10))
    print(list(results))
```

#### 4.4ã€GILè¯¦è§£
GIL(å…¨å±€è§£é‡Šå™¨é”)æ˜¯CPythonçš„å®ç°ç»†èŠ‚:

1. å½±å“:
   - åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒPythonå­—èŠ‚ç 
   - å¤šçº¿ç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸CPUè¿›è¡ŒCPUå¯†é›†å‹ä»»åŠ¡
   - I/Oå¯†é›†å‹ä»»åŠ¡ä¸å—å½±å“

2. è§£å†³æ–¹æ¡ˆ:
   - CPUå¯†é›†å‹: ä½¿ç”¨multiprocessing
   - I/Oå¯†é›†å‹: ä½¿ç”¨threadingæˆ–asyncio
   - æ··åˆå‹: æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©

Javaå¯¹æ¯”:
- Javaæ²¡æœ‰GIL,å¤šçº¿ç¨‹å¯ä»¥çœŸæ­£å¹¶è¡Œ
- Pythonçš„å¤šçº¿ç¨‹æ›´é€‚åˆI/Oæ“ä½œ
- Pythonçš„å¤šè¿›ç¨‹ç±»ä¼¼Javaçš„å¤šçº¿ç¨‹

### 5ã€æ—¥å¿—ä¸è°ƒè¯•

#### 5.1ã€loggingæ¨¡å—

```python
import logging

# åŸºæœ¬é…ç½®
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    filename='app.log'
)

# ä½¿ç”¨æ—¥å¿—
logging.debug("Debug message")
logging.info("Info message")
logging.warning("Warning message")
logging.error("Error message")
logging.critical("Critical message")

# åˆ›å»ºlogger
logger = logging.getLogger(__name__)
logger.setLevel(logging.DEBUG)

# æ·»åŠ å¤„ç†å™¨
file_handler = logging.FileHandler('app.log')
console_handler = logging.StreamHandler()

# è®¾ç½®æ ¼å¼
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
file_handler.setFormatter(formatter)
console_handler.setFormatter(formatter)

logger.addHandler(file_handler)
logger.addHandler(console_handler)

# ä½¿ç”¨logger
logger.info("Application started")
```

#### 5.2ã€pdbè°ƒè¯•å™¨

```python
import pdb

def buggy_function(x, y):
    result = x + y
    pdb.set_trace()  # è®¾ç½®æ–­ç‚¹
    result = result * 2
    return result

# è°ƒè¯•å‘½ä»¤:
# n - ä¸‹ä¸€è¡Œ
# s - è¿›å…¥å‡½æ•°
# c - ç»§ç»­æ‰§è¡Œ
# p variable - æ‰“å°å˜é‡
# l - æ˜¾ç¤ºå½“å‰ä»£ç 
# q - é€€å‡ºè°ƒè¯•
```

#### 5.3ã€tracebackæ¨¡å—

```python
import traceback

try:
    result = 1 / 0
except Exception as e:
    # æ‰“å°å®Œæ•´å †æ ˆ
    traceback.print_exc()

    # è·å–å †æ ˆä¿¡æ¯
    tb_str = traceback.format_exc()
    print(tb_str)

    # è®°å½•åˆ°æ—¥å¿—
    logging.error("Error occurred", exc_info=True)
```

## ä¸‰ã€å¼‚æ­¥ç¼–ç¨‹

å¼‚æ­¥ç¼–ç¨‹æ˜¯Pythonçš„é‡è¦ç‰¹æ€§ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†I/Oå¯†é›†å‹ä»»åŠ¡ã€‚å¯¹äºJavaå¼€å‘è€…æ¥è¯´ï¼ŒPythonçš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹æ¯”Javaçš„CompletableFutureæ›´åŠ ç›´è§‚å’Œå¼ºå¤§ã€‚

### 1ã€asyncioåŸºç¡€

#### 1.1ã€async/awaitè¯­æ³•

Python 3.5å¼•å…¥äº†`async/await`è¯­æ³•ï¼Œè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ä¸€æ ·ç›´è§‚ã€‚

```python
import asyncio

async def greet(name):
    print(f"å¼€å§‹é—®å€™ {name}")
    await asyncio.sleep(1)  # å¼‚æ­¥ç­‰å¾…1ç§’
    return f"Hello, {name}!"

async def main():
    result = await greet("å¼ ä¸‰")
    print(result)

# è¿è¡Œå¼‚æ­¥ç¨‹åº
asyncio.run(main())
```

å¯¹æ¯”Javaçš„å¼‚æ­¥ç¼–ç¨‹ï¼š
```java
// Javaä½¿ç”¨CompletableFuture
CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
    return "Hello, å¼ ä¸‰!";
});

future.thenAccept(System.out::println);
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- `async def`ï¼šå®šä¹‰åç¨‹å‡½æ•°
- `await`ï¼šæš‚åœå½“å‰åç¨‹ï¼Œç­‰å¾…å¦ä¸€ä¸ªåç¨‹å®Œæˆ
- `asyncio.run()`ï¼šå¯åŠ¨äº‹ä»¶å¾ªç¯å¹¶è¿è¡Œä¸»åç¨‹

#### 1.2ã€åç¨‹æ¦‚å¿µ

åç¨‹ï¼ˆCoroutineï¼‰æ˜¯å¯ä»¥æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„å‡½æ•°ï¼Œæ¯”çº¿ç¨‹æ›´è½»é‡çº§ã€‚

```python
import asyncio
import time

async def task(name, duration):
    print(f"ä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(duration)
    print(f"ä»»åŠ¡ {name} å®Œæˆ")
    return f"{name} ç»“æœ"

async def main():
    start_time = time.time()

    # é¡ºåºæ‰§è¡Œï¼ˆæ€»æ—¶é—´ = 3ç§’ï¼‰
    result1 = await task("A", 1)
    result2 = await task("B", 2)

    end_time = time.time()
    print(f"é¡ºåºæ‰§è¡Œè€—æ—¶: {end_time - start_time:.2f}ç§’")

asyncio.run(main())
```

**åç¨‹ vs çº¿ç¨‹å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | åç¨‹ | çº¿ç¨‹ |
|-----|------|------|
| åˆ›å»ºæˆæœ¬ | æä½ï¼ˆå‡ KBï¼‰ | è¾ƒé«˜ï¼ˆå‡ MBï¼‰ |
| åˆ‡æ¢æˆæœ¬ | ç”¨æˆ·æ€åˆ‡æ¢ | å†…æ ¸æ€åˆ‡æ¢ |
| æ•°é‡é™åˆ¶ | å¯ä»¥åˆ›å»ºæ•°ä¸‡ä¸ª | é€šå¸¸æ•°ç™¾ä¸ª |
| é€‚ç”¨åœºæ™¯ | I/Oå¯†é›†å‹ | CPUå¯†é›†å‹ |

#### 1.3ã€äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯æ˜¯å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œåç¨‹ã€‚

```python
import asyncio

async def worker(name):
    print(f"{name} å¼€å§‹å·¥ä½œ")
    await asyncio.sleep(1)
    print(f"{name} å®Œæˆå·¥ä½œ")

async def main():
    # åˆ›å»ºä»»åŠ¡
    task1 = asyncio.create_task(worker("ä»»åŠ¡1"))
    task2 = asyncio.create_task(worker("ä»»åŠ¡2"))

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    await task1
    await task2
    print("æ‰€æœ‰ä»»åŠ¡å®Œæˆ")

# ä½¿ç”¨asyncio.run()
asyncio.run(main())

# æ‰‹åŠ¨æ§åˆ¶äº‹ä»¶å¾ªç¯ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
loop = asyncio.new_event_loop()
try:
    loop.run_until_complete(main())
finally:
    loop.close()
```

**asyncio.run() vs awaitçš„åŒºåˆ«**ï¼š
- `asyncio.run()`ï¼šå¯åŠ¨æ–°çš„äº‹ä»¶å¾ªç¯ï¼Œé€šå¸¸ç”¨äºç¨‹åºå…¥å£
- `await`ï¼šåœ¨ç°æœ‰äº‹ä»¶å¾ªç¯ä¸­ç­‰å¾…åç¨‹å®Œæˆ

```python
import asyncio

async def nested():
    return "åµŒå¥—åç¨‹ç»“æœ"

async def outer():
    # âœ… æ­£ç¡®ï¼šä½¿ç”¨await
    result = await nested()
    print(result)

    # âŒ é”™è¯¯ï¼šä¸èƒ½åœ¨åç¨‹ä¸­ä½¿ç”¨asyncio.run()
    # asyncio.run(nested())  # RuntimeError: no running event loop

asyncio.run(outer())
```

#### 1.4ã€Taskä¸Future

**Task**æ˜¯`Future`çš„å­ç±»ï¼Œç”¨äºåŒ…è£…åç¨‹å¹¶è°ƒåº¦æ‰§è¡Œã€‚

```python
import asyncio

async def background_task(name, delay):
    print(f"åå°ä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(delay)
    print(f"åå°ä»»åŠ¡ {name} å®Œæˆ")
    return f"{name} çš„ç»“æœ"

async def main():
    # åˆ›å»ºå¤šä¸ªä»»åŠ¡ï¼ˆç«‹å³å¼€å§‹æ‰§è¡Œï¼‰
    tasks = [
        asyncio.create_task(background_task("A", 2)),
        asyncio.create_task(background_task("B", 1)),
        asyncio.create_task(background_task("C", 3))
    ]

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    results = await asyncio.gather(*tasks)
    print("æ‰€æœ‰ä»»åŠ¡ç»“æœ:", results)

    # å¸¦è¶…æ—¶çš„ç­‰å¾…
    try:
        await asyncio.wait_for(asyncio.create_task(background_task("D", 5)), timeout=3)
    except asyncio.TimeoutError:
        print("ä»»åŠ¡Dè¶…æ—¶")

asyncio.run(main())
```

**Taskçš„é«˜çº§ç”¨æ³•**ï¼š
```python
import asyncio

async def cancellable_task():
    try:
        for i in range(10):
            print(f"å·¥ä½œä¸­... {i}")
            await asyncio.sleep(1)
    except asyncio.CancelledError:
        print("ä»»åŠ¡è¢«å–æ¶ˆ")
        # æ¸…ç†èµ„æº
        await asyncio.sleep(0.5)
        print("æ¸…ç†å®Œæˆ")
        raise

async def main():
    task = asyncio.create_task(cancellable_task())

    # 3ç§’åå–æ¶ˆä»»åŠ¡
    await asyncio.sleep(3)
    task.cancel()

    try:
        await task
    except asyncio.CancelledError:
        print("ä¸»åç¨‹æ•è·åˆ°å–æ¶ˆå¼‚å¸¸")

asyncio.run(main())
```

### 2ã€å¼‚æ­¥I/O

#### 2.1ã€å¼‚æ­¥æ–‡ä»¶æ“ä½œ

Python 3.4+æä¾›äº†å¼‚æ­¥æ–‡ä»¶æ“ä½œAPIã€‚

```python
import asyncio
import aiofiles  # ç¬¬ä¸‰æ–¹åº“ï¼ŒåŠŸèƒ½æ›´å®Œæ•´

async def read_file_async(filename):
    # ä½¿ç”¨aiofilesï¼ˆæ¨èï¼‰
    async with aiofiles.open(filename, 'r', encoding='utf-8') as f:
        content = await f.read()
        print(f"æ–‡ä»¶å†…å®¹é•¿åº¦: {len(content)}")
        return content

async def write_file_async(filename, content):
    async with aiofiles.open(filename, 'w', encoding='utf-8') as f:
        await f.write(content)
        print(f"å†™å…¥æ–‡ä»¶: {filename}")

async def process_files():
    # å¹¶å‘å¤„ç†å¤šä¸ªæ–‡ä»¶
    files = ['file1.txt', 'file2.txt', 'file3.txt']

    tasks = []
    for filename in files:
        content = f"è¿™æ˜¯ {filename} çš„å†…å®¹\n"
        tasks.append(write_file_async(filename, content))

    await asyncio.gather(*tasks)

    # å¹¶å‘è¯»å–æ–‡ä»¶
    read_tasks = [read_file_async(f) for f in files]
    contents = await asyncio.gather(*read_tasks)

    print(f"è¯»å–äº† {len(contents)} ä¸ªæ–‡ä»¶")

# å®‰è£…aiofiles: pip install aiofiles
# asyncio.run(process_files())
```

å¯¹æ¯”Javaçš„å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼š
```java
// Java NIO.2å¼‚æ­¥æ–‡ä»¶æ“ä½œ
AsynchronousFileChannel channel = AsynchronousFileChannel.open(
    Paths.get("file.txt"), StandardOpenOption.READ);

ByteBuffer buffer = ByteBuffer.allocate(1024);
Future<Integer> readResult = channel.read(buffer, 0);

// å¤„ç†ç»“æœ
while (!readResult.isDone()) {
    // å¯ä»¥åšå…¶ä»–å·¥ä½œ
}
```

#### 2.2ã€å¼‚æ­¥ç½‘ç»œè¯·æ±‚

ä½¿ç”¨`aiohttp`åº“è¿›è¡Œå¼‚æ­¥HTTPè¯·æ±‚ã€‚

```python
import asyncio
import aiohttp
import time

async def fetch_url(session, url):
    try:
        async with session.get(url) as response:
            print(f"è·å– {url} - çŠ¶æ€: {response.status}")
            content = await response.text()
            return {
                'url': url,
                'status': response.status,
                'length': len(content),
                'content': content[:100]  # åªè¿”å›å‰100ä¸ªå­—ç¬¦
            }
    except Exception as e:
        print(f"è¯·æ±‚ {url} å¤±è´¥: {e}")
        return {'url': url, 'error': str(e)}

async def fetch_multiple_urls(urls):
    # åˆ›å»ºä¼šè¯ï¼ˆå¤ç”¨è¿æ¥ï¼‰
    async with aiohttp.ClientSession() as session:
        # å¹¶å‘è¯·æ±‚å¤šä¸ªURL
        tasks = [fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks, return_exceptions=True)

        # å¤„ç†ç»“æœ
        success_count = 0
        for result in results:
            if isinstance(result, dict) and 'error' not in result:
                success_count += 1
                print(f"âœ… {result['url']}: {result['status']} ({result['length']} å­—ç¬¦)")
            else:
                print(f"âŒ å¤±è´¥: {result}")

        print(f"æˆåŠŸè¯·æ±‚: {success_count}/{len(urls)}")
        return results

async def main():
    urls = [
        'https://httpbin.org/delay/1',
        'https://httpbin.org/delay/2',
        'https://httpbin.org/status/200',
        'https://httpbin.org/status/404'
    ]

    start_time = time.time()
    await fetch_multiple_urls(urls)
    end_time = time.time()

    print(f"æ€»è€—æ—¶: {end_time - start_time:.2f}ç§’")

# å®‰è£…aiohttp: pip install aiohttp
# asyncio.run(main())
```

**å¼‚æ­¥HTTPå®¢æˆ·ç«¯çš„æœ€ä½³å®è·µ**ï¼š
```python
import asyncio
import aiohttp
from aiohttp import ClientTimeout, ClientSession

class AsyncHttpClient:
    def __init__(self, timeout=30, max_connections=100):
        self.timeout = ClientTimeout(total=timeout)
        self.connector = aiohttp.TCPConnector(limit=max_connections)

    async def __aenter__(self):
        self.session = ClientSession(
            timeout=self.timeout,
            connector=self.connector
        )
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.session.close()

    async def get(self, url, **kwargs):
        async with self.session.get(url, **kwargs) as response:
            return await response.json()

    async def post(self, url, data=None, json=None, **kwargs):
        async with self.session.post(url, data=data, json=json, **kwargs) as response:
            return await response.json()

async def api_client_example():
    async with AsyncHttpClient() as client:
        # GETè¯·æ±‚
        data = await client.get('https://api.github.com/users/python')
        print(f"Python GitHub followers: {data['followers']}")

        # POSTè¯·æ±‚
        result = await client.post('https://httpbin.org/post', json={'key': 'value'})
        print(f"POSTå“åº”: {result['json']}")

# asyncio.run(api_client_example())
```

### 3ã€å¼‚æ­¥ç¼–ç¨‹æœ€ä½³å®è·µ

#### 3.1ã€ä½•æ—¶ä½¿ç”¨å¼‚æ­¥

**é€‚åˆå¼‚æ­¥çš„åœºæ™¯**ï¼š
- I/Oå¯†é›†å‹æ“ä½œï¼ˆç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶è¯»å†™ï¼‰
- éœ€è¦å¹¶å‘å¤„ç†å¤§é‡è¿æ¥
- å®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨
- WebSocketã€èŠå¤©æœåŠ¡å™¨ã€APIç½‘å…³

```python
# âœ… é€‚åˆå¼‚æ­¥ï¼šç½‘ç»œçˆ¬è™«
import asyncio
import aiohttp

async def crawl_urls(urls):
    async with aiohttp.ClientSession() as session:
        tasks = [fetch_url(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
    return results

# âœ… é€‚åˆå¼‚æ­¥ï¼šWebSocketèŠå¤©æœåŠ¡å™¨
async def handle_chat_messages(websocket):
    async for message in websocket:
        await broadcast_to_other_clients(message)

# âŒ ä¸é€‚åˆå¼‚æ­¥ï¼šCPUå¯†é›†å‹è®¡ç®—
async def heavy_computation():
    # è¿™ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
    result = sum(i * i for i in range(10000000))
    return result
```

**ä¸é€‚åˆå¼‚æ­¥çš„åœºæ™¯**ï¼š
- CPUå¯†é›†å‹è®¡ç®—ï¼ˆæ•°å€¼è®¡ç®—ã€å›¾åƒå¤„ç†ï¼‰
- ç®€å•çš„è„šæœ¬ç¨‹åº
- åŒæ­¥ç¬¬ä¸‰æ–¹åº“çš„åŒ…è£…

#### 3.2ã€å¼‚æ­¥ä¸å¤šçº¿ç¨‹çš„é€‰æ‹©

**å¼‚æ­¥ vs å¤šçº¿ç¨‹å¯¹æ¯”**ï¼š

| ç»´åº¦ | å¼‚æ­¥ | å¤šçº¿ç¨‹ |
|-----|------|--------|
| å¹¶å‘æ¨¡å‹ | å•çº¿ç¨‹äº‹ä»¶å¾ªç¯ | å¤šçº¿ç¨‹æŠ¢å å¼ |
| å†…å­˜å ç”¨ | ä½ï¼ˆå•çº¿ç¨‹ï¼‰ | é«˜ï¼ˆæ¯ä¸ªçº¿ç¨‹æ ˆç©ºé—´ï¼‰ |
| ä¸Šä¸‹æ–‡åˆ‡æ¢ | å¿«ï¼ˆç”¨æˆ·æ€ï¼‰ | æ…¢ï¼ˆå†…æ ¸æ€ï¼‰ |
| ç¼–ç¨‹å¤æ‚åº¦ | é«˜ï¼ˆéœ€è¦å¼‚æ­¥æ€ç»´ï¼‰ | ä¸­ç­‰ |
| è°ƒè¯•éš¾åº¦ | è¾ƒé«˜ | ä¸­ç­‰ |
| é€‚ç”¨åœºæ™¯ | I/Oå¯†é›†å‹ | CPUå¯†é›†å‹æˆ–é˜»å¡æ“ä½œ |

**æ··åˆä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
import asyncio
import concurrent.futures
import time

def cpu_intensive_task(n):
    """CPUå¯†é›†å‹ä»»åŠ¡ - åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ"""
    return sum(i * i for i in range(n))

async def async_io_task():
    """I/Oå¯†é›†å‹ä»»åŠ¡ - å¼‚æ­¥æ‰§è¡Œ"""
    await asyncio.sleep(1)
    return "I/Oä»»åŠ¡å®Œæˆ"

async def mixed_workload():
    start_time = time.time()

    # åˆ›å»ºçº¿ç¨‹æ± æ‰§è¡Œå™¨
    loop = asyncio.get_event_loop()
    with concurrent.futures.ThreadPoolExecutor(max_workers=4) as executor:
        # å¹¶å‘æ‰§è¡Œä¸åŒç±»å‹çš„ä»»åŠ¡
        tasks = [
            # CPUå¯†é›†å‹ä»»åŠ¡åœ¨çº¿ç¨‹æ± ä¸­
            loop.run_in_executor(executor, cpu_intensive_task, 1000000),
            loop.run_in_executor(executor, cpu_intensive_task, 2000000),

            # I/Oå¯†é›†å‹ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
            async_io_task(),
            async_io_task(),
        ]

        results = await asyncio.gather(*tasks)

    end_time = time.time()
    print(f"æ··åˆä»»åŠ¡å®Œæˆï¼Œè€—æ—¶: {end_time - start_time:.2f}ç§’")
    print(f"ç»“æœ: {results}")

asyncio.run(mixed_workload())
```

#### 3.3ã€å¸¸è§é™·é˜±

**é™·é˜±1ï¼šåœ¨åç¨‹ä¸­è°ƒç”¨é˜»å¡å‡½æ•°**
```python
import asyncio
import time

# âŒ é”™è¯¯ï¼šé˜»å¡äº‹ä»¶å¾ªç¯
async def bad_example():
    time.sleep(2)  # é˜»å¡2ç§’ï¼Œæ•´ä¸ªäº‹ä»¶å¾ªç¯è¢«é˜»å¡
    return "å®Œæˆ"

# âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬
async def good_example():
    await asyncio.sleep(2)  # éé˜»å¡ç­‰å¾…
    return "å®Œæˆ"

# âœ… æˆ–è€…åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œé˜»å¡æ“ä½œ
async def blocking_in_thread():
    loop = asyncio.get_event_loop()
    with concurrent.futures.ThreadPoolExecutor() as executor:
        result = await loop.run_in_executor(executor, time.sleep, 2)
    return "å®Œæˆ"
```

**é™·é˜±2ï¼šå¿˜è®°await**
```python
import asyncio

async def forget_await():
    # âŒ é”™è¯¯ï¼šå¿˜è®°awaitï¼Œåç¨‹ä¸ä¼šæ‰§è¡Œ
    asyncio.sleep(1)
    print("è¿™å¯èƒ½ä¸ä¼šæŒ‰é¢„æœŸæ‰§è¡Œ")

async def correct_usage():
    # âœ… æ­£ç¡®ï¼šä½¿ç”¨await
    await asyncio.sleep(1)
    print("1ç§’åæ‰§è¡Œ")
```

**é™·é˜±3ï¼šå¼‚å¸¸å¤„ç†ä¸å½“**
```python
import asyncio

async def task_with_error():
    await asyncio.sleep(0.1)
    raise ValueError("ä»»åŠ¡å¤±è´¥")

async def bad_error_handling():
    # âŒ é”™è¯¯ï¼šå¼‚å¸¸è¢«å¿½ç•¥
    asyncio.create_task(task_with_error())

async def good_error_handling():
    # âœ… æ­£ç¡®ï¼šå¤„ç†å¼‚å¸¸
    task = asyncio.create_task(task_with_error())
    try:
        await task
    except ValueError as e:
        print(f"æ•è·åˆ°å¼‚å¸¸: {e}")

# âœ… ä½¿ç”¨gatherå¤„ç†å¼‚å¸¸
async def gather_with_exceptions():
    tasks = [
        asyncio.create_task(task_with_error()),
        asyncio.create_task(asyncio.sleep(1))
    ]

    results = await asyncio.gather(*tasks, return_exceptions=True)
    for i, result in enumerate(results):
        if isinstance(result, Exception):
            print(f"ä»»åŠ¡ {i} å¤±è´¥: {result}")
        else:
            print(f"ä»»åŠ¡ {i} æˆåŠŸ: {result}")
```

**é™·é˜±4ï¼šè¿‡åº¦ä½¿ç”¨å¼‚æ­¥**
```python
# âŒ è¿‡åº¦è®¾è®¡ï¼šç®€å•çš„åŒæ­¥ä»»åŠ¡ä¸éœ€è¦å¼‚æ­¥
async def over_engineered():
    result = await async_add(2, 3)
    return result

# âœ… ç®€å•ç›´æ¥
def simple():
    return 2 + 3
```

**æœ€ä½³å®è·µæ€»ç»“**ï¼š

1. **ä¿æŒå¼‚æ­¥å‡½æ•°çº¯å‡€**ï¼šå¼‚æ­¥å‡½æ•°ä¸­åªè°ƒç”¨å¼‚æ­¥å‡½æ•°
2. **æ­£ç¡®å¤„ç†å¼‚å¸¸**ï¼šä½¿ç”¨try/exceptåŒ…è£…å¯èƒ½å¤±è´¥çš„æ“ä½œ
3. **é¿å…é˜»å¡æ“ä½œ**ï¼šå°†é˜»å¡æ“ä½œæ”¾åˆ°çº¿ç¨‹æ± ä¸­
4. **åˆç†å¹¶å‘æ•°**ï¼šæ§åˆ¶åŒæ—¶è¿›è¡Œçš„ä»»åŠ¡æ•°é‡
5. **ä½¿ç”¨è¿æ¥æ± **ï¼šå¤ç”¨æ•°æ®åº“å’ŒHTTPè¿æ¥
6. **æ€§èƒ½ç›‘æ§**ï¼šä½¿ç”¨å·¥å…·ç›‘æ§å¼‚æ­¥ç¨‹åºæ€§èƒ½

```python
import asyncio
import aiohttp
from asyncio import Semaphore

async def rate_limited_fetch(session, url, semaphore):
    """å¸¦é€Ÿç‡é™åˆ¶çš„è¯·æ±‚"""
    async with semaphore:  # é™åˆ¶å¹¶å‘æ•°
        async with session.get(url) as response:
            return await response.text()

async def robust_fetch_all(urls, max_concurrent=10):
    """å¥å£®çš„æ‰¹é‡è¯·æ±‚"""
    semaphore = Semaphore(max_concurrent)

    async with aiohttp.ClientSession() as session:
        tasks = [
            rate_limited_fetch(session, url, semaphore)
            for url in urls
        ]

        results = await asyncio.gather(*tasks, return_exceptions=True)

        success_count = sum(1 for r in results if not isinstance(r, Exception))
        print(f"æˆåŠŸ: {success_count}/{len(urls)}")

        return results
```

---

**ğŸ“– ç³»åˆ—æ–‡ç« å¯¼èˆª**

ğŸ‘ˆ **ä¸Šä¸€ç¯‡**ï¼š[Javaå¼€å‘è€…è½¬æˆ˜Pythonï¼šåŸºç¡€ç¯‡](/pages/python-for-java-dev-base/) - PythonåŸºç¡€è¯­æ³•ã€æ•°æ®ç»“æ„ã€é¢å‘å¯¹è±¡ç¼–ç¨‹

ğŸ‘‰ **ä¸‹ä¸€ç¯‡**ï¼š[Javaå¼€å‘è€…è½¬æˆ˜Pythonï¼šçƒ­é—¨åº“ä¸è´¨é‡ç®¡ç†](/pages/python-for-java-dev-package/) - æ¢ç´¢Pythonç”Ÿæ€ç³»ç»Ÿå’Œå·¥ç¨‹å®è·µ

**ç¥ä½ å˜å¾—æ›´å¼º!**
