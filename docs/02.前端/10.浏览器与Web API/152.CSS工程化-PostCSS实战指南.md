---
title: CSSå·¥ç¨‹åŒ–-PostCSSå®æˆ˜æŒ‡å—
date: 2019-12-11 14:00:00
permalink: /pages/postcss-guide/
categories: 
  - å‰ç«¯
  - HTML & CSS
tags: 
  - CSS
  - PostCSS
  - å·¥ç¨‹åŒ–
  - è‡ªåŠ¨åŒ–
author: 
  name: è½©è¾•æ
  link: https://github.com/xuanyuanli
---

PostCSSæ˜¯ä¸€ä¸ªç”¨JavaScriptæ’ä»¶è½¬æ¢CSSçš„å·¥å…·ï¼Œå®ƒé€šè¿‡å¼ºå¤§çš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œä¸ºCSSå¼€å‘æä¾›äº†è‡ªåŠ¨åŒ–å¤„ç†ã€æœªæ¥ç‰¹æ€§æ”¯æŒã€ä»£ç ä¼˜åŒ–ç­‰èƒ½åŠ›ã€‚

æœ¬æ–‡å°†æ·±å…¥ä»‹ç»PostCSSçš„æ ¸å¿ƒæ¦‚å¿µã€å¸¸ç”¨æ’ä»¶ã€Viteé›†æˆå®æˆ˜ã€è‡ªå®šä¹‰æ’ä»¶å¼€å‘ç­‰å†…å®¹ï¼Œå¸®åŠ©ä½ æŒæ¡PostCSSåœ¨ç°ä»£CSSå·¥ç¨‹åŒ–ä¸­çš„åº”ç”¨ã€‚

<!-- more -->

## ä¸€ã€PostCSSæ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯PostCSS

PostCSSæ˜¯ä¸€ä¸ªç”¨JavaScriptè½¬æ¢CSSçš„å·¥å…·ï¼Œæœ¬èº«åªæä¾›äº†CSSè§£æå™¨å’Œæ¡†æ¶ï¼Œå…·ä½“åŠŸèƒ½é€šè¿‡æ’ä»¶å®ç°ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- ğŸ”Œ **æ’ä»¶åŒ–æ¶æ„**ï¼šæ‰€æœ‰åŠŸèƒ½éƒ½é€šè¿‡æ’ä»¶å®ç°
- âš¡ **é«˜æ€§èƒ½**ï¼šæ¯”ä¼ ç»Ÿé¢„å¤„ç†å™¨å¿«3-30å€
- ğŸ¯ **ç²¾ç¡®æ§åˆ¶**ï¼šåªä½¿ç”¨éœ€è¦çš„æ’ä»¶
- ğŸ”„ **æ¸è¿›å¢å¼º**ï¼šå¯ä»¥ä¸ç°æœ‰å·¥å…·é…åˆä½¿ç”¨
- ğŸ“¦ **ç”Ÿæ€ä¸°å¯Œ**ï¼šè¶…è¿‡200+å®˜æ–¹å’Œç¤¾åŒºæ’ä»¶

**å·¥ä½œåŸç†**ï¼š

```
CSSæºç  â†’ PostCSSè§£æ â†’ AST â†’ æ’ä»¶è½¬æ¢ â†’ AST â†’ è¾“å‡ºCSS
```

```javascript
// PostCSSå·¥ä½œæµç¨‹ç¤ºæ„
const postcss = require('postcss');

postcss([
  require('autoprefixer'),
  require('cssnano')
])
  .process(css, { from: 'src/app.css', to: 'dist/app.css' })
  .then(result => {
    console.log(result.css);
  });
```

### 1.2 PostCSS vs é¢„å¤„ç†å™¨

**å¯¹æ¯”è¡¨æ ¼**ï¼š

| ç‰¹æ€§ | PostCSS | Sass/Less | ä¼˜åŠ¿ |
|------|---------|-----------|------|
| **æ€§èƒ½** | å¿«é€Ÿ | è¾ƒæ…¢ | PostCSS |
| **çµæ´»æ€§** | é«˜ï¼ˆæŒ‰éœ€é€‰æ‹©æ’ä»¶ï¼‰ | å›ºå®š | PostCSS |
| **å­¦ä¹ æˆæœ¬** | ä½ | ä¸­ç­‰ | PostCSS |
| **ç”Ÿæ€** | ä¸°å¯Œ | æˆç†Ÿ | å„æœ‰ä¼˜åŠ¿ |
| **æœªæ¥CSS** | åŸç”Ÿæ”¯æŒ | éœ€è¦é¢å¤–è½¬æ¢ | PostCSS |
| **åµŒå¥—** | éœ€æ’ä»¶ | åŸç”Ÿæ”¯æŒ | Sass/Less |
| **å˜é‡** | éœ€æ’ä»¶ | åŸç”Ÿæ”¯æŒ | Sass/Less |

**PostCSSä¼˜åŠ¿**ï¼š

```css
/* å¯ä»¥ç›´æ¥ä½¿ç”¨æœªæ¥çš„CSSç‰¹æ€§ */
.element {
  /* CSSåµŒå¥—ï¼ˆCSS Nestingï¼‰ */
  &:hover {
    color: blue;
  }
  
  /* è‡ªå®šä¹‰å±æ€§ */
  color: var(--primary-color);
  
  /* é¢œè‰²å‡½æ•° */
  background: color-mix(in srgb, blue 50%, red);
}

/* PostCSSé€šè¿‡æ’ä»¶è½¬æ¢ä¸ºå…¼å®¹ä»£ç  */
```

**é¢„å¤„ç†å™¨ä¼˜åŠ¿**ï¼š

```scss
// Sassæœ‰æ›´ä¸°å¯Œçš„ç¼–ç¨‹èƒ½åŠ›
@function calculate-rem($px) {
  @return ($px / 16px) * 1rem;
}

@mixin flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

.element {
  font-size: calculate-rem(24px);
  @include flex-center;
}
```

**ç»„åˆä½¿ç”¨**ï¼š

```javascript
// vite.config.js - åŒæ—¶ä½¿ç”¨Sasså’ŒPostCSS
export default {
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "@/styles/variables.scss";`
      }
    },
    postcss: {
      plugins: [
        autoprefixer(),
        cssnano()
      ]
    }
  }
}
```

### 1.3 ä¸ºä»€ä¹ˆé€‰æ‹©PostCSS

**ä½¿ç”¨åœºæ™¯**ï¼š

âœ… **å¿…é¡»ä½¿ç”¨PostCSSçš„æƒ…å†µ**ï¼š
- éœ€è¦è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€
- éœ€è¦ä½¿ç”¨æœªæ¥CSSç‰¹æ€§
- éœ€è¦ä¼˜åŒ–å’Œå‹ç¼©CSS
- éœ€è¦è‡ªå®šä¹‰CSSè½¬æ¢

âœ… **PostCSSä¼˜äºé¢„å¤„ç†å™¨çš„åœºæ™¯**ï¼š
- è¿½æ±‚æ€§èƒ½
- åªéœ€è¦éƒ¨åˆ†é¢„å¤„ç†å™¨åŠŸèƒ½
- æƒ³è¦ä½¿ç”¨åŸç”ŸCSSè¯­æ³•
- éœ€è¦ä¸å…¶ä»–å·¥å…·æ— ç¼é›†æˆ

âš ï¸ **å¯èƒ½ä¸éœ€è¦PostCSSçš„æƒ…å†µ**ï¼š
- ç®€å•çš„é™æ€ç½‘ç«™
- å·²æœ‰å®Œå–„çš„Sass/Lesså·¥ä½œæµä¸”æ»¡è¶³éœ€æ±‚
- å›¢é˜Ÿä¸ç†Ÿæ‚‰å·¥ç¨‹åŒ–å·¥å…·

## äºŒã€æ ¸å¿ƒæ’ä»¶è¯¦è§£

### 2.1 autoprefixer

è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€ï¼Œæ˜¯æœ€å¸¸ç”¨çš„PostCSSæ’ä»¶ã€‚

**å®‰è£…**ï¼š

```bash
npm install autoprefixer --save-dev
```

**é…ç½®**ï¼š

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('autoprefixer')({
      overrideBrowserslist: [
        '> 1%',
        'last 2 versions',
        'not dead'
      ]
    })
  ]
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```css
/* è¾“å…¥ */
.element {
  display: flex;
  user-select: none;
  transition: transform 0.3s;
}

/* autoprefixerè¾“å‡º */
.element {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
  -webkit-transition: -webkit-transform 0.3s;
  transition: -webkit-transform 0.3s;
  -o-transition: transform 0.3s;
  transition: transform 0.3s;
  transition: transform 0.3s, -webkit-transform 0.3s;
}
```

**Browserslisté…ç½®**ï¼š

Browserslistç”¨äºæŒ‡å®šé¡¹ç›®æ”¯æŒçš„æµè§ˆå™¨èŒƒå›´ï¼Œautoprefixerä¼šæ ¹æ®è¿™ä¸ªé…ç½®å†³å®šæ·»åŠ å“ªäº›å‰ç¼€ã€‚

**é…ç½®æ–¹å¼ä¸€ï¼špackage.json**

```json
// package.json
{
  "browserslist": [
    "> 1%",              // å…¨çƒä½¿ç”¨ç‡ > 1% çš„æµè§ˆå™¨
    "last 2 versions",   // æ¯ä¸ªæµè§ˆå™¨çš„æœ€æ–°2ä¸ªç‰ˆæœ¬
    "not dead",          // æ’é™¤å®˜æ–¹ä¸å†ç»´æŠ¤çš„æµè§ˆå™¨
    "not ie <= 11"       // æ’é™¤IE11åŠä»¥ä¸‹ç‰ˆæœ¬
  ]
}
```

**é…ç½®æ–¹å¼äºŒï¼š.browserslistrcæ–‡ä»¶**

```
# .browserslistrc

# ç”Ÿäº§ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
> 1%                    # å¸‚åœºä»½é¢å¤§äº1%
last 2 versions         # æœ€æ–°çš„2ä¸ªç‰ˆæœ¬
not dead                # è¿˜åœ¨ç»´æŠ¤çš„æµè§ˆå™¨

# å¼€å‘ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
[development]
last 1 chrome version   # Chromeæœ€æ–°ç‰ˆæœ¬
last 1 firefox version  # Firefoxæœ€æ–°ç‰ˆæœ¬
```

**å¸¸ç”¨æŸ¥è¯¢è¯­å¥è¯´æ˜**ï¼š

| æŸ¥è¯¢è¯­å¥ | å«ä¹‰ | ç¤ºä¾‹ |
|---------|------|------|
| `> 1%` | å…¨çƒä½¿ç”¨ç‡ > 1% | è¦†ç›–ä¸»æµæµè§ˆå™¨ |
| `> 5% in CN` | ä¸­å›½ä½¿ç”¨ç‡ > 5% | é’ˆå¯¹ä¸­å›½å¸‚åœº |
| `last 2 versions` | æ¯ä¸ªæµè§ˆå™¨æœ€æ–°2ç‰ˆæœ¬ | Chrome 120, 119 |
| `last 2 Chrome versions` | Chromeæœ€æ–°2ç‰ˆæœ¬ | é’ˆå¯¹ç‰¹å®šæµè§ˆå™¨ |
| `not dead` | æ’é™¤24ä¸ªæœˆå†…æ— å®˜æ–¹æ”¯æŒçš„ | æ’é™¤æ—§ç‰ˆæµè§ˆå™¨ |
| `not ie <= 11` | æ’é™¤IE11åŠä»¥ä¸‹ | ä¸æ”¯æŒæ—§IE |
| `iOS >= 10` | iOS 10åŠä»¥ä¸Š | ç§»åŠ¨ç«¯æœ€ä½ç‰ˆæœ¬ |
| `Firefox ESR` | Firefoxé•¿æœŸæ”¯æŒç‰ˆ | ä¼ä¸šç‰ˆFirefox |

Browserslist çš„å¤„ç†é€»è¾‘æ˜¯ï¼šå…ˆæ”¶é›†æ‰€æœ‰ æ­£å‘æ¡ä»¶ï¼ˆå¦‚ > 1%ã€last 2 versionsï¼‰ çš„å¹¶é›†ï¼ˆå³ ORï¼‰ï¼Œç„¶ååº”ç”¨æ‰€æœ‰ å¦å®šæ¡ä»¶ï¼ˆä»¥ not å¼€å¤´ï¼‰ è¿›è¡Œå‰”é™¤ã€‚
æ•´ä½“é€»è¾‘å¯ä»¥ç†è§£ä¸ºï¼š
```
(result from "> 1%" OR "last 2 versions")
AND (not dead)
AND (not ie <= 11)
```

**å®æˆ˜é…ç½®ç¤ºä¾‹**ï¼š

```json
// ç°ä»£Webåº”ç”¨ï¼ˆä¸è€ƒè™‘IEï¼‰
{
  "browserslist": [
    "> 0.5%",
    "last 2 versions",
    "not dead",
    "not op_mini all"
  ]
}

// ç§»åŠ¨ç«¯åº”ç”¨
{
  "browserslist": [
    "iOS >= 10",
    "Android >= 5",
    "last 2 versions"
  ]
}

// ä¼ä¸šçº§åº”ç”¨ï¼ˆéœ€è¦å…¼å®¹IEï¼‰
{
  "browserslist": [
    "> 1%",
    "last 2 versions",
    "ie >= 9"
  ]
}

// ä¸­å›½å¸‚åœºå®šåˆ¶
{
  "browserslist": [
    "> 1% in CN",
    "last 2 versions",
    "not dead",
    "not ie <= 10"
  ]
}
```

**æŸ¥çœ‹é…ç½®è¦†ç›–çš„æµè§ˆå™¨**ï¼š

```bash
# å®‰è£…browserslistå‘½ä»¤è¡Œå·¥å…·
npm install -g browserslist

# æŸ¥çœ‹å½“å‰é…ç½®è¦†ç›–å“ªäº›æµè§ˆå™¨
npx browserslist

# è¾“å‡ºç¤ºä¾‹ï¼š
# chrome 120
# chrome 119
# edge 120
# edge 119
# firefox 121
# firefox 120
# safari 17.1
# safari 17.0
```

**åœ¨çº¿å·¥å…·**ï¼šè®¿é—® [https://browsersl.ist/](https://browsersl.ist/) å¯è§†åŒ–æŸ¥çœ‹é…ç½®æ•ˆæœã€‚

### 2.2 postcss-preset-env

ä½¿ç”¨æœªæ¥çš„CSSç‰¹æ€§ï¼Œä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå½“å‰æµè§ˆå™¨å…¼å®¹çš„ä»£ç ã€‚

**å®‰è£…**ï¼š

```bash
npm install postcss-preset-env --save-dev
```

**é…ç½®**ï¼š

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('postcss-preset-env')({
      stage: 2, // ä½¿ç”¨stage 2çš„ç‰¹æ€§
      features: {
        'nesting-rules': true,
        'custom-properties': true,
        'custom-media-queries': true
      },
      autoprefixer: {
        grid: true
      }
    })
  ]
}
```

**Stageè¯´æ˜**ï¼š

```
Stage 0: Aspirational - è®¾æƒ³é˜¶æ®µ
Stage 1: Experimental - å®éªŒé˜¶æ®µ
Stage 2: Allowable - å…è®¸ä½¿ç”¨ï¼ˆé»˜è®¤ï¼‰
Stage 3: Embraced - å³å°†æˆä¸ºæ ‡å‡†
Stage 4: Standardized - å·²æ ‡å‡†åŒ–
```

**æ”¯æŒçš„ç‰¹æ€§ç¤ºä¾‹**ï¼š

```css
/* è¾“å…¥ï¼šä½¿ç”¨æœªæ¥CSSç‰¹æ€§ */
:root {
  --primary-color: #667eea;
  --font-size-large: 18px;
}

@custom-media --small-viewport (max-width: 768px);

.container {
  /* CSSåµŒå¥— */
  color: var(--primary-color);
  
  & .title {
    font-size: var(--font-size-large);
  }
  
  &:hover {
    opacity: 0.8;
  }
  
  /* è‡ªå®šä¹‰åª’ä½“æŸ¥è¯¢ */
  @media (--small-viewport) {
    padding: 10px;
  }
}

/* é¢œè‰²å‡½æ•° */
.button {
  background: color-mod(var(--primary-color) alpha(80%));
}

/* è¾“å‡ºï¼šè½¬æ¢ä¸ºå…¼å®¹ä»£ç  */
:root {
  --primary-color: #667eea;
  --font-size-large: 18px;
}

.container {
  color: #667eea;
  color: var(--primary-color);
}

.container .title {
  font-size: 18px;
  font-size: var(--font-size-large);
}

.container:hover {
  opacity: 0.8;
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
}

.button {
  background: rgba(102, 126, 234, 0.8);
}
```

### 2.3 cssnano

CSSå‹ç¼©å’Œä¼˜åŒ–å·¥å…·ã€‚

**å®‰è£…**ï¼š

```bash
npm install cssnano --save-dev
```

**é…ç½®**ï¼š

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('cssnano')({
      preset: ['default', {
        discardComments: {
          removeAll: true  // ç§»é™¤æ‰€æœ‰æ³¨é‡Š
        },
        normalizeWhitespace: true,     // è§„èŒƒåŒ–ç©ºç™½
        colormin: true,                // å‹ç¼©é¢œè‰²å€¼
        minifyFontValues: true,        // å‹ç¼©å­—ä½“å£°æ˜
        minifySelectors: true,         // å‹ç¼©é€‰æ‹©å™¨
        mergeLonghand: true,           // åˆå¹¶å±æ€§
        mergeRules: true,              // åˆå¹¶è§„åˆ™
        discardDuplicates: true,       // ç§»é™¤é‡å¤è§„åˆ™
        discardUnused: true,           // ç§»é™¤æœªä½¿ç”¨çš„è§„åˆ™
        zindex: false                  // ä¸ä¼˜åŒ–z-index
      }]
    })
  ]
}
```

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```css
/* è¾“å…¥ */
.element {
  /* è¿™æ˜¯æ³¨é‡Š */
  margin-top: 10px;
  margin-right: 20px;
  margin-bottom: 10px;
  margin-left: 20px;
  background-color: #ffffff;
  font-weight: normal;
}

.element {
  padding: 15px;
}

/* è¾“å‡º */
.element{margin:10px 20px;background-color:#fff;font-weight:400;padding:15px}
```

**é«˜çº§é…ç½®**ï¼š

```javascript
// ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
const isProduction = process.env.NODE_ENV === 'production';

module.exports = {
  plugins: [
    isProduction && require('cssnano')({
      preset: ['advanced', {
        autoprefixer: false,  // å·²ç»ä½¿ç”¨autoprefixeræ’ä»¶
        discardComments: { removeAll: true },
        reduceIdents: false,  // ä¸ç¼©çŸ­@keyframesåç§°
        zindex: false         // ä¸ä¼˜åŒ–z-index
      }]
    })
  ].filter(Boolean)
}
```

### 2.4 postcss-nested

æä¾›ç±»ä¼¼Sassçš„åµŒå¥—è¯­æ³•ã€‚

**å®‰è£…**ï¼š

```bash
npm install postcss-nested --save-dev
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```css
/* è¾“å…¥ */
.card {
  background: white;
  padding: 20px;
  
  &__header {
    border-bottom: 1px solid #e0e0e0;
    
    &-title {
      font-size: 18px;
    }
  }
  
  &__body {
    padding: 15px 0;
  }
  
  &:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  @media (max-width: 768px) {
    padding: 10px;
  }
}

/* è¾“å‡º */
.card {
  background: white;
  padding: 20px;
}

.card__header {
  border-bottom: 1px solid #e0e0e0;
}

.card__header-title {
  font-size: 18px;
}

.card__body {
  padding: 15px 0;
}

.card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  .card {
    padding: 10px;
  }
}
```

**é«˜çº§åµŒå¥—**ï¼š

```css
/* åµŒå¥—@è§„åˆ™ */
.component {
  color: black;
  
  @nest .theme-dark & {
    color: white;
  }
  
  @media (min-width: 768px) {
    font-size: 16px;
    
    @nest .large-text & {
      font-size: 20px;
    }
  }
}
```

## ä¸‰ã€å¸¸ç”¨æ’ä»¶ç”Ÿæ€

### 3.1 postcss-import

å¤„ç†`@import`è¯­å¥ï¼Œå†…è”å¯¼å…¥çš„æ–‡ä»¶ã€‚

**å®‰è£…ä¸é…ç½®**ï¼š

```bash
npm install postcss-import --save-dev
```

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('postcss-import')({
      path: ['src/styles']  // æŸ¥æ‰¾è·¯å¾„
    }),
    // å…¶ä»–æ’ä»¶...
  ]
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```css
/* styles/variables.css */
:root {
  --primary: #667eea;
  --secondary: #764ba2;
}

/* styles/mixins.css */
.flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

/* main.css */
@import 'variables.css';
@import 'mixins.css';

.container {
  color: var(--primary);
}

/* è¾“å‡ºï¼šæ‰€æœ‰å¯¼å…¥çš„å†…å®¹ä¼šè¢«å†…è” */
:root {
  --primary: #667eea;
  --secondary: #764ba2;
}

.flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

.container {
  color: var(--primary);
}
```

### 3.2 postcss-custom-properties

å¤„ç†CSSè‡ªå®šä¹‰å±æ€§ï¼ˆCSSå˜é‡ï¼‰ã€‚

```bash
npm install postcss-custom-properties --save-dev
```

```css
/* è¾“å…¥ */
:root {
  --color-primary: #667eea;
  --spacing: 16px;
}

.button {
  background: var(--color-primary);
  padding: var(--spacing);
}

/* è¾“å‡ºï¼šç”Ÿæˆå›é€€å€¼ */
:root {
  --color-primary: #667eea;
  --spacing: 16px;
}

.button {
  background: #667eea;
  background: var(--color-primary);
  padding: 16px;
  padding: var(--spacing);
}
```

### 3.3 postcss-mixins

æä¾›mixinsåŠŸèƒ½ã€‚

```bash
npm install postcss-mixins --save-dev
```

```css
/* å®šä¹‰mixin */
@define-mixin flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

@define-mixin button $bg-color, $text-color: white {
  background: $(bg-color);
  color: $(text-color);
  padding: 10px 20px;
  border-radius: 4px;
}

/* ä½¿ç”¨mixin */
.container {
  @mixin flex-center;
}

.primary-btn {
  @mixin button #667eea;
}

.secondary-btn {
  @mixin button #764ba2, black;
}
```

### 3.4 postcss-simple-vars

æä¾›Sassé£æ ¼çš„å˜é‡ã€‚

```bash
npm install postcss-simple-vars --save-dev
```

```css
/* è¾“å…¥ */
$primary: #667eea;
$spacing: 16px;

.button {
  background: $primary;
  padding: $spacing;
}

/* è¾“å‡º */
.button {
  background: #667eea;
  padding: 16px;
}
```

### 3.5 å…¶ä»–å®ç”¨æ’ä»¶

**postcss-pxtorem**ï¼špxè½¬rem

```bash
npm install postcss-pxtorem --save-dev
```

```javascript
require('postcss-pxtorem')({
  rootValue: 16,
  propList: ['*'],
  selectorBlackList: ['.no-rem']
})
```

```css
/* è¾“å…¥ */
.element {
  font-size: 16px;
  padding: 20px;
}

/* è¾“å‡º */
.element {
  font-size: 1rem;
  padding: 1.25rem;
}
```

**postcss-px-to-viewport**ï¼špxè½¬vw/vh

```bash
npm install postcss-px-to-viewport --save-dev
```

```javascript
require('postcss-px-to-viewport')({
  viewportWidth: 750,
  viewportUnit: 'vw',
  minPixelValue: 1
})
```

**postcss-sorting**ï¼šCSSå±æ€§æ’åº

```bash
npm install postcss-sorting --save-dev
```

```javascript
require('postcss-sorting')({
  'order': [
    'custom-properties',
    'declarations'
  ],
  'properties-order': 'alphabetical'
})
```

## å››ã€Viteé›†æˆå®æˆ˜

### 4.1 åŸºç¡€é…ç½®

**å®‰è£…ä¾èµ–**ï¼š

```bash
npm install -D \
  autoprefixer \
  postcss-preset-env \
  postcss-nested \
  cssnano
```

**é…ç½®PostCSS**ï¼š

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('postcss-import'),
    require('postcss-nested'),
    require('postcss-preset-env')({
      stage: 2,
      features: {
        'nesting-rules': false  // å·²ä½¿ç”¨postcss-nested
      }
    }),
    require('autoprefixer'),
    process.env.NODE_ENV === 'production' && require('cssnano')({
      preset: 'default'
    })
  ].filter(Boolean)
}
```

**Viteé…ç½®**ï¼š

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [vue()],
  css: {
    postcss: './postcss.config.js',
    devSourcemap: true  // å¼€å‘ç¯å¢ƒå¯ç”¨source map
  }
});
```

### 4.2 å®Œæ•´é¡¹ç›®é…ç½®

**é¡¹ç›®ç»“æ„**ï¼š

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â”œâ”€â”€ reset.css
â”‚   â”‚   â”‚   â””â”€â”€ variables.css
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ button.css
â”‚   â”‚   â”‚   â””â”€â”€ card.css
â”‚   â”‚   â”œâ”€â”€ utilities/
â”‚   â”‚   â”‚   â””â”€â”€ spacing.css
â”‚   â”‚   â””â”€â”€ main.css
â”‚   â”œâ”€â”€ components/
â”‚   â””â”€â”€ App.vue
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ vite.config.js
â””â”€â”€ package.json
```

**variables.css**ï¼š

```css
/* src/styles/base/variables.css */
:root {
  /* Colors */
  --color-primary: #667eea;
  --color-secondary: #764ba2;
  --color-success: #2ecc71;
  --color-danger: #e74c3c;
  
  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  
  /* Typography */
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  
  /* Border */
  --border-radius: 4px;
  --border-color: #e0e0e0;
}
```

**main.css**ï¼š

```css
/* src/styles/main.css */
@import './base/reset.css';
@import './base/variables.css';
@import './components/button.css';
@import './components/card.css';
@import './utilities/spacing.css';

/* ä½¿ç”¨åµŒå¥—è¯­æ³• */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--spacing-md);
  
  @media (min-width: 768px) {
    padding: var(--spacing-lg);
  }
  
  @media (min-width: 1024px) {
    padding: var(--spacing-xl);
  }
}
```

**button.css**ï¼š

```css
/* src/styles/components/button.css */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm) var(--spacing-md);
  border: none;
  border-radius: var(--border-radius);
  font-size: var(--font-size-base);
  cursor: pointer;
  transition: all 0.3s;
  
  &:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  
  &:active {
    transform: translateY(0);
  }
  
  &--primary {
    background: var(--color-primary);
    color: white;
  }
  
  &--secondary {
    background: var(--color-secondary);
    color: white;
  }
  
  &--large {
    padding: var(--spacing-md) var(--spacing-lg);
    font-size: var(--font-size-lg);
  }
  
  &--disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }
}
```

### 4.3 æ€§èƒ½ä¼˜åŒ–é…ç½®

```javascript
// vite.config.js - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';

export default defineConfig(({ mode }) => {
  const isProduction = mode === 'production';
  
  return {
    plugins: [vue()],
    css: {
      postcss: './postcss.config.js',
      devSourcemap: !isProduction
    },
    build: {
      cssCodeSplit: true,  // CSSä»£ç åˆ†å‰²
      cssMinify: 'lightningcss',  // ä½¿ç”¨lightningcsså‹ç¼©
      rollupOptions: {
        output: {
          assetFileNames: 'assets/[name]-[hash][extname]',
          manualChunks(id) {
            // åˆ†ç¦»ç¬¬ä¸‰æ–¹CSS
            if (id.includes('node_modules')) {
              return 'vendor';
            }
          }
        }
      }
    }
  };
});
```

## äº”ã€è‡ªå®šä¹‰æ’ä»¶å¼€å‘

### 5.1 æ’ä»¶åŸºç¡€

**PostCSSæ’ä»¶ç»“æ„**ï¼š

```javascript
// my-plugin.js
module.exports = (opts = {}) => {
  return {
    postcssPlugin: 'my-plugin',
    
    // æ’ä»¶é’©å­
    Once(root, { result }) {
      // å¤„ç†æ•´ä¸ªCSSæ ‘
    },
    
    Declaration(decl, { result }) {
      // å¤„ç†æ¯ä¸ªå£°æ˜
    },
    
    AtRule(atRule, { result }) {
      // å¤„ç†@è§„åˆ™
    },
    
    Rule(rule, { result }) {
      // å¤„ç†è§„åˆ™
    }
  }
}

module.exports.postcss = true
```

### 5.2 å®æˆ˜ï¼špxè‡ªåŠ¨è½¬æ¢æ’ä»¶

**éœ€æ±‚**ï¼šè‡ªåŠ¨å°†pxè½¬æ¢ä¸ºremï¼Œä½†ä¿ç•™ç‰¹å®šå±æ€§ã€‚

```javascript
// postcss-px-to-rem.js
const pxRegex = /(\d+(\.\d+)?)px/g;

module.exports = (opts = {}) => {
  const {
    rootValue = 16,
    unitPrecision = 5,
    propBlackList = [],
    selectorBlackList = [],
    replace = true,
    mediaQuery = false,
    minPixelValue = 0
  } = opts;
  
  return {
    postcssPlugin: 'postcss-px-to-rem',
    
    Declaration(decl) {
      // æ£€æŸ¥å±æ€§æ˜¯å¦åœ¨é»‘åå•ä¸­
      if (propBlackList.includes(decl.prop)) {
        return;
      }
      
      // æ£€æŸ¥é€‰æ‹©å™¨æ˜¯å¦åœ¨é»‘åå•ä¸­
      const rule = decl.parent;
      if (rule && selectorBlackList.some(sel => rule.selector.includes(sel))) {
        return;
      }
      
      // è½¬æ¢pxä¸ºrem
      if (decl.value.includes('px')) {
        const newValue = decl.value.replace(pxRegex, (match, num) => {
          const pixels = parseFloat(num);
          
          // å°äºæœ€å°å€¼åˆ™ä¸è½¬æ¢
          if (pixels < minPixelValue) {
            return match;
          }
          
          const rem = (pixels / rootValue).toFixed(unitPrecision);
          return `${rem}rem`;
        });
        
        if (replace) {
          decl.value = newValue;
        } else {
          decl.cloneBefore({ value: newValue });
        }
      }
    },
    
    AtRule(atRule) {
      // å¤„ç†åª’ä½“æŸ¥è¯¢
      if (mediaQuery && atRule.name === 'media') {
        if (atRule.params.includes('px')) {
          atRule.params = atRule.params.replace(pxRegex, (match, num) => {
            const pixels = parseFloat(num);
            const rem = (pixels / rootValue).toFixed(unitPrecision);
            return `${rem}rem`;
          });
        }
      }
    }
  };
};

module.exports.postcss = true;
```

**ä½¿ç”¨æ’ä»¶**ï¼š

```javascript
// postcss.config.js
module.exports = {
  plugins: [
    require('./postcss-px-to-rem')({
      rootValue: 16,
      propBlackList: ['border', 'border-width'],
      selectorBlackList: ['.no-rem'],
      minPixelValue: 2
    })
  ]
}
```

```css
/* è¾“å…¥ */
.element {
  font-size: 16px;
  padding: 20px;
  border: 1px solid;  /* é»‘åå•å±æ€§ä¸è½¬æ¢ */
}

.no-rem {
  margin: 16px;  /* é»‘åå•é€‰æ‹©å™¨ä¸è½¬æ¢ */
}

/* è¾“å‡º */
.element {
  font-size: 1rem;
  padding: 1.25rem;
  border: 1px solid;
}

.no-rem {
  margin: 16px;
}
```

### 5.3 å®æˆ˜ï¼šè‡ªåŠ¨æ·»åŠ æ³¨é‡Šæ’ä»¶

```javascript
// postcss-add-comment.js
module.exports = (opts = {}) => {
  const { comment = 'Generated by PostCSS' } = opts;
  
  return {
    postcssPlugin: 'postcss-add-comment',
    
    Once(root) {
      // åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ æ³¨é‡Š
      root.prepend({ text: comment });
    },
    
    Rule(rule) {
      // ä¸ºæ¯ä¸ªè§„åˆ™æ·»åŠ æ³¨é‡Š
      if (opts.addRuleComment) {
        rule.prepend({ 
          text: `Selector: ${rule.selector}` 
        });
      }
    }
  };
};

module.exports.postcss = true;
```

### 5.4 æ’ä»¶æµ‹è¯•

```javascript
// test/my-plugin.test.js
const postcss = require('postcss');
const plugin = require('../postcss-px-to-rem');

async function run(input, output, opts = {}) {
  const result = await postcss([plugin(opts)])
    .process(input, { from: undefined });
  
  expect(result.css).toEqual(output);
  expect(result.warnings()).toHaveLength(0);
}

test('converts px to rem', async () => {
  await run(
    '.element { font-size: 16px; }',
    '.element { font-size: 1rem; }',
    { rootValue: 16 }
  );
});

test('respects blacklist', async () => {
  await run(
    '.element { border: 1px solid; }',
    '.element { border: 1px solid; }',
    { propBlackList: ['border'] }
  );
});
```

## å…­ã€æœ€ä½³å®è·µ

### 6.1 æ’ä»¶é€‰æ‹©ä¸é…ç½®

**æ¨èæ’ä»¶ç»„åˆ**ï¼š

```javascript
// postcss.config.js - é€šç”¨é…ç½®
module.exports = {
  plugins: [
    // 1. å¯¼å…¥å¤„ç†ï¼ˆæœ€å…ˆï¼‰
    require('postcss-import'),
    
    // 2. è¯­æ³•æ‰©å±•
    require('postcss-nested'),
    require('postcss-simple-vars'),
    
    // 3. æœªæ¥ç‰¹æ€§
    require('postcss-preset-env')({
      stage: 2,
      features: {
        'nesting-rules': false
      }
    }),
    
    // 4. è‡ªåŠ¨å‰ç¼€
    require('autoprefixer'),
    
    // 5. ä¼˜åŒ–å‹ç¼©ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    process.env.NODE_ENV === 'production' && require('cssnano')
  ].filter(Boolean)
}
```

**ç§»åŠ¨ç«¯é¡¹ç›®é…ç½®**ï¼š

```javascript
module.exports = {
  plugins: [
    require('postcss-import'),
    require('postcss-nested'),
    require('postcss-pxtorem')({
      rootValue: 37.5,  // åŸºäº750è®¾è®¡ç¨¿
      propList: ['*'],
      selectorBlackList: ['.no-rem']
    }),
    require('autoprefixer'),
    require('cssnano')
  ]
}
```

**å“åº”å¼é¡¹ç›®é…ç½®**ï¼š

```javascript
module.exports = {
  plugins: [
    require('postcss-import'),
    require('postcss-nested'),
    require('postcss-custom-media')({
      importFrom: './src/styles/media-queries.css'
    }),
    require('autoprefixer'),
    require('cssnano')
  ]
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–

**ç¼“å­˜ä¼˜åŒ–**ï¼š

```javascript
// vite.config.js
export default {
  css: {
    postcss: './postcss.config.js'
  },
  optimizeDeps: {
    include: ['postcss']  // é¢„æ„å»ºä¾èµ–
  }
}
```

**æŒ‰éœ€åŠ è½½æ’ä»¶**ï¼š

```javascript
const isProduction = process.env.NODE_ENV === 'production';
const isDevelopment = !isProduction;

module.exports = {
  plugins: [
    require('postcss-import'),
    require('postcss-nested'),
    
    // å¼€å‘ç¯å¢ƒè·³è¿‡ä¸€äº›æ’ä»¶
    isDevelopment || require('autoprefixer'),
    isProduction && require('cssnano')
  ].filter(Boolean)
}
```

### 6.3 å¸¸è§é—®é¢˜

**é—®é¢˜1ï¼šæ’ä»¶é¡ºåºå¾ˆé‡è¦**

```javascript
// âŒ é”™è¯¯é¡ºåº
module.exports = {
  plugins: [
    require('autoprefixer'),      // å…ˆè‡ªåŠ¨å‰ç¼€
    require('postcss-nested'),    // åå¤„ç†åµŒå¥—ï¼ˆåµŒå¥—å±•å¼€åå‰ç¼€ä¸¢å¤±ï¼‰
  ]
}

// âœ… æ­£ç¡®é¡ºåº
module.exports = {
  plugins: [
    require('postcss-nested'),    // å…ˆå¤„ç†åµŒå¥—
    require('autoprefixer'),      // åè‡ªåŠ¨å‰ç¼€
  ]
}
```

**é—®é¢˜2ï¼šSource Mapé…ç½®**

```javascript
// vite.config.js
export default {
  css: {
    devSourcemap: true,  // å¼€å‘ç¯å¢ƒå¯ç”¨
    postcss: {
      map: {
        inline: false,
        annotation: true
      }
    }
  }
}
```

**é—®é¢˜3ï¼šä¸é¢„å¤„ç†å™¨å†²çª**

```javascript
// åŒæ—¶ä½¿ç”¨Sasså’ŒPostCSS
export default {
  css: {
    preprocessorOptions: {
      scss: {
        // Sassé…ç½®
      }
    },
    postcss: {
      // PostCSSé…ç½®
      // PostCSSä¼šåœ¨Sassç¼–è¯‘åæ‰§è¡Œ
    }
  }
}
```

## ä¸ƒã€æ€»ç»“

### 7.1 PostCSSæ ¸å¿ƒè¦ç‚¹

**ä¸»è¦ä¼˜åŠ¿**ï¼š
- âš¡ **é«˜æ€§èƒ½**ï¼šæ¯”ä¼ ç»Ÿé¢„å¤„ç†å™¨å¿«å¾—å¤š
- ğŸ”Œ **æ¨¡å—åŒ–**ï¼šåªä½¿ç”¨éœ€è¦çš„æ’ä»¶
- ğŸ¯ **ç²¾ç¡®æ§åˆ¶**ï¼šç»†ç²’åº¦çš„åŠŸèƒ½æ§åˆ¶
- ğŸš€ **æœªæ¥CSS**ï¼šä½¿ç”¨æœ€æ–°CSSç‰¹æ€§
- ğŸ”§ **å¯å®šåˆ¶**ï¼šå¯ä»¥å¼€å‘è‡ªå®šä¹‰æ’ä»¶

**æ ¸å¿ƒæ’ä»¶**ï¼š
- `autoprefixer` - è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€
- `postcss-preset-env` - ä½¿ç”¨æœªæ¥CSSç‰¹æ€§
- `cssnano` - CSSå‹ç¼©ä¼˜åŒ–
- `postcss-nested` - åµŒå¥—è¯­æ³•æ”¯æŒ

**ä½¿ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦è‡ªåŠ¨åŒ–å¤„ç†CSS
- âœ… è¿½æ±‚æ€§èƒ½å’Œçµæ´»æ€§
- âœ… ä½¿ç”¨ç°ä»£CSSç‰¹æ€§
- âœ… éœ€è¦è‡ªå®šä¹‰è½¬æ¢é€»è¾‘

### 7.2 æœ€ä½³å®è·µæ€»ç»“

**é…ç½®å»ºè®®**ï¼š
1. åˆç†é€‰æ‹©æ’ä»¶ï¼Œé¿å…å†—ä½™
2. æ³¨æ„æ’ä»¶æ‰§è¡Œé¡ºåº
3. åŒºåˆ†å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒ
4. å¯ç”¨Source Mapsä¾¿äºè°ƒè¯•
5. è®¾ç½®åˆç†çš„Browserslist

**æ€§èƒ½ä¼˜åŒ–**ï¼š
1. åªåœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨å‹ç¼©
2. åˆ©ç”¨ç¼“å­˜æœºåˆ¶
3. æŒ‰éœ€åŠ è½½æ’ä»¶
4. é¿å…è¿‡åº¦ä½¿ç”¨æ’ä»¶

**å›¢é˜Ÿåä½œ**ï¼š
1. ç»Ÿä¸€é…ç½®æ–‡ä»¶
2. æ–‡æ¡£åŒ–è‡ªå®šä¹‰æ’ä»¶
3. åˆ¶å®šç¼–ç è§„èŒƒ
4. å®šæœŸæ›´æ–°ä¾èµ–

PostCSSæ˜¯ç°ä»£CSSå·¥ç¨‹åŒ–çš„é‡è¦å·¥å…·ï¼Œé€šè¿‡åˆç†ä½¿ç”¨å¯ä»¥å¤§å¤§æå‡å¼€å‘æ•ˆç‡å’Œä»£ç è´¨é‡ã€‚æŒæ¡PostCSSï¼Œè®©ä½ çš„CSSå¼€å‘æ›´åŠ è‡ªåŠ¨åŒ–ã€æ ‡å‡†åŒ–å’Œé«˜æ•ˆã€‚

**ç¥ä½ å˜å¾—æ›´å¼º!**
